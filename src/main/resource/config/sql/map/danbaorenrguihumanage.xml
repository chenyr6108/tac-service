<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="danbaorenManage">
	<!--  fenye zs-->
	<select id="findAllDanbaoren_count" parameterClass="map" resultClass="java.lang.Integer">
		<![CDATA[ select count(1) from  (select * from (select 
		DISTINCT 1 DIFFREENT,t8.ORGANIZATION_CODE_CERTIFICATE IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CORP_NAME_CN NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,T111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_VOUCHCUSTOMERCORP t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=1 AND tpv.VOUCH_NAME=t8.CORP_NAME_CN AND tpv.VOUCH_CODE=t8.ORGANIZATION_CODE_CERTIFICATE AND tpv.STATUS=0
	left join (select t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE, COUNT(t2.RECT_ID) counti
				from T_PRJT_VOUCHCUSTOMERCORP t1
				left join T_PRJT_CREDIT t23 on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2 on t2.PRCD_ID=t23.ID
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0
				group by t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE
				) t9 
	on t9.CORP_NAME_CN=t8.CORP_NAME_CN and t9.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_VOUCHCUSTOMERCORP t21
						left join T_PRJT_CREDIT t23 on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						GROUP  BY t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE
	) t111 on t111.CORP_NAME_CN=t8.CORP_NAME_CN and t111.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select  t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CORP_NAME_CN,t31.ORGANIZATION_CODE_CERTIFICATE,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_VOUCHCUSTOMERCORP t31
					left join T_PRJT_CREDIT t23
					on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32
					on t32.PRCD_ID=t23.ID
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE 
								  from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
						) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
		group by t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE) t10 
on t10.CORP_NAME_CN=t8.CORP_NAME_CN AND t8.ORGANIZATION_CODE_CERTIFICATE=t10.ORGANIZATION_CODE_CERTIFICATE
where t8.STATUS=0
union
  select 
	DISTINCT 2 DIFFREENT,t8.NATU_IDCARD IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CUST_NAME NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,t111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_CREDITVOUCHNATU t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=0 AND tpv.VOUCH_NAME=t8.CUST_NAME AND tpv.VOUCH_CODE=t8.NATU_IDCARD AND tpv.STATUS=0
	left join (select t1.CUST_NAME,t1.NATU_IDCARD,COUNT(t2.RECT_ID) counti
				from T_PRJT_CREDITVOUCHNATU t1
				left join T_PRJT_CREDIT t23
				on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2
				on t2.PRCD_ID=t23.ID
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0
				group by t1.CUST_NAME,t1.NATU_IDCARD
				) t9 
	on t9.CUST_NAME=t8.CUST_NAME and t9.NATU_IDCARD=t8.NATU_IDCARD
	left join (select t211.CUST_NAME,t211.NATU_IDCARD,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(t211.SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,sum(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_CREDITVOUCHNATU t21
						left join T_PRJT_CREDIT t23
						on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						GROUP BY t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CUST_NAME,t211.NATU_IDCARD
	) t111 on t111.CUST_NAME=t8.CUST_NAME AND t111.NATU_IDCARD=t8.NATU_IDCARD
	left join (select  t33.CUST_NAME,t33.NATU_IDCARD,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CUST_NAME,t31.NATU_IDCARD,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_CREDITVOUCHNATU t31  
					left join T_PRJT_CREDIT t23 on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32 on t32.PRCD_ID=t23.ID
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
																				
					) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
		group by t33.CUST_NAME,t33.NATU_IDCARD) t10 
on t10.CUST_NAME=t8.CUST_NAME AND t10.NATU_IDCARD=t8.NATU_IDCARD
where t8.STATUS=0) tbig where COUNTS is not null)tbig where COUNTS is not null]]> 		
			<isNotEmpty prepend="and" property="orgcode">
				<![CDATA[ (IDENTYCODE like '%$orgcode$%' or NAME like '%$orgcode$%')]]>
			</isNotEmpty>
	</select>
	
		<!--  zongjieshu zs-->
		<!-- Modify by Michael 2012 02/07 去除结清案件 -->
	<select id="findAllDanbaoren" parameterClass="map" resultClass="java.util.HashMap">
	<!--
		<![CDATA[ select * from (select 
		DISTINCT 1 DIFFREENT,t8.ORGANIZATION_CODE_CERTIFICATE IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CORP_NAME_CN NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,T111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_VOUCHCUSTOMERCORP t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=1 AND tpv.VOUCH_NAME=t8.CORP_NAME_CN AND tpv.VOUCH_CODE=t8.ORGANIZATION_CODE_CERTIFICATE AND tpv.STATUS=0
	left join (select t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE, COUNT(t2.RECT_ID) counti
				from T_PRJT_VOUCHCUSTOMERCORP t1
				left join T_PRJT_CREDIT t23 on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2 on t2.PRCD_ID=t23.ID
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0
				group by t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE
				) t9 
	on t9.CORP_NAME_CN=t8.CORP_NAME_CN and t9.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_VOUCHCUSTOMERCORP t21
						left join T_PRJT_CREDIT t23 on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						GROUP  BY t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE
	) t111 on t111.CORP_NAME_CN=t8.CORP_NAME_CN and t111.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select  t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CORP_NAME_CN,t31.ORGANIZATION_CODE_CERTIFICATE,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_VOUCHCUSTOMERCORP t31
					left join T_PRJT_CREDIT t23
					on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32
					on t32.PRCD_ID=t23.ID
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE 
								  from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
						) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
		group by t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE) t10 
on t10.CORP_NAME_CN=t8.CORP_NAME_CN AND t8.ORGANIZATION_CODE_CERTIFICATE=t10.ORGANIZATION_CODE_CERTIFICATE
where t8.STATUS=0
union
  select 
	DISTINCT 2 DIFFREENT,t8.NATU_IDCARD IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CUST_NAME NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,t111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_CREDITVOUCHNATU t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=0 AND tpv.VOUCH_NAME=t8.CUST_NAME AND tpv.VOUCH_CODE=t8.NATU_IDCARD AND tpv.STATUS=0
	left join (select t1.CUST_NAME,t1.NATU_IDCARD,COUNT(t2.RECT_ID) counti
				from T_PRJT_CREDITVOUCHNATU t1
				left join T_PRJT_CREDIT t23
				on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2
				on t2.PRCD_ID=t23.ID
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0
				group by t1.CUST_NAME,t1.NATU_IDCARD
				) t9 
	on t9.CUST_NAME=t8.CUST_NAME and t9.NATU_IDCARD=t8.NATU_IDCARD
	left join (select t211.CUST_NAME,t211.NATU_IDCARD,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(t211.SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,sum(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_CREDITVOUCHNATU t21
						left join T_PRJT_CREDIT t23
						on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						GROUP BY t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CUST_NAME,t211.NATU_IDCARD
	) t111 on t111.CUST_NAME=t8.CUST_NAME AND t111.NATU_IDCARD=t8.NATU_IDCARD
	left join (select  t33.CUST_NAME,t33.NATU_IDCARD,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CUST_NAME,t31.NATU_IDCARD,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_CREDITVOUCHNATU t31  
					left join T_PRJT_CREDIT t23 on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32 on t32.PRCD_ID=t23.ID
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
																				
					) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
		group by t33.CUST_NAME,t33.NATU_IDCARD) t10 
on t10.CUST_NAME=t8.CUST_NAME AND t10.NATU_IDCARD=t8.NATU_IDCARD
where t8.STATUS=0) tbig where COUNTS is not null]]>		
			<isNotEmpty prepend="and" property="orgcode" >
				<![CDATA[ (IDENTYCODE like '%$orgcode$%' or NAME like '%$orgcode$%')]]>
			</isNotEmpty>	
	-->	
	<![CDATA[
select * from (select 
		DISTINCT 1 DIFFREENT,t8.ORGANIZATION_CODE_CERTIFICATE IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CORP_NAME_CN NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,T111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_VOUCHCUSTOMERCORP t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=1 AND tpv.VOUCH_NAME=t8.CORP_NAME_CN AND tpv.VOUCH_CODE=t8.ORGANIZATION_CODE_CERTIFICATE AND tpv.STATUS=0
	left join (select t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE, COUNT(t2.RECT_ID) counti
				from T_PRJT_VOUCHCUSTOMERCORP t1
				left join T_PRJT_CREDIT t23 on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2 on t2.PRCD_ID=t23.ID
				LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t2.RECT_ID and T3.STATUS=0
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0 and (t3.RECP_STATUS<>1 and t3.RECP_STATUS<>3)
				group by t1.CORP_NAME_CN,t1.ORGANIZATION_CODE_CERTIFICATE
				) t9 
	on t9.CORP_NAME_CN=t8.CORP_NAME_CN and t9.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_VOUCHCUSTOMERCORP t21
						left join T_PRJT_CREDIT t23 on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						and (T3.RECP_STATUS<>1 and T3.RECP_STATUS<>3)
						GROUP  BY t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CORP_NAME_CN,t211.ORGANIZATION_CODE_CERTIFICATE
	) t111 on t111.CORP_NAME_CN=t8.CORP_NAME_CN and t111.ORGANIZATION_CODE_CERTIFICATE=t8.ORGANIZATION_CODE_CERTIFICATE
	left join (select  t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CORP_NAME_CN,t31.ORGANIZATION_CODE_CERTIFICATE,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_VOUCHCUSTOMERCORP t31
					left join T_PRJT_CREDIT t23
					on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32
					on t32.PRCD_ID=t23.ID
					LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t32.RECT_ID and T3.STATUS=0
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0 and (T3.RECP_STATUS<>1 and T3.RECP_STATUS<>3)
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE 
								  from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 
								and (t2.RECP_STATUS<>1 and t2.RECP_STATUS<>3)
								and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
						) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
		group by t33.CORP_NAME_CN,t33.ORGANIZATION_CODE_CERTIFICATE) t10 
on t10.CORP_NAME_CN=t8.CORP_NAME_CN AND t8.ORGANIZATION_CODE_CERTIFICATE=t10.ORGANIZATION_CODE_CERTIFICATE
where t8.STATUS=0
union
  select 
	DISTINCT 2 DIFFREENT,t8.NATU_IDCARD IDENTYCODE,tpv.GRANT_PRICE GRANT_PRICE,tpv.LAST_PRICE LAST_PRICE,t8.CUST_NAME NAME,t9.counti COUNTS,t111.SUMLEASE_TOPRIC SUMLEASE_TOPRIC,t111.SUMMONTH_PRICE SUMMONTH_PRICE,t10.SHENGYUZUJIN,t10.SHIJISHENGYUZUJIN,t10.SUMLASTPRICE
	from T_PRJT_CREDITVOUCHNATU t8
	left join T_PRODUCT_VOUCHPLAN tpv on tpv.VOUCH_TYPE=0 AND tpv.VOUCH_NAME=t8.CUST_NAME AND tpv.VOUCH_CODE=t8.NATU_IDCARD AND tpv.STATUS=0
	left join (select t1.CUST_NAME,t1.NATU_IDCARD,COUNT(t2.RECT_ID) counti
				from T_PRJT_CREDITVOUCHNATU t1
				left join T_PRJT_CREDIT t23
				on t23.ID=t1.PRCD_ID
				left join T_RENT_CONTRACT t2
				on t2.PRCD_ID=t23.ID
				LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t2.RECT_ID and T3.STATUS=0
				where t2.STATUS=0 and t1.STATUS=0 and t23.STATUS=0 and (T3.RECP_STATUS<>1 and T3.RECP_STATUS<>3)
				group by t1.CUST_NAME,t1.NATU_IDCARD
				) t9 
	on t9.CUST_NAME=t8.CUST_NAME and t9.NATU_IDCARD=t8.NATU_IDCARD
	left join (select t211.CUST_NAME,t211.NATU_IDCARD,COUNT(t211.RECT_ID) CONTRACTCOUNT,SUM(t211.LEASE_TOPRIC) SUMLEASE_TOPRIC,SUM(t211.SMONTH_PRICE) SUMMONTH_PRICE
				from  (
						select t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC,sum(T4.MONTH_PRICE) SMONTH_PRICE
						from T_PRJT_CREDITVOUCHNATU t21
						left join T_PRJT_CREDIT t23
						on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t22.RECT_ID and T3.STATUS=0
						LEFT JOIN T_RENT_COLLECTIONDETAIL T4  ON T4.RECP_ID=T3.RECP_ID and t4.STATUS=0
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0
						and (T3.RECP_STATUS<>1 and T3.RECP_STATUS<>3)
						GROUP BY t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t22.LEASE_TOPRIC
						) t211
				group by t211.CUST_NAME,t211.NATU_IDCARD
	) t111 on t111.CUST_NAME=t8.CUST_NAME AND t111.NATU_IDCARD=t8.NATU_IDCARD
	left join (select  t33.CUST_NAME,t33.NATU_IDCARD,SUM(t6.LASTPRICE) SUMLASTPRICE, SUM(t6.SHENGYUZUJIN) SHENGYUZUJIN,SUM(t6.SHIJISHENGYUZUJIN) SHIJISHENGYUZUJIN
				from 
					(
					select t31.CUST_NAME,t31.NATU_IDCARD,t32.RECT_ID,t32.LEASE_TOPRIC
					from T_PRJT_CREDITVOUCHNATU t31  
					left join T_PRJT_CREDIT t23 on t23.ID=t31.PRCD_ID
					left join T_RENT_CONTRACT t32 on t32.PRCD_ID=t23.ID
					LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=t32.RECT_ID and T3.STATUS=0
					where t31.STATUS=0 and t32.STATUS=0 and t23.STATUS=0 and (T3.RECP_STATUS<>1 and T3.RECP_STATUS<>3)
					) t33 				 
				left join (select t11.RECT_ID, MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN from
							(select distinct t3.RECP_ID,t3.RECT_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from
								(select t2.RECT_ID,t2.STATUS, t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE from T_RENT_COLLECTIONDETAIL t1
								left join T_RENT_COLLECTIONPLAN t2
								on t2.RECP_ID=t1.RECP_ID
								where t1.STATUS=0 and  t2.STATUS=0 
								and (t2.RECP_STATUS<>1 and t2.RECP_STATUS<>3)
								and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
								) t3
							where  t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = T3.RECP_ID
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = T3.RECP_ID)
																				
					) t11 
						group by t11.RECT_ID) t6 
				on t6.RECT_ID=t33.RECT_ID 
				group by t33.CUST_NAME,t33.NATU_IDCARD) t10 
		on t10.CUST_NAME=t8.CUST_NAME AND t10.NATU_IDCARD=t8.NATU_IDCARD
		where t8.STATUS=0) tbig where COUNTS is not null	
	]]>	
	<isNotEmpty prepend="and" property="orgcode" >
		<![CDATA[ (IDENTYCODE like '%$orgcode$%' or NAME like '%$orgcode$%')]]>
	</isNotEmpty>	
	</select>
	
	<!--  根据法人单个担保人找到所有合同的id,承租人,合同号,合同总额 zs-->
	<select id="findContractInfoByDanbaorenId" parameterClass="map" resultClass="java.util.HashMap">
		<!-- 
		<![CDATA[					
			select  t33.code,t33.CORP_NAME_CN,t33.RECT_ID,t33.RECP_ID,t33.LEASE_TOPRIC,t33.LEASE_CODE,t33.CUST_NAME,trc.TR_IRR_RATE,trc.FIRST_PAYDATE,SUMMONTH_PRICE
				from (select t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE code,t23.ID,t22.RECT_ID,t4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SUMMONTH_PRICE
						from T_PRJT_VOUCHCUSTOMERCORP t21
						left join T_PRJT_CREDIT t23 on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=T22.RECT_ID
 						LEFT JOIN T_RENT_COLLECTIONDETAIL T4 ON T4.RECP_ID=T3.RECP_ID
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0	
						GROUP BY 	t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC			
				) t33 
				left join T_RENT_COLLECTIONPLAN trc
					on trc.RECT_ID=t33.RECT_ID
				and trc.STATUS=0 and trc.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where trc.recp_code=recp_code)
				WHERE t33.code=#code# and t33.CORP_NAME_CN=#name# and t33.RECT_ID is not null
				group by t33.code,t33.CORP_NAME_CN,t33.RECT_ID,t33.RECP_ID,t33.LEASE_CODE,t33.CUST_NAME,t33.LEASE_TOPRIC,trc.TR_IRR_RATE,trc.FIRST_PAYDATE,SUMMONTH_PRICE	
			]]>	
			-->	
		<![CDATA[					
			select  t33.code,t33.CORP_NAME_CN,t33.RECT_ID,t33.RECP_ID,t33.LEASE_TOPRIC,t33.LEASE_CODE,t33.CUST_NAME,trc.TR_IRR_RATE,trc.FIRST_PAYDATE,SUMMONTH_PRICE
				from (select t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE code,t23.ID,t22.RECT_ID,t4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SUMMONTH_PRICE
						from T_PRJT_VOUCHCUSTOMERCORP t21
						left join T_PRJT_CREDIT t23 on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=T22.RECT_ID
 						LEFT JOIN T_RENT_COLLECTIONDETAIL T4 ON T4.RECP_ID=T3.RECP_ID
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0	
						and T3.RECP_STATUS=0
						GROUP BY 	t21.CORP_NAME_CN,t21.ORGANIZATION_CODE_CERTIFICATE,t23.ID,t22.RECT_ID,t4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC			
				) t33 
				left join T_RENT_COLLECTIONPLAN trc
					on trc.RECT_ID=t33.RECT_ID
				and trc.STATUS=0 and trc.RECP_STATUS=0
				WHERE t33.code=#code# and t33.CORP_NAME_CN=#name# and t33.RECT_ID is not null
				group by t33.code,t33.CORP_NAME_CN,t33.RECT_ID,t33.RECP_ID,t33.LEASE_CODE,t33.CUST_NAME,t33.LEASE_TOPRIC,trc.TR_IRR_RATE,trc.FIRST_PAYDATE,SUMMONTH_PRICE	
			]]>	
	</select>
	
		<!--  根据自然人单个担保人找到所有合同的id,承租人,合同号,合同总额 zs-->

	<select id="findContractInfoByDanbaorenNatuId" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[select t33.name,t33.NATU_IDCARD,t33.RECT_ID,t33.RECP_ID,t33.LEASE_TOPRIC,t33.LEASE_CODE,t33.CUST_NAME,trc.TR_IRR_RATE,trc.START_DATE,t33.SUMMONTH_PRICE
				from (select t21.CUST_NAME name,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,t4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC,SUM(T4.MONTH_PRICE) SUMMONTH_PRICE
						from T_PRJT_CREDITVOUCHNATU t21
						left join T_PRJT_CREDIT t23
						on t23.ID=t21.PRCD_ID
						left join T_RENT_CONTRACT t22 on t22.PRCD_ID=t23.ID
						LEFT JOIN T_RENT_COLLECTIONPLAN T3 ON T3.RECT_ID=T22.RECT_ID
 						LEFT JOIN T_RENT_COLLECTIONDETAIL T4 ON T4.RECP_ID=T3.RECP_ID
						where t21.STATUS=0 and t22.STATUS=0 and t23.STATUS=0	
						GROUP BY 	t21.CUST_NAME,t21.NATU_IDCARD,t23.ID,t22.RECT_ID,T4.RECP_ID,t22.CUST_NAME,t22.LEASE_CODE, t22.LEASE_TOPRIC		
				) t33 
				left join T_RENT_COLLECTIONPLAN trc
				on trc.RECT_ID=t33.RECT_ID
				and trc.STATUS=0 and trc.RECP_STATUS=0
				WHERE t33.name=#name#  and t33.NATU_IDCARD=#code# and t33.RECT_ID is not null
				group by t33.name,t33.NATU_IDCARD,t33.RECT_ID,t33.RECP_ID,t33.LEASE_CODE,t33.CUST_NAME,t33.LEASE_TOPRIC,trc.TR_IRR_RATE,trc.START_DATE,t33.SUMMONTH_PRICE
					]]>		
	</select>

	<!-- 根据合同的id找到没有付钱的支付表,并统计出总期数,未交期数,剩余租金,实际剩余租金 -->
	<select id="findContractNoPayByContractId" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[																				
		select MAX(t11.LAST_PRICE) LASTPRICE,COUNT(t11.PERIOD_NUM) WEIJIAOQISHU,SUM(t11.MONTH_PRICE) SHENGYUZUJIN,SUM(t11.IRR_MONTH_PRICE) SHIJISHENGYUZUJIN,t22.ZONGQISHU from
					(select t3.RECP_ID, t3.PERIOD_NUM,t3.MONTH_PRICE,t3.IRR_MONTH_PRICE,t3.LAST_PRICE from 
						(select t2.RECP_ID, t1.PERIOD_NUM,t1.MONTH_PRICE,t1.IRR_MONTH_PRICE,t1.LAST_PRICE from T_RENT_COLLECTIONDETAIL t1
						left join T_RENT_COLLECTIONPLAN t2
						on t2.RECP_ID=t1.RECP_ID
						where t2.RECT_ID=#RECT_ID# and t1.STATUS=0 and  t2.STATUS=0 and t2.VERSION_CODE=(select max(version_code) from t_rent_collectionplan where t2.recp_code=recp_code)
						) t3
						where t3.PERIOD_NUM not in (SELECT T.PERIOD_NUM
									    	FROM T_RENT_COLLECTIONDETAIL T
												LEFT JOIN (SELECT RECD_PERIOD,SUM(REAL_PRICE) REAL_PRICEcount,max(RECP_ID) recp_id 
															    FROM T_FINA_COLLECTIONBILL t 
																WHERE
																	t.FICB_TYPE=0 
																	AND t.FICB_ITEM= #C#
																	AND T.FICB_STATE = 5 
																	AND t.STATUS=0
																	AND t.RECP_ID = #RECP_ID#
																GROUP BY  RECD_PERIOD
															) T1 ON T1.recp_id = T.recp_id AND T1.RECD_PERIOD = T.PERIOD_NUM
											WHERE ((T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) <= 0.005
																				AND (T1.REAL_PRICEcount - T.IRR_MONTH_PRICE) >= -0.005)
																				AND T.STATUS = 0 
																				AND T.RECP_ID = #RECP_ID#)
					) t11
					left join 
						(SELECT RECP_ID, LEASE_PERIOD*LEASE_TERM ZONGQISHU FROM T_RENT_COLLECTIONPLAN WHERE RECT_ID=#RECT_ID#) t22
						 on t11.RECP_ID=t22.RECP_ID
					group by t22.ZONGQISHU
		]]>		
	</select>
	
	
	<select id="getSupl" parameterClass="map" resultClass="hashMap">
		select id as SUPLID, [NAME]
		from T_SUPL_SUPPLIER
		where STATUS = 0
		and id = #id#
	</select>
	
	<select id="getAllProjectBySuplId" parameterClass="map" resultClass="hashMap">
		<![CDATA[
		select pc.ID as CREDIT_ID
		, pc.CREDIT_RUNCODE
		, pc.LEASE_CODE
		, cu.CUST_NAME
		, ps.LEASE_TERM
		, ps.TR_IRR_RATE
		, (
		  select top 1 dd.FLAG from T_DATA_DICTIONARY dd
		  where dd.[TYPE] = '供应商保证'
		  and dd.STATUS = 0
		  and dd.CODE = ps.SUPL_TRUE
		) as SUPL_TRUE
		, isnull(si.MONTH_PRICE,pcd.MONTH_PRICE) as MONTH_PRICE
		from T_PRJT_CREDIT pc
		left join T_PRJT_CREDITSCHEME ps on ps.CREDIT_ID = pc.ID
		left join T_CUST_CUSTOMER cu on pc.CUST_ID = cu.CUST_ID
		left join (
		  select pcsi.PRCS_ID
		  , sum((IRR_MONTH_PRICE_END - IRR_MONTH_PRICE_START + 1) * IRR_MONTH_PRICE) as MONTH_PRICE
		  from T_PRJT_CREDITSCHEMEIRR pcsi
		  where pcsi.STATUS = 0
		  and pcsi.PRCI_STATUS = 0
		  group by pcsi.PRCS_ID
		)si on si.PRCS_ID = ps.PRCS_ID
		left join (
		  select max(rc.PRCD_ID) as credit_id
		  , sum(cd.IRR_MONTH_PRICE) as MONTH_PRICE
		  from T_RENT_CONTRACT rc
		  left join T_RENT_COLLECTIONPLAN cp on cp.RECT_ID = rc.RECT_ID
		  left join T_RENT_COLLECTIONDETAIL cd on cd.RECP_ID = cp.RECP_ID
		  where rc.STATUS = 0
		  and cp.STATUS = 0
		  and cd.STATUS = 0
		  group by cp.RECP_ID
		) pcd on pcd.credit_id = pc.ID
		where pc.STATUS = 0
		and exists (
		  select pe.CREDIT_ID 
		  from T_PRJT_CREDITEQUIPMENT pe
		  left join T_SUPL_EQUIPMENT se on pe.SUEQ_ID = se.SUEQ_ID
		  where se.SUPPLIER_ID = #SUPLID#
		  and pe.CREDIT_ID = pc.ID
		) and exists (
		  select 0 from T_PRJT_RISK_CONTROL rc
		  where rc.STATUS = 0 and rc.STATE = 1
		  and rc.CREDIT_ID = pc.ID
		)
		order by ps.SUPL_TRUE
		]]>
	</select>
	
</sqlMap>