<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
	
<sqlMap namespace="invoiceManagement">
	<!-- 可停开发票案件查询 -->
	<select id="stopInvoiceQuery" resultClass="java.util.HashMap">
      SELECT TRCN.RECP_ID,TRCN.RECT_ID,TRCN.RECP_STATUS,TPC.CREDIT_RUNCODE,TRC.LEASE_CODE,TRCN.LEASE_PERIOD,TCC.CUST_NAME,
             TPC.FINANCECONTRACT_DATE PAY_DATE,CONVERT(DATE,TRCN.FIRST_PAYDATE) START_DATE,TUU.[NAME],TDC.DECP_NAME_CN,
             TRCN.TAX_PLAN_CODE,ISNULL((SELECT 'Y' FROM T_INVOICE_STOP_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TINC.STATE=0),'N') IS_STOP,
             ISNULL((SELECT DISTINCT 'Y' FROM T_INVOICE_STOP_CASE TINC WHERE TINC.RECP_ID=TRCN.RECP_ID),'N') HAS_LOG,
             TISC.EFFECT_DATE,
             <!-- (SELECT CONVERT(DATE,EFFECT_DATE) FROM T_INVOICE_STOP_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID) EFFECT_DATE, --> 
             (SELECT TINC.STATE 
                FROM T_INVOICE_STOP_CASE TINC 
               WHERE TINC.STATUS=0 
                 AND TINC.RECP_ID=TRCN.RECP_ID
                 AND TINC.ID=(SELECT MAX(T.ID) FROM T_INVOICE_STOP_CASE T WHERE T.RECP_ID=TINC.RECP_ID AND STATUS=0 GROUP BY T.RECP_ID)) STATE,              
             CASE WHEN CONVERT(DATE,GETDATE())&lt;ISNULL((SELECT CONVERT(DATE,EFFECT_DATE) 
             												FROM T_INVOICE_STOP_CASE TINC 
             											   WHERE TINC.STATUS=0 
             											     AND TINC.RECP_ID=TRCN.RECP_ID
             											     AND TINC.ID=(SELECT MAX(T.ID) FROM T_INVOICE_STOP_CASE T WHERE T.RECP_ID=TINC.RECP_ID AND STATUS=0 GROUP BY T.RECP_ID)),GETDATE()+1)
                  THEN 'N'
                  ELSE 'Y'
                   END IS_REAL_STOP
        FROM T_RENT_COLLECTIONPLAN TRCN
   LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TRCN.RECT_ID=TRC.RECT_ID  
   LEFT JOIN T_PRJT_CREDIT TPC ON TPC.STATUS=0 AND TRC.PRCD_ID=TPC.ID
   LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.STATUS=0 AND TRC.CUST_ID=TCC.CUST_ID
   LEFT JOIN T_USER_USER TUU ON TUU.ID=TRC.SENSOR_ID
   LEFT JOIN T_DEPT_DEPARTMENT TDD ON TDD.STATUS=0 AND TUU.DEPT_ID=TDD.ID
   LEFT JOIN T_DEPT_COMPANY TDC ON TDC.STATUS=0 AND TDD.DECP_ID=TDC.DECP_ID
   LEFT JOIN T_INVOICE_STOP_CASE TISC ON TISC.STATUS=0 AND TISC.RECP_ID=TRCN.RECP_ID AND TISC.ID=(SELECT MAX(T.ID) FROM T_INVOICE_STOP_CASE T WHERE T.RECP_ID=TISC.RECP_ID AND STATUS=0 GROUP BY T.RECP_ID)
       WHERE TRCN.STATUS=0
         AND TRCN.RECP_STATUS=0
         AND EXISTS (SELECT 1 
                       FROM T_RENT_COLLECTIONDETAIL TRCL 
                      WHERE (TRCL.ISOPEN IS NULL OR TRCL.ISOPEN!=1)
                        AND TRCL.RECP_ID=TRCN.RECP_ID
                        AND TRCL.STATUS=0    
                        <!-- ISOPEN栏位历史数据不全,加入这个条件,实际不可能有超过90天的某期发票还未开 -->                    
                        AND DATEDIFF(DAY,CONVERT(DATE,TRCL.PAY_DATE),CONVERT(DATE,GETDATE()))&lt;=90)
                        <!-- 合同最后期不能存在于已开发票表中,如果存在说明此合同最后期已经开过票,也就是整个合同都开完票了,所以此合同不能出现在可停开发票案件中 -->
         AND NOT EXISTS (SELECT 1 FROM T_INVOICE_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TRCN.LEASE_PERIOD=TINC.PERIOD_NUM)
         <isNotEmpty property="content">
         AND (TPC.CREDIT_RUNCODE LIKE '%$content$%' OR TRC.LEASE_CODE LIKE '%$content$%' OR TCC.CUST_NAME LIKE '%$content$%')
         </isNotEmpty>
         <isNotEmpty property="deptId">
         AND TDC.DECP_ID=#deptId#
         </isNotEmpty>
         <isNotEmpty property="fromDate">
         AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)>=CONVERT(DATE,#fromDate#)
         </isNotEmpty>
         <isNotEmpty property="toDate">
         AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)&lt;=CONVERT(DATE,#toDate#)
         </isNotEmpty>
         <isNotEmpty property="hasStop">
         AND EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TINC.STATE=0)
         </isNotEmpty>
         <isNotEmpty property="hasLog">
         AND EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TINC WHERE TINC.RECP_ID=TRCN.RECP_ID)
         </isNotEmpty>
         <isNotEmpty property="companyCode">
         AND TPC.COMPANY_CODE=#companyCode#
         </isNotEmpty>
         <isNotEmpty property="effectDate">
         AND CONVERT(DATE,TISC.EFFECT_DATE)=CONVERT(DATE,#effectDate#)
         </isNotEmpty>
	</select>
	
	<select id="getEffectDateList" resultClass="java.lang.String">
		SELECT DISTINCT EFFECT_DATE FROM T_INVOICE_STOP_CASE WHERE STATUS=0
	</select>
	
	<select id="getPaymentDetail" resultClass="java.util.HashMap">
    SELECT TRCN.PERIOD_NUM,CONVERT(DECIMAL(20,2),(TRCN.MONTH_PRICE-TRCN.IRR_MONTH_PRICE)/1.17) DEPOSIT_A,TRCN.OWN_PRICE,TRCN.REN_PRICE,TRCN.RECP_ID,
           CONVERT(DECIMAL(20,2),TRCN.OWN_PRICE/1.17) OWN_PRICE_1,CONVERT(DECIMAL(20,2),TRCN.REN_PRICE/1.17) REN_PRICE_1,CONVERT(DATE,TRCN.PAY_DATE) PAY_DATE,
           (TRCN.OWN_PRICE-(TRCN.MONTH_PRICE-TRCN.IRR_MONTH_PRICE))/1.17 OWN_PRICE_2,
           <!-- 
		           首先判断先前的ISOPEN字段,判断是否开票,如果是NULL说明没开票,但是ISOPEN为NULL还分几种情况,
		           情况3:历史数据此栏位数据不全所以用大于90天判断,此期支付日超过90天,一定是开过票或者已经停开了
		           情况4:查询新表中是否有开票资料
           -->
           <!-- ISOPEN栏位历史数据不全,加入这个条件,实际不可能有超过90天的某期发票还未开 -->
                         CASE WHEN ISOPEN=1
                              THEN 'Y'
                              WHEN ISOPEN=0
                              THEN 'N'
           					  WHEN DATEDIFF(DAY,CONVERT(DATE,TRCN.PAY_DATE),CONVERT(DATE,GETDATE()))>90 <!-- 情况3  -->
                              THEN 'Y' 
           <!-- 新表中是否有开票记录 -->                   
                              WHEN ISNULL((SELECT 1 <!-- 情况4  -->
                                             FROM T_INVOICE_CASE TINC 
                                            WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TRCN.PERIOD_NUM=TINC.PERIOD_NUM),0)=1
                              THEN 'Y'
                              ELSE 'N' 
                               END IS_OPEN,
           <!-- 判断是否在停开列表中 -->
           ISNULL((SELECT 'Y' 
           			 FROM T_INVOICE_STOP_CASE TISC 
           			WHERE TISC.STATUS=0 
           			  AND TISC.RECP_ID=TRCN.RECP_ID
           			  AND STATE=0),'N') IS_STOP,<!-- STATE=0为暂停开票 -->
           (SELECT TISC.EFFECT_DATE FROM T_INVOICE_STOP_CASE TISC WHERE TISC.STATUS=0 AND TISC.RECP_ID=TRCN.RECP_ID) EFFECT_DATE
      FROM T_RENT_COLLECTIONDETAIL TRCN
     WHERE TRCN.RECP_ID=#recpId#
       AND TRCN.STATUS=0
  ORDER BY TRCN.PERIOD_NUM
	</select>
	
	<update id="cancelStopInvoice">
		UPDATE T_INVOICE_STOP_CASE SET STATUS=-1 WHERE STATUS=0 AND RECP_ID=#RECP_ID#
	</update>
	<insert id="addStopInvoice">
		INSERT INTO T_INVOICE_STOP_CASE
		(RECP_ID,STOP_TIME,STOP_ID,STOP_REMARK,STOP_TYPE,STATE,EFFECT_DATE,STATUS,CREATE_TIME)
		VALUES
		(#RECP_ID#,GETDATE(),#s_employeeId#,#REMARK#,#STOP_TYPE#,0,#EFFECT_DATE#,0,GETDATE())
	</insert>
	<update id="updateStopInvoice">
		UPDATE T_INVOICE_STOP_CASE SET STATE=-1,START_TIME=GETDATE(),START_ID=#s_employeeId#,START_REMARK=#REMARK#,EFFECT_DATE=#EFFECT_DATE#
		 WHERE STATUS=0 
		   AND STATE=0
		   AND RECP_ID=#RECP_ID#
	</update>
	
	<!-- 系统自动复开案件 -->
	<update id="updateStopDun45DaysInvoice">
		UPDATE T_INVOICE_STOP_CASE SET STATE=-1,START_TIME=GETDATE(),START_ID=#s_employeeId#,START_REMARK=#REMARK#,EFFECT_DATE=#EFFECT_DATE#
		 WHERE STATUS=0 
		   AND STATE=0
		   AND ID IN (SELECT TISC.ID FROM T_INVOICE_STOP_CASE TISC
					   WHERE TISC.STATUS=0 
					     AND TISC.STATE=0
					     AND TISC.STOP_TYPE='DUN_45'
					     AND NOT EXISTS (SELECT 1 FROM T_DUN_DAILY TDD
					                      WHERE TDD.STATUS=0
					                        AND TISC.RECP_ID=TDD.RECP_ID
					                        AND CONVERT(DATE,CREATE_DATE)=CONVERT(DATE,GETDATE()-1)
					                        AND TDD.DUN_DAY>=44)<!-- 如果不逾期了系统自动复开发票 -->
					     AND NOT EXISTS (SELECT 1 FROM T_INVOICE_SPECIAL_CASE TIS
					                      WHERE TISC.RECP_ID=TIS.RECP_ID
					                        AND TIS.STATUS=0
					                        AND TIS.TYPE='NOT_OPEN'))<!-- 特殊表中记录不自动复开的案件 -->
	</update>
	
	<!-- 验证停开重复提交 -->
	<select id="checkStopInvoice" resultClass="java.lang.String">
		SELECT 'Y' FROM T_INVOICE_STOP_CASE WHERE RECP_ID=#RECP_ID# AND STATUS=0 AND STATE=0
	</select>
	<!-- 验证复开重复提交 -->
	<select id="checkOpenInvoice" resultClass="java.lang.String">
		SELECT 'Y' FROM T_INVOICE_STOP_CASE WHERE RECP_ID=#RECP_ID# AND STATUS=0 AND STATE=-1
	</select>
	<!-- 验证不自动复开提交 -->
	<select id="checkNotOpenInvoice" resultClass="java.lang.String">
		SELECT 'N' FROM T_INVOICE_STOP_CASE WHERE RECP_ID=#RECP_ID# AND STATUS=0 AND STATE=0 AND STOP_TYPE='DUN_45'
	</select>
	<!-- 验证不自动停开提交 -->
	<select id="checkNotStopInvoice" resultClass="java.lang.String">
		SELECT 'Y' FROM T_INVOICE_STOP_CASE WHERE RECP_ID=#RECP_ID# AND STATUS=0 AND STATE=0
	</select>
	
	<select id="showLog" resultClass="java.util.HashMap">
	    SELECT TISC.ID,TISC.STOP_TIME,TISC.STOP_REMARK,TUU1.NAME STOP_NAME,
	           TISC.START_TIME,TISC.START_REMARK,TUU2.NAME START_NAME
	      FROM T_INVOICE_STOP_CASE TISC
	 LEFT JOIN T_USER_USER TUU1 ON TUU1.ID=TISC.STOP_ID
	 LEFT JOIN T_USER_USER TUU2 ON TUU2.ID=TISC.START_ID
	     WHERE TISC.RECP_ID=#RECP_ID#
	  ORDER BY TISC.ID
	</select>
	
	<select id="showSpecialLog" resultClass="java.util.HashMap">
		SELECT TISC.ID,TISC.CREATE_TIME,TISC.REMARK,TUU1.NAME,TYPE,OPERATE_FROM
	      FROM T_INVOICE_SPECIAL_CASE TISC
	 LEFT JOIN T_USER_USER TUU1 ON TUU1.ID=TISC.CREATE_BY
	     WHERE TISC.RECP_ID=#RECP_ID#
	  ORDER BY TISC.ID
	</select>
	<!-- 插入法务催收记录 -->
	<insert id="insertDunRecord">
		INSERT INTO T_DUN_DUNNINGRECORD
		(CALL_USER_ID,CALL_CONTENT,CALL_DATE,STATUS,CUST_CODE)
		VALUES
		(#s_employeeId#,#REMARK#,GETDATE(),0,(SELECT CUST_CODE 
														  FROM T_RENT_CONTRACT 
														 WHERE RECT_ID=(SELECT RECT_ID 
														                  FROM T_RENT_COLLECTIONPLAN 
														                 WHERE STATUS=0 
														                   AND RECP_ID=#RECP_ID#)
														   AND STATUS=0))
	</insert>
	
	<!-- 获得逾期45天之案件 -->
	<select id="getDun45DaysCase" resultClass="java.lang.String">
       SELECT TDD.RECP_ID
         FROM T_DUN_DAILY TDD
        WHERE CONVERT(DATE,TDD.CREATE_DATE)=CONVERT(DATE,GETDATE()-1)
          AND TDD.DUN_DAY>=44
          AND TDD.STATUS=0
          AND NOT EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TISC
          				   WHERE TISC.RECP_ID=TDD.RECP_ID
          				     AND TISC.STATUS=0
          				     AND TISC.STATE=0)<!-- 如果停开发票表中此合同已经停开,则剔除这些数据 -->
          AND NOT EXISTS (SELECT 1 FROM T_INVOICE_SPECIAL_CASE TIS
					                      WHERE TDD.RECP_ID=TIS.RECP_ID
					                        AND TIS.STATUS=0
					                        AND TIS.TYPE='NOT_STOP')<!-- 特殊表中记录不自动停开的案件 -->
	</select>
	
	<select id="dun45DaysCaseQuery" resultClass="java.util.HashMap">
       SELECT TDD.DUN_DAY,TRCN.RECP_ID,TRCN.RECT_ID,TPC.CREDIT_RUNCODE,TRC.LEASE_CODE,TCC.CUST_NAME,TPC.FINANCECONTRACT_DATE PAY_DATE,
              CONVERT(DATE,TRCN.FIRST_PAYDATE) START_DATE,TUU.[NAME],TDC.DECP_NAME_CN,
              ISNULL((SELECT 'Y'
                        FROM T_INVOICE_STOP_CASE TISC
          				     WHERE TISC.RECP_ID=TRCN.RECP_ID
          				       AND TISC.STATUS=0
          				       AND TISC.STATE=0),'N') IS_STOP,
                     (SELECT TIS.[TYPE]
                        FROM T_INVOICE_SPECIAL_CASE TIS
		               WHERE TIS.RECP_ID=TRCN.RECP_ID
		                 AND TIS.STATUS=0) [TYPE],
			  ISNULL((SELECT 'Y'
                        FROM T_INVOICE_STOP_CASE TISC
          				     WHERE TISC.RECP_ID=TRCN.RECP_ID
          				       AND TISC.STATUS=0
                         AND TISC.STOP_TYPE='DUN_45'
          				       AND TISC.STATE=0),'N') IS_DUN_45_STOP,
          	  ISNULL((SELECT DISTINCT 'Y'
                        FROM T_INVOICE_SPECIAL_CASE TIS
		               WHERE TIS.RECP_ID=TRCN.RECP_ID),'N') HAS_LOG
         FROM T_RENT_COLLECTIONPLAN TRCN
    LEFT JOIN T_DUN_DAILY TDD ON TDD.STATUS=0 AND TDD.RECP_ID=TRCN.RECP_ID AND CONVERT(DATE,TDD.CREATE_DATE)=CONVERT(DATE,GETDATE())
    LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TRCN.RECT_ID=TRC.RECT_ID
    LEFT JOIN T_PRJT_CREDIT TPC ON TPC.STATUS=0 AND TRC.PRCD_ID=TPC.ID
    LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.STATUS=0 AND TRC.CUST_ID=TCC.CUST_ID
    LEFT JOIN T_USER_USER TUU ON TUU.ID=TRC.SENSOR_ID
    LEFT JOIN T_DEPT_DEPARTMENT TDDT ON TDDT.STATUS=0 AND TUU.DEPT_ID=TDDT.ID
    LEFT JOIN T_DEPT_COMPANY TDC ON TDC.STATUS=0 AND TDDT.DECP_ID=TDC.DECP_ID
        WHERE TRCN.STATUS=0
          AND TRCN.RECP_STATUS=0
          AND EXISTS (SELECT 1 
                        FROM T_RENT_COLLECTIONDETAIL TRCL 
                       WHERE (TRCL.ISOPEN IS NULL OR TRCL.ISOPEN!=1)
                         AND TRCL.RECP_ID=TRCN.RECP_ID
                         AND TRCL.STATUS=0    
                        <!-- ISOPEN栏位历史数据不全,加入这个条件,实际不可能有超过90天的某期发票还未开 -->                    
                         AND DATEDIFF(DAY,CONVERT(DATE,TRCL.PAY_DATE),CONVERT(DATE,GETDATE()))&lt;=90)
                        <!-- 合同最后期不能存在于已开发票表中,如果存在说明此合同最后期已经开过票,也就是整个合同都开完票了,所以此合同不能出现在可停开发票案件中 -->
          AND NOT EXISTS (SELECT 1 FROM T_INVOICE_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TRCN.LEASE_PERIOD=TINC.PERIOD_NUM)
          <isNotEmpty property="content">
       	  AND (TPC.CREDIT_RUNCODE LIKE '%$content$%' OR TRC.LEASE_CODE LIKE '%$content$%' OR TCC.CUST_NAME LIKE '%$content$%')
         </isNotEmpty>
         <isNotEmpty property="deptId">
          AND TDC.DECP_ID=#deptId#
         </isNotEmpty>
         <isNotEmpty property="fromDate">
          AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)>=CONVERT(DATE,#fromDate#)
         </isNotEmpty>
         <isNotEmpty property="toDate">
          AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)&lt;=CONVERT(DATE,#toDate#)
         </isNotEmpty>
         <isNotEmpty property="hasStop">
          AND EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TINC WHERE TINC.STATUS=0 AND TINC.RECP_ID=TRCN.RECP_ID AND TINC.STATE=0)
         </isNotEmpty>
         <isNotEmpty property="hasLog">
          AND EXISTS (SELECT 1 FROM T_INVOICE_SPECIAL_CASE TINC WHERE TINC.RECP_ID=TRCN.RECP_ID)
         </isNotEmpty>
         <isNotEmpty property="companyCode">
          AND TPC.COMPANY_CODE=#companyCode#
         </isNotEmpty>
	</select>
	
	<update id="updateSpecialCase">
		UPDATE T_INVOICE_SPECIAL_CASE SET STATUS=-1,OPERATE_FROM=#OPERATE_FROM#
		 WHERE RECP_ID=#RECP_ID# AND STATUS=0
	</update>
	
	<insert id="insertSpecialCase">
		INSERT INTO T_INVOICE_SPECIAL_CASE
		(RECP_ID,[TYPE],CREATE_BY,CREATE_TIME,REMARK,STATUS)
		VALUES
		(#RECP_ID#,#TYPE#,#s_employeeId#,GETDATE(),#REMARK#,0)
	</insert>
	
	<select id="getEmailContentList" resultClass="java.util.HashMap">
	    SELECT CONVERT(VARCHAR,TISC.STOP_TIME,120) STOP_TIME,TISC.STOP_REMARK,TISC.EFFECT_DATE,TISC.STATE,TISC.RECP_ID,
	           TRC.LEASE_CODE,TCC.CUST_NAME,TUU.ID,TUU.[NAME],TDC.DECP_ID,TDC.DECP_NAME_CN
	      FROM T_INVOICE_STOP_CASE TISC
	 LEFT JOIN T_RENT_COLLECTIONPLAN TRCP ON TRCP.STATUS=0 AND TISC.RECP_ID=TRCP.RECP_ID
	 LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TRCP.RECT_ID=TRC.RECT_ID
	 LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.STATUS=0 AND TRC.CUST_ID=TCC.CUST_ID
	 LEFT JOIN T_USER_USER TUU ON TRC.SENSOR_ID=TUU.ID
	 LEFT JOIN T_DEPT_DEPARTMENT TDD ON TDD.STATUS=0 AND TUU.DEPT_ID=TDD.ID
	 LEFT JOIN T_DEPT_COMPANY TDC ON TDC.STATUS=0 AND TDD.DECP_ID=TDC.DECP_ID
	     WHERE TISC.STATUS=0
	       AND TISC.STOP_TYPE='DUN_45'
	       AND TISC.STATE=0
	       AND CONVERT(DATE,TISC.CREATE_TIME)=CONVERT(DATE,GETDATE())
	</select>
	
	<select id="getInvoiceListForNewCase" resultClass="java.util.HashMap"><!-- 新案开票资料 -->
	<!--期初类型PAY_WAY是11,13-->
    <!--期末类型PAY_WAY是21,23-->
        SELECT TRCN.RECP_ID,TRC.LEASE_CODE,ISNULL(TRCN.PAY_WAY,0) PAY_WAY,TRCN.TAX_PLAN_CODE,TPC.CONTRACT_TYPE,TRCL.PAY_DATE,TRCL.PERIOD_NUM,TPC.CREDIT_RUNCODE,
               TRCL.MONTH_PRICE,TRCL.IRR_MONTH_PRICE,TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE DEPOSIT,ISNULL(TPC.COMPANY_CODE,1) COMPANY_CODE,
               TRCL.OWN_PRICE,TRCL.REN_PRICE,ISNULL(TRCL.VALUE_ADDED_TAX,0) VALUE_ADDED_TAX,
               CONVERT(DECIMAL(20,2),TRCL.REN_PRICE/1.17) REN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.IRR_MONTH_PRICE-TRCL.REN_PRICE)/1.17) OWN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE)/1.17) DEPOSIT_WHITOUT_TAX,
               CASE WHEN CONVERT(DATE,TRCL.PAY_DATE)&lt;=CONVERT(DATE,#lastDateOfMonth#) THEN 'Y'
                    ELSE 'N'
                     END FLAG
          FROM T_PRJT_CREDIT TPC
     LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TPC.ID=TRC.PRCD_ID
     LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.STATUS=0 AND TRC.RECT_ID=TRCN.RECT_ID
     LEFT JOIN T_RENT_COLLECTIONDETAIL TRCL ON TRCL.STATUS=0 AND TRCN.RECP_ID=TRCL.RECP_ID AND TRCL.PERIOD_NUM=1
         WHERE TPC.STATUS=0
           AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#startDate#) AND CONVERT(DATE,#endDate#)
           <!-- AND CONVERT(DATE,TRCL.PAY_DATE)&lt;=CONVERT(DATE,#lastDateOfMonth#) -->
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_CASE TIC WHERE TIC.STATUS=0 AND TIC.RECP_ID=TRCN.RECP_ID AND TIC.PERIOD_NUM=1) <!--已开票的不需要在重复跑出-->
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TISC WHERE TISC.RECP_ID=TRCN.RECP_ID AND TISC.STATUS=0 AND TISC.STATE=0 AND CONVERT(DATE,GETDATE())>=CONVERT(DATE,TISC.EFFECT_DATE)) <!--停开状态的,到了停开暂停日,才起作用-->
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TISC WHERE TISC.RECP_ID=TRCN.RECP_ID AND TISC.STATUS=0 AND TISC.STATE=-1 AND CONVERT(DATE,GETDATE())&lt;CONVERT(DATE,TISC.EFFECT_DATE)) <!--复开状态的,还未到复开作用日,所以还是暂停状态-->
	</select>
	<select id="getInvoiceListForOldCase" resultClass="java.util.HashMap"><!-- 旧案开票资料 -->
		<!-- 非提前结清案件 -->
		SELECT TRCN.RECP_ID,TRC.LEASE_CODE,ISNULL(TRCN.PAY_WAY,0) PAY_WAY,TRCN.TAX_PLAN_CODE,TPC.CONTRACT_TYPE,TRCL.PAY_DATE,TRCL.PERIOD_NUM,TPC.CREDIT_RUNCODE,
               TRCL.MONTH_PRICE,TRCL.IRR_MONTH_PRICE,TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE DEPOSIT,ISNULL(TPC.COMPANY_CODE,1) COMPANY_CODE,
               TRCL.OWN_PRICE,TRCL.REN_PRICE,ISNULL(TRCL.VALUE_ADDED_TAX,0) VALUE_ADDED_TAX,
               CONVERT(DECIMAL(20,2),TRCL.REN_PRICE/1.17) REN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.IRR_MONTH_PRICE-TRCL.REN_PRICE)/1.17) OWN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE)/1.17) DEPOSIT_WHITOUT_TAX
          FROM T_PRJT_CREDIT TPC
     LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TPC.ID=TRC.PRCD_ID
     LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.STATUS=0 AND TRC.RECT_ID=TRCN.RECT_ID
     LEFT JOIN T_RENT_COLLECTIONDETAIL TRCL ON TRCL.STATUS=0 AND TRCN.RECP_ID=TRCL.RECP_ID
         WHERE TPC.STATUS=0
           AND TRCN.RECP_STATUS!=3
           AND TRCN.TAX_PLAN_CODE!=1
           AND TRCN.TAX_PLAN_CODE!=3
           AND CONVERT(DATE,TRCL.PAY_DATE)&lt;=CONVERT(DATE,#lastDateOfMonth#)
           AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)&lt;CONVERT(DATE,#startDate#)
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_CASE TIC WHERE TIC.STATUS=0 AND TIC.RECP_ID=TRCN.RECP_ID AND TIC.PERIOD_NUM=TRCL.PERIOD_NUM AND (TIC.PRICE_TYPE='CAPITAL' OR TIC.PRICE_TYPE='INTEREST')) <!--已开票的不需要在重复跑出-->
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TISC WHERE TISC.RECP_ID=TRCN.RECP_ID AND TISC.STATUS=0 AND TISC.STATE=0 AND CONVERT(DATE,GETDATE())>=CONVERT(DATE,TISC.EFFECT_DATE)) <!--停开状态的,到了停开暂停日,才起作用-->
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_STOP_CASE TISC WHERE TISC.RECP_ID=TRCN.RECP_ID AND TISC.STATUS=0 AND TISC.STATE=-1 AND CONVERT(DATE,GETDATE())&lt;CONVERT(DATE,TISC.EFFECT_DATE)) <!--复开状态的,还未到复开作用日,所以还是暂停状态-->
		<!-- 提前结清案件 -->
		  UNION ALL
		SELECT TRCN.RECP_ID,TRC.LEASE_CODE,ISNULL(TRCN.PAY_WAY,0) PAY_WAY,TRCN.TAX_PLAN_CODE,TPC.CONTRACT_TYPE,TRCL.PAY_DATE,TRCL.PERIOD_NUM,TPC.CREDIT_RUNCODE,
               TRCL.MONTH_PRICE,TRCL.IRR_MONTH_PRICE,TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE DEPOSIT,ISNULL(TPC.COMPANY_CODE,1) COMPANY_CODE,
               TRCL.OWN_PRICE,TRCL.REN_PRICE,ISNULL(TRCL.VALUE_ADDED_TAX,0) VALUE_ADDED_TAX,
               CONVERT(DECIMAL(20,2),TRCL.REN_PRICE/1.17) REN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.IRR_MONTH_PRICE-TRCL.REN_PRICE)/1.17) OWN_PRICE_WHITOUT_TAX,
               CONVERT(DECIMAL(20,2),(TRCL.MONTH_PRICE-TRCL.IRR_MONTH_PRICE)/1.17) DEPOSIT_WHITOUT_TAX
          FROM T_PRJT_CREDIT TPC
     LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TPC.ID=TRC.PRCD_ID
     LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.STATUS=0 AND TRC.RECT_ID=TRCN.RECT_ID
     LEFT JOIN T_RENT_COLLECTIONDETAIL TRCL ON TRCL.STATUS=0 AND TRCN.RECP_ID=TRCL.RECP_ID
         WHERE TPC.STATUS=0
           AND TRCN.RECP_STATUS=3
           AND TRCN.TAX_PLAN_CODE!=1
           AND TRCN.TAX_PLAN_CODE!=3
           AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE)&lt;CONVERT(DATE,#startDate#)
           AND (TRCL.ISOPEN IS NULL OR TRCL.ISOPEN!=1)
           AND NOT EXISTS (SELECT 1 FROM T_INVOICE_CASE TIC WHERE TIC.STATUS=0 AND TIC.RECP_ID=TRCN.RECP_ID AND TIC.PERIOD_NUM=TRCL.PERIOD_NUM AND (TIC.PRICE_TYPE='CAPITAL' OR TIC.PRICE_TYPE='INTEREST')) <!--已开票的不需要在重复跑出-->
	</select>
	
	<insert id="insertInvoiceInfo">
		INSERT INTO T_INVOICE_CASE
		(DOC_NUM,RECP_ID,LEASE_CODE,PAY_DATE,PERIOD_NUM,PRICE_WHITOUT_TAX,PRICE_TYPE,TAX_RATE,INVOICE_TYPE,XML_FILE_NAME,CASE_TYPE,FINANCE_DATE,STATUS,CREATE_TIME)
		VALUES
		(#DOC_NUM#,#RECP_ID#,#LEASE_CODE#,CONVERT(DATE,#PAY_DATE#),#PERIOD_NUM#,#PRICE_WHITOUT_TAX#,#PRICE_TYPE#,#TAX_RATE#,#INVOICE_TYPE#,#XML_FILE_NAME#,#CASE_TYPE#,#FINANCE_DATE#,0,GETDATE())
	</insert>
	
	<!-- 开票信息查询 -->
	<select id="getInvoiceList" resultClass="java.util.HashMap">
	   SELECT TRCL.RECD_ID,TIC.ID,TIC.DOC_NUM,TIC.RECP_ID,TIC.PRICE_TYPE,TIC.LEASE_CODE,TIC.PERIOD_NUM,TIC.PRICE_WHITOUT_TAX,
	          TIC.TAX_RATE,TIC.INVOICE_NUM,TIC.INVOICE_TYPE,TRCN.TAX_PLAN_CODE,TPC.ID CREDIT_ID,TRCL.PAY_DATE,
	          <!-- 
	          TPCP.REGISTERED_OFFICE_ADDRESS+' '+TPCP.TELEPHONE ADDRESS,
	          TPCT.BANK_NAME+' '+TPCT.BANK_ACCOUNT BANK_INFO,TPCP.TAX_REGISTRATION_NUMBER,
	           -->
	          TCC.CUST_NAME,TPC.CREDIT_RUNCODE,
	          TIC.FINANCE_DATE,TIC.CASE_TYPE,DECP.DECP_NAME_CN DEPT_NAME,
	          ISNULL(TRCL.IRR_MONTH_PRICE,0)+ISNULL(TRCL.VALUE_ADDED_TAX,0) SHOULD_PAY,ISNULL(TRCL.REDUCE_OWN_PRICE,0) REDUCE_OWN_PRICE
	     FROM T_RENT_COLLECTIONPLAN TRCN
	LEFT JOIN T_INVOICE_CASE TIC ON TIC.RECP_ID=TRCN.RECP_ID
	LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TRCN.RECT_ID=TRC.RECT_ID
	LEFT JOIN T_CUST_CUSTOMER TCC ON TRC.CUST_ID=TCC.CUST_ID AND TCC.STATUS=0
	<!--INNER JOIN T_PRJT_CREDITCUSTOMERCORP TPCP ON TPCP.STATUS=0 AND TRC.PRCD_ID=TPCP.CREDIT_ID-->
	<!--INNER JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPCT.STATUS=0 AND TPCT.STATE=0 AND TRC.PRCD_ID=TPCT.CREDIT_ID-->
	LEFT JOIN T_PRJT_CREDIT TPC ON TPC.STATUS=0 AND TRC.PRCD_ID=TPC.ID
	LEFT JOIN T_RENT_COLLECTIONDETAIL TRCL ON TRCL.STATUS=0 AND TIC.RECP_ID=TRCL.RECP_ID AND TIC.PERIOD_NUM=TRCL.PERIOD_NUM
	LEFT JOIN T_USER_USER TUU ON TRC.SENSOR_ID=TUU.ID
	LEFT JOIN T_DEPT_DEPARTMENT DEPT ON TUU.DEPT_ID=DEPT.ID AND DEPT.STATUS=0
    LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID=DEPT.DECP_ID AND DECP.STATUS=0
	    WHERE TIC.STATUS=0
	      AND TRCN.STATUS=0
	      AND TIC.FINANCE_DATE=#financeDate#
	      AND TPC.COMPANY_CODE=#companyCode#
	      AND TIC.CASE_TYPE=#caseType#
	      AND TRCN.TAX_PLAN_CODE IN
	    <iterate property="taxPlanCode" conjunction="," open="(" close=")">
	      #taxPlanCode[]#
	    </iterate>
	    <isEqual property="result" compareValue="0"><!-- 开票失败 -->
	      AND TIC.RESULT=0
	    </isEqual>
	    <isEqual property="result" compareValue="1"><!-- 开票成功 -->
	      AND TIC.RESULT=1
	    </isEqual>
	    <isEqual property="result" compareValue="-1"><!-- 未开票 -->
	      AND TIC.RESULT IS NULL
	    </isEqual>
	    <isEqual property="result" compareValue="-2"><!-- 开票失败和未开票 -->
	      AND (TIC.RESULT=0 OR TIC.RESULT IS NULL)
	    </isEqual>
	    <isEqual property="hasPay" compareValue="1"><!-- 已缴完 -->
	      AND ISNULL(TRCL.IRR_MONTH_PRICE,0)+ISNULL(TRCL.VALUE_ADDED_TAX,0)-ISNULL(TRCL.REDUCE_OWN_PRICE,0)=0
	    </isEqual>
	    <isEqual property="hasPay" compareValue="-1"><!-- 未缴完 -->
	      AND ISNULL(TRCL.IRR_MONTH_PRICE,0)+ISNULL(TRCL.VALUE_ADDED_TAX,0)-ISNULL(TRCL.REDUCE_OWN_PRICE,0)!=0
	    </isEqual>
	    <isNotEmpty property="content">
	      AND (TIC.LEASE_CODE LIKE '%$content$%' OR 
	      	   TCC.CUST_NAME LIKE '%$content$%' OR 
	      	   TPC.CREDIT_RUNCODE LIKE '%$content$%' OR
	      	   TIC.INVOICE_NUM LIKE '%$content$%')
	    </isNotEmpty>
	    <isNotEmpty property="orderBy">
	      ORDER BY TIC.RECP_ID,TIC.ID
	    </isNotEmpty>
	</select>
	
	<!-- 获得邮寄地址信息 -->
	<select id="getPostAddress" resultClass="java.util.HashMap">
       SELECT DISTINCT TIC.RECP_ID,TIC.LEASE_CODE,
	          TRCN.TAX_PLAN_CODE,DECP.DECP_ID,DECP.DECP_NAME_CN,
	          TCC.CUST_NAME,TIC.FINANCE_DATE,TIC.CASE_TYPE,
	          ISNULL(TRCL.IRR_MONTH_PRICE,0)+ISNULL(TRCL.VALUE_ADDED_TAX,0) SHOULD_PAY,ISNULL(TRCL.REDUCE_OWN_PRICE,0) REDUCE_OWN_PRICE,
              TCL.LINK_NAME,TCL.LINK_MOBILE,TCL.LINK_WORK_ADDRESS,TCL.LINK_EMAIL,TCL.LINK_PHONE,TSP.EXPRESS_PAY_WAY
	     FROM T_RENT_COLLECTIONPLAN TRCN
	LEFT JOIN T_INVOICE_CASE TIC ON TIC.RECP_ID=TRCN.RECP_ID
	LEFT JOIN T_RENT_CONTRACT TRC ON TRC.STATUS=0 AND TRCN.RECT_ID=TRC.RECT_ID
	LEFT JOIN T_CUST_CUSTOMER TCC ON TRC.CUST_ID=TCC.CUST_ID AND TCC.STATUS=0	
	LEFT JOIN T_PRJT_CREDIT TPC ON TPC.STATUS=0 AND TRC.PRCD_ID=TPC.ID
	LEFT JOIN T_RENT_COLLECTIONDETAIL TRCL ON TRCL.STATUS=0 AND TIC.RECP_ID=TRCL.RECP_ID AND TIC.PERIOD_NUM=TRCL.PERIOD_NUM
    LEFT JOIN T_CUST_LINKMAN TCL ON TCL.CUST_ID=TCC.CUST_ID AND TCL.STATUS =0  AND TCL.LINK_TYPE=0
    LEFT JOIN T_USER_USER TUU ON TPC.SENSOR_ID=TUU.ID
    LEFT JOIN T_DEPT_DEPARTMENT DEPT ON TUU.DEPT_ID=DEPT.ID AND DEPT.STATUS=0
    LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID=DEPT.DECP_ID AND DECP.STATUS=0
    LEFT JOIN T_SUPL_PLAYDETIL TSP ON TSP.STATUS=0 AND TSP.CREDIT_ID=TPC.ID AND TSP.PAY_ORDER=1 AND TSP.BACKSTATE=0 AND TSP.STATE=3
	    WHERE TIC.STATUS=0
	      AND TRCN.STATUS=0
	      AND TIC.FINANCE_DATE=#financeDate#
	      AND TPC.COMPANY_CODE=#companyCode#
	      AND TIC.CASE_TYPE=#caseType#
	      AND TRCN.TAX_PLAN_CODE IN
	    <iterate property="taxPlanCode" conjunction="," open="(" close=")">
	      #taxPlanCode[]#
	    </iterate>
	      AND TIC.CASE_TYPE=#caseType#
	</select>
	<select id="getInvoiceInfo" resultClass="java.util.HashMap"><!-- 获得开票信息 -->
		SELECT TPCP.REGISTERED_OFFICE_ADDRESS+' '+TPCP.TELEPHONE ADDRESS,
	           TPCT.BANK_NAME+' '+TPCT.BANK_ACCOUNT BANK_INFO,TPCP.TAX_REGISTRATION_NUMBER
	      FROM T_PRJT_CREDITCUSTOMERCORP TPCP
	 LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPCT.STATUS=0 AND TPCT.STATE=0 AND TPCP.CREDIT_ID=TPCT.CREDIT_ID
	     WHERE TPCP.STATUS=0
	       AND TPCP.CREDIT_ID=#CREDIT_ID#
	</select>
	<select id="getFinanceDateList" resultClass="java.util.HashMap">
		SELECT DISTINCT FINANCE_DATE,CONVERT(DATE,FINANCE_DATE+'-'+'1') FROM T_INVOICE_CASE 
		 WHERE STATUS=0
		   AND CONVERT(DATE,FINANCE_DATE+'-'+'1')>CONVERT(DATE,'2014-7-1')<!-- 2014-7-1时的数据为试运行数据 -->
	  ORDER BY CONVERT(DATE,FINANCE_DATE+'-'+'1') DESC
	</select>
	
	<insert id="insertLog">
		INSERT INTO T_INVOICE_LOG
		(LOG_TITLE,LOG_CONTENT,EXPORT_FILE_SIZE,CREATE_TIME,CREATE_BY,STATUS)
		VALUES
		(#logTitle#,#logContent#,#fileSize#,GETDATE(),#s_employeeId#,0)
	</insert>
	
	<select id="queryLog" resultClass="java.util.HashMap">
		SELECT T.LOG_TITLE,T.LOG_CONTENT,T.EXPORT_FILE_SIZE,
			   T.CREATE_TIME,TUU.NAME
		  FROM T_INVOICE_LOG T
	 LEFT JOIN T_USER_USER TUU ON T.CREATE_BY=TUU.ID
	     WHERE T.STATUS=0
	     <isNotEmpty property="content">
	       AND (T.LOG_TITLE LIKE '%$content$%' OR T.LOG_CONTENT LIKE '%$content$%' OR TUU.NAME LIKE '%$content$%')
	     </isNotEmpty>
	     <isNotEmpty property="fromDate">
	       AND CONVERT(DATE,T.CREATE_TIME)>=CONVERT(DATE,#fromDate#)
	     </isNotEmpty>
	     <isNotEmpty property="toDate">
	       AND CONVERT(DATE,T.CREATE_TIME)&lt;=CONVERT(DATE,#toDate#)
	     </isNotEmpty>
	</select>
	
	<insert id="insertUploadLog">
		INSERT INTO T_INVOICE_UPLOAD_LOG
		(FILE_NAME,LEASE_CODE,PERIOD_NUM,INVOICE_NUM,PRICE_TYPE,CASE_TYPE,STATUS,CREATE_BY,CREATE_TIME)
		VALUES
		(#fileName#,#leaseCode#,#periodNum#,#invoiceNum#,#priceType#,#caseType#,0,#s_employeeId#,GETDATE())
	</insert>
	
	<update id="uploadInvoiceNum">
		UPDATE T_INVOICE_CASE SET RESULT=#result#,RESULT_DESCR=#resultDescr#,RESULT_MEMO=#resultMemo#,INVOICE_NUM=#invoiceNum#
 		 WHERE LEASE_CODE=#leaseCode# AND PERIOD_NUM=#periodNum# AND PRICE_TYPE=#priceType# AND INVOICE_NUM IS NULL
	</update>
	
	<select id="queryUploadLog" resultClass="java.util.HashMap">
		SELECT T.LEASE_CODE,T.PERIOD_NUM,T.INVOICE_NUM,T.PRICE_TYPE,T.CASE_TYPE,
			   T.CREATE_TIME,TUU.NAME,T.FILE_NAME
		  FROM T_INVOICE_UPLOAD_LOG T
	 LEFT JOIN T_USER_USER TUU ON T.CREATE_BY=TUU.ID
	     WHERE T.STATUS=0
	     <isNotEmpty property="content">
	       AND (T.LEASE_CODE LIKE '%$content$%' OR T.INVOICE_NUM LIKE '%$content$%' OR TUU.NAME LIKE '%$content$%')
	     </isNotEmpty>
	     <isNotEmpty property="fromDate">
	       AND CONVERT(DATE,T.CREATE_TIME)>=CONVERT(DATE,#fromDate#)
	     </isNotEmpty>
	     <isNotEmpty property="toDate">
	       AND CONVERT(DATE,T.CREATE_TIME)&lt;=CONVERT(DATE,#toDate#)
	     </isNotEmpty>
	</select>
	
	<select id="getResult" resultClass="java.util.HashMap">
		SELECT RESULT_DESCR,RESULT_MEMO
		  FROM T_INVOICE_CASE
		 WHERE STATUS=0
		   AND ID=#id#
	</select>
</sqlMap>