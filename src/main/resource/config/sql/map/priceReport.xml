<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="priceReport">
<select id="queryRealPrice_count" parameterClass="map" resultClass="java.lang.Integer">
<!-- Modify by Michael 修改长期应收款税务计算逻辑 -->
		   	<![CDATA[
		   		select * from MONTH_LONGREALPRICE_REPORT
		   	]]>
		   		<dynamic prepend="where">
			 	<isNotEmpty prepend="and" property="startDate">
			 		<![CDATA[
					(YEAR(FINANCE_DATE)=YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					 and 
					 month(FINANCE_DATE)=MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
					 )
					]]>
			 	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="content">
			   		(
			   			CUST_NAME		LIKE '%$content$%'
			   			OR LEASE_CODE		LIKE '%$content$%'
			   			OR DECP_NAME_CN	LIKE '%$content$%'
			   			OR SUPL_NAME LIKE '%$content$%'
			   			OR NAME LIKE '%$content$%'
			   		)
			   	</isNotEmpty>
		   	</dynamic>	                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	<select id="queryRealPrice" parameterClass="map" resultClass="java.util.HashMap">
		   	<![CDATA[
		   		select t.* 
		   		from MONTH_LONGREALPRICE_REPORT  t
		   		left join t_prjt_credit tpc on tpc.lease_code = t.lease_code and tpc.status = 0
		   	]]>
		   		<dynamic prepend="where">

			 	<isNotEmpty prepend="and" property="startDate">
			 		<![CDATA[
					(YEAR(t.FINANCE_DATE)=YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					 and 
					 month(t.FINANCE_DATE)=MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
					 )
					]]>
			 	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="content">
			   		(
			   			t.CUST_NAME		LIKE '%$content$%'
			   			OR t.LEASE_CODE		LIKE '%$content$%'
			   			OR t.DECP_NAME_CN	LIKE '%$content$%'
			   			OR t.SUPL_NAME LIKE '%$content$%'
			   			OR t.NAME LIKE '%$content$%'
			   		)
			   	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="companyCode">
					tpc.company_code = #companyCode#
				</isNotEmpty>
		   	</dynamic>
	</select>		
	
	<select id="queryPledge_count" parameterClass="map" resultClass="java.lang.Integer">
		      select count(1)  from
		      (
		      	select tcc.CUST_NAME,
		       trc.LEASE_CODE,
		       pro.NAME + city.NAME  area,
		       (case when trcd.PERIOD_NUM = 1 then 0
		            else 
						 trcp.PLEDGE_PRICE - (trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM) * (PERIOD_NUM-1)
		            end) qichu,
		       trcp.PLEDGE_PRICE ,
		       trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM  benqijianshao,
		       (trcp.PLEDGE_PRICE - (trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM) * PERIOD_NUM) qimoyue,
		       trcp.PLEDGE_AVE_PRICE,
		       trcp.PLEDGE_BACK_PRICE,
		       trcp.PLEDGE_LAST_PERIOD,
		       trcp.PLEDGE_LAST_PRICE ,
		       trcd.PERIOD_NUM            
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
		left join T_AREA pro on pro.ID = trc.PROVINCE_ID
		left join T_AREA city on city.ID = trc.CITY_ID
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID
		where trcd.STATUS = 0 and trcp.STATUS = 0 
		      and trc.STATUS = 0 and tcc.STATUS = 0	
		      <isNotEmpty prepend="and" property="startDate">
			 		TRCD.PAY_DATE &gt;=CONVERT(date,#startDate#)
			 	</isNotEmpty>
			 	<isNotEmpty prepend="and" property="endDate">
			 		TRCD.PAY_DATE &lt;=CONVERT(date,#endDate#)
			 	</isNotEmpty>
		      <dynamic prepend="and">
		 		<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					(tcc.CUST_NAME like '%$content$%' 
					or trc.LEASE_CODE like '%$content$%' 
					or pro.NAME + city.NAME like '%$content$%')  
					]]>
				</isNotEmpty>
			</dynamic> 
			) t		                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	
	<select id="queryPledge" parameterClass="map" resultClass="java.util.HashMap">
		select tcc.CUST_NAME,
		       trc.LEASE_CODE,
		       pro.NAME + city.NAME  area,
		       (case when trcd.PERIOD_NUM = 1 then 0
		            else 
						 trcp.PLEDGE_PRICE - (trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM) * (PERIOD_NUM-1)
		            end) qichu,
		      	(case when trcd.PERIOD_NUM = 1 then trcp.PLEDGE_PRICE
		            else 
						 0
		            end) PLEDGE_PRICE ,
		       trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM  benqijianshao,
		       (trcp.PLEDGE_PRICE - (trcp.PLEDGE_AVE_PRICE/trcp.LEASE_TERM) * PERIOD_NUM) qimoyue,
		       trcp.PLEDGE_AVE_PRICE,
		       trcp.PLEDGE_BACK_PRICE,
		       trcp.PLEDGE_LAST_PERIOD,
		       trcp.PLEDGE_LAST_PRICE ,
		       trcd.PERIOD_NUM            
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
		left join T_AREA pro on pro.ID = trc.PROVINCE_ID
		left join T_AREA city on city.ID = trc.CITY_ID
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID
		where trcd.STATUS = 0 and trcp.STATUS = 0 
		      and trc.STATUS = 0 and tcc.STATUS = 0	
		      	<isNotEmpty prepend="and" property="startDate">
			 		TRCD.PAY_DATE &gt;=CONVERT(date,#startDate#)
			 	</isNotEmpty>
			 	<isNotEmpty prepend="and" property="endDate">
			 		TRCD.PAY_DATE &lt;=CONVERT(date,#endDate#)
			 	</isNotEmpty>
			<dynamic prepend="and">
		 		<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					(tcc.CUST_NAME like '%$content$%' 
					or trc.LEASE_CODE like '%$content$%' 
					or pro.NAME + city.NAME like '%$content$%')  
					]]>
				</isNotEmpty>
			</dynamic>                                                                          			                                                                                		                                                                                                                                         	
	</select>

<!-- Modify by Michael 2012-03-05 修改保险费明细计算逻辑  -->	
<select id="queryInsurance_count" parameterClass="map" resultClass="java.lang.Integer"> 
 		<![CDATA[	
 select count(*) from (
select CUST_NAME,SUPL_NAME,DECP_NAME_CN,NAME,LEASE_PERIOD,RECP_CODE,insurance,LEASE_TOPRIC,PERIOD_NUM 
,case
when PERIOD_NUM=LEASE_PERIOD then
(select monthinsurance from
(select round(max(insurance)-SUM(monthinsurance),2) monthinsurance,RECP_CODE from(
select 
       SUM(baoxian) monthinsurance,
       T3.CUST_NAME,
       T9.NAME SUPL_NAME,
       T4.DECP_NAME_CN,
       T5.NAME,
       T1.LEASE_PERIOD,
       T2.LEASE_CODE RECP_CODE,
       MAX(insurance) insurance,
       T1.LEASE_TOPRIC,
       PERIOD_NUM
  FROM (select tt.RECP_ID,
               TT.QI_DATE,
               CASE
				WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = tt.RECP_ID
					GROUP BY trst.RECP_ID
					) 
				<= CONVERT(VARCHAR(7),QI_DATE,23)
				THEN 0	
                 WHEN PERIOD_NUM = 1 THEN
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* tian / (360 * (LEASE_PERIOD / 12)) , 2)
                 ELSE
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* 30 / (360* (LEASE_PERIOD / 12)) , 2)
               END baoxian,
               LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD / 12 insurance,
               PERIOD_NUM
          from (SELECT *,
                       DATEDIFF(day,
                                QI_DATE,
                                dateadd(dd,
                                        -day(dateadd(m, 1, QI_DATE)),
                                        dateadd(m, 1, QI_DATE))) + 1 tian,
                       (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
                          FROM T_RATE_CONFIG T
                         WHERE T.STATUS = 0
                           AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                               CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
                           AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                               CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
                           AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
                  FROM (select trcp.recp_id,
                               trcd.PERIOD_NUM,
                               TRCP.LEASE_TOPRIC,
                               LEASE_PERIOD,
                               trcd.REN_PRICE,
                               LEASE_TERM,
                               trcd.finance_date QI_DATE,
							   TPCD.FINANCECONTRACT_DATE,
							   RECP_STATUS
                          from T_RENT_COLLECTIONDETAIL trcd
                          left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                                  trcd.RECP_ID
                                                              AND trcp.STATUS = 0
                          LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                                           trcp.RECT_ID
                                                       AND TRC.STATUS = 0
                          LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                                          TRC.PRCD_ID
                                                      AND TPCD.STATUS = 0
                         WHERE trcd.STATUS = 0
                          and 
                         (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
                         OR
							( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
								AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
                         ) t) tt
        union
 select tt.RECP_ID, 
               TT.QI_DATE,
               CASE
               	WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = tt.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						<= CONVERT(VARCHAR(7),QI_DATE,23)
				THEN 0	
                 WHEN PERIOD_NUM = LEASE_PERIOD THEN
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* (30-tian) / (360* (LEASE_PERIOD / 12)), 2)
                 ELSE
                  0
               END baoxian,
               round(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD * LEASE_TERM / 12,2) insurance,
               PERIOD_NUM
          from (SELECT *,
                       DATEDIFF(day,
                                QI_DATE,
                                dateadd(dd,
                                        -day(dateadd(m, 1, QI_DATE)),
                                        dateadd(m, 1, QI_DATE))) + 1 tian,
                       (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
                          FROM T_RATE_CONFIG T
                         WHERE T.STATUS = 0
                           AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                               CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
                           AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                               CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
                           AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
                  FROM (select TRCP.RECP_ID,
                               trcd.PERIOD_NUM,
                               TRCP.LEASE_TOPRIC,
                               LEASE_PERIOD,
                               trcd.REN_PRICE,
                               LEASE_TERM,
                               trcd.finance_date QI_DATE,
                               FINANCECONTRACT_DATE,
                               RECP_STATUS
                          from T_RENT_COLLECTIONDETAIL trcd
                          left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                                  trcd.RECP_ID
                                                              AND trcp.STATUS = 0
                          LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                                           trcp.RECT_ID
                                                       AND TRC.STATUS = 0
                          LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                                          TRC.PRCD_ID
                                                      AND TPCD.STATUS = 0
                         WHERE trcd.STATUS = 0 
                         and 
                         (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
                         OR
							( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
								AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
                         ) t) tt   
        ) T0
  LEFT JOIN T_RENT_COLLECTIONPLAN T1 ON T0.RECP_ID = T1.RECP_ID
  LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T1.RECT_ID
                              AND T2.STATUS = 0
  LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID
                              AND T3.STATUS = 0
  LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID
                             AND T4.STATUS = 0
  LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID
  LEFT JOIN (SELECT RECP_ID, MAX(EQMT_ID) EQMT_ID
               FROM T_RENT_CONTRACTDETAIL
              WHERE STATUS = 0
              GROUP BY RECP_ID) T6 ON T6.RECP_ID = T1.RECP_ID
  LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID
                               AND T7.STATUS = 0
  LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID
                               AND T8.STATUS = 0
  LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID
                              AND T9.STATUS = 0
GROUP BY year(T0.QI_DATE),MONTH(t0.QI_DATE) ,T3.CUST_NAME,T9.NAME,T4.DECP_NAME_CN,T5.NAME,T1.LEASE_PERIOD,T1.FIRST_PAYDATE,T2.LEASE_CODE,T1.LEASE_TOPRIC,PERIOD_NUM  
)tt
where PERIOD_NUM<=LEASE_PERIOD-1
group by  RECP_CODE
)ttttt where ttttt.RECP_CODE=tt.RECP_CODE)
else
monthinsurance
end monthinsurance
from(
select 
       SUM(baoxian) monthinsurance,
       T3.CUST_NAME,
       T9.NAME SUPL_NAME,
       T4.DECP_NAME_CN,
       T5.NAME,
       T1.LEASE_PERIOD,
       T2.LEASE_CODE RECP_CODE,
       MAX(insurance) insurance,
       T1.LEASE_TOPRIC,
       PERIOD_NUM
  FROM (select tt.RECP_ID,
               TT.QI_DATE,
               CASE
				WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = tt.RECP_ID
					GROUP BY trst.RECP_ID
					) 
				<= CONVERT(VARCHAR(7),QI_DATE,23)
				THEN 0	
                 WHEN PERIOD_NUM = 1 THEN
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* tian / (360 * (LEASE_PERIOD / 12)) , 2)
                 ELSE
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* 30 / (360* (LEASE_PERIOD / 12)) , 2)
               END baoxian,
               LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD / 12 insurance,
               PERIOD_NUM
          from (SELECT *,
                       DATEDIFF(day,
                                QI_DATE,
                                dateadd(dd,
                                        -day(dateadd(m, 1, QI_DATE)),
                                        dateadd(m, 1, QI_DATE))) + 1 tian,
                       (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
                          FROM T_RATE_CONFIG T
                         WHERE T.STATUS = 0
                           AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                               CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
                           AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                               CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
                           AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
                  FROM (select trcp.recp_id,
                               trcd.PERIOD_NUM,
                               TRCP.LEASE_TOPRIC,
                               LEASE_PERIOD,
                               trcd.REN_PRICE,
                               LEASE_TERM,
                               trcd.finance_date QI_DATE,
							   TPCD.FINANCECONTRACT_DATE,
							   RECP_STATUS
                          from T_RENT_COLLECTIONDETAIL trcd
                          left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                                  trcd.RECP_ID
                                                              AND trcp.STATUS = 0
                          LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                                           trcp.RECT_ID
                                                       AND TRC.STATUS = 0
                          LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                                          TRC.PRCD_ID
                                                      AND TPCD.STATUS = 0
                         WHERE trcd.STATUS = 0
                          and 
                         (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
                         OR
							( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
								AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
                         ) t) tt
        union
 select tt.RECP_ID, 
               TT.QI_DATE,
               CASE
               	WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = tt.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						<= CONVERT(VARCHAR(7),QI_DATE,23)
				THEN 0	
                 WHEN PERIOD_NUM = LEASE_PERIOD THEN
                  ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* (30-tian) / (360* (LEASE_PERIOD / 12)), 2)
                 ELSE
                  0
               END baoxian,
               round(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD * LEASE_TERM / 12,2) insurance,
               PERIOD_NUM
          from (SELECT *,
                       DATEDIFF(day,
                                QI_DATE,
                                dateadd(dd,
                                        -day(dateadd(m, 1, QI_DATE)),
                                        dateadd(m, 1, QI_DATE))) + 1 tian,
                       (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
                          FROM T_RATE_CONFIG T
                         WHERE T.STATUS = 0
                           AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                               CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
                           AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                               CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
                           AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
                  FROM (select TRCP.RECP_ID,
                               trcd.PERIOD_NUM,
                               TRCP.LEASE_TOPRIC,
                               LEASE_PERIOD,
                               trcd.REN_PRICE,
                               LEASE_TERM,
                               trcd.finance_date QI_DATE,
                               FINANCECONTRACT_DATE,
                               RECP_STATUS
                          from T_RENT_COLLECTIONDETAIL trcd
                          left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                                  trcd.RECP_ID
                                                              AND trcp.STATUS = 0
                          LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                                           trcp.RECT_ID
                                                       AND TRC.STATUS = 0
                          LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                                          TRC.PRCD_ID
                                                      AND TPCD.STATUS = 0
                         WHERE trcd.STATUS = 0 
                         and 
                         (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
                         OR
							( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
								AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
                         ) t) tt   
        ) T0
  LEFT JOIN T_RENT_COLLECTIONPLAN T1 ON T0.RECP_ID = T1.RECP_ID
  LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T1.RECT_ID
                              AND T2.STATUS = 0
  LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID
                              AND T3.STATUS = 0
  LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID
                             AND T4.STATUS = 0
  LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID
  LEFT JOIN (SELECT RECP_ID, MAX(EQMT_ID) EQMT_ID
               FROM T_RENT_CONTRACTDETAIL
              WHERE STATUS = 0
              GROUP BY RECP_ID) T6 ON T6.RECP_ID = T1.RECP_ID
  LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID
                               AND T7.STATUS = 0
  LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID
                               AND T8.STATUS = 0
  LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID
                              AND T9.STATUS = 0
WHERE year(T0.QI_DATE)=year(#startDate#) and MONTH(t0.QI_DATE)=month(#startDate#) and baoxian>0
and t2.RECT_TYPE<>3 and t2.RECT_TYPE<>4
GROUP BY year(T0.QI_DATE),MONTH(t0.QI_DATE) ,T3.CUST_NAME,T9.NAME,T4.DECP_NAME_CN,T5.NAME,T1.LEASE_PERIOD,T1.FIRST_PAYDATE,T2.LEASE_CODE,T1.LEASE_TOPRIC,PERIOD_NUM  
)tt
)ttt
		]]>	                                                                          			                                                                                		                                                                                                                                         	
	</select>
	
<!-- Modify by Michael 2012-03-05 修改保险费明细计算逻辑  -->	
	<select id="queryInsurance" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[	
select * from (
select tall.RECP_ID,tall.LEASE_PERIOD,convert(varchar,tall.FIRST_PAYDATE,23) FIRST_PAYDATE ,FINANCECONTRACT_DATE,insurance,Y,M,monthinsurance,
T3.CUST_NAME,
T9.NAME SUPL_NAME,
T4.DECP_NAME_CN,
T5.NAME,
T2.LEASE_CODE RECP_CODE,
T1.LEASE_TOPRIC
from
(
select RECP_ID,LEASE_PERIOD,FIRST_PAYDATE ,FINANCECONTRACT_DATE,insurance,Y,M,
case 
when CONVERT(VARCHAR(7),DATEADD(M,LEASE_PERIOD,FIRST_PAYDATE),23)=CONVERT(VARCHAR(7),convert(date,convert(varchar,Y)+'-'+convert(varchar,M)+'-01'),23)
then
convert(decimal(18,2),insurance-
(select sum(monthinsurance) totalinsurance from
(select 
SUM(baoxian) monthinsurance,
RECP_ID,
MAX(insurance) insurance,
YEAR(DATEADD(mm, MONTH, 0)) Y,MONTH(DATEADD(mm, MONTH, 0)) M,
LEASE_PERIOD,FIRST_PAYDATE ,FINANCECONTRACT_DATE
FROM (
select tt.RECP_ID,
TT.QI_DATE,DATEDIFF(mm, 0, QI_DATE) MONTH,
CASE
WHEN RECP_STATUS = 3  AND 
(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
FROM T_RENT_SETTLE trst
WHERE STATUS=0 
AND RECP_ID = tt.RECP_ID
GROUP BY trst.RECP_ID
) 
<= CONVERT(VARCHAR(7),finance_date,23)
THEN 0	
WHEN PERIOD_NUM = 1 THEN
ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* tian / (360 * (LEASE_PERIOD / 12)) , 2)
ELSE
ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* 30 / (360* (LEASE_PERIOD / 12)) , 2)
END baoxian,
ROUND(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD / 12,2) insurance,
PERIOD_NUM,LEASE_PERIOD,FIRST_PAYDATE,FINANCECONTRACT_DATE
from (SELECT *,
DATEDIFF(day,
      finance_date,
      dateadd(dd,
              -day(dateadd(m, 1, finance_date)),
              dateadd(m, 1, finance_date))) + 1 tian,
(SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
FROM T_RATE_CONFIG T
WHERE T.STATUS = 0
 AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
     CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
 AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
     CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
 AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
FROM (select trcp.recp_id,
     trcd.PERIOD_NUM,
     TRCP.LEASE_TOPRIC,
     LEASE_PERIOD,
     trcd.REN_PRICE,
     LEASE_TERM,
    case
     when CONVERT(VARCHAR(7),trcd.finance_date,23)<=CONVERT(VARCHAR(7),FINANCECONTRACT_DATE,23) then
      FINANCECONTRACT_DATE
     else
      trcd.finance_date
     end
      QI_DATE,
     trcd.finance_date finance_date,
TPCD.FINANCECONTRACT_DATE,FIRST_PAYDATE,
RECP_STATUS
from T_RENT_COLLECTIONDETAIL trcd
left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                        trcd.RECP_ID
                                    AND trcp.STATUS = 0
LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                 trcp.RECT_ID
                             AND TRC.STATUS = 0
LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                TRC.PRCD_ID
                            AND TPCD.STATUS = 0
WHERE trcd.STATUS = 0
and 
(year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
OR
( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
) t) tt
union
select tt.RECP_ID, 
TT.QI_DATE,DATEDIFF(mm, 0, dateadd(m, 1, QI_DATE)) MONTH,
CASE
WHEN RECP_STATUS = 3  AND 
(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
FROM T_RENT_SETTLE trst
WHERE STATUS=0 
AND RECP_ID = tt.RECP_ID
GROUP BY trst.RECP_ID
) 
<= CONVERT(VARCHAR(7),finance_date,23)
THEN 0	
WHEN PERIOD_NUM = LEASE_PERIOD THEN
ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* (30-tian) / (360* (LEASE_PERIOD / 12)), 2)
ELSE
0
END baoxian,
round(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD * LEASE_TERM / 12,2) insurance,
PERIOD_NUM,LEASE_PERIOD,FIRST_PAYDATE,FINANCECONTRACT_DATE
from (SELECT *,
DATEDIFF(day,
      finance_date,
      dateadd(dd,
              -day(dateadd(m, 1, finance_date)),
              dateadd(m, 1, finance_date))) + 1 tian,
(SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
FROM T_RATE_CONFIG T
WHERE T.STATUS = 0
 AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
     CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
 AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
     CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
 AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
FROM (select TRCP.RECP_ID,
     trcd.PERIOD_NUM,
     TRCP.LEASE_TOPRIC,
     LEASE_PERIOD,
     trcd.REN_PRICE,
     LEASE_TERM,
     case
     when CONVERT(VARCHAR(7),trcd.finance_date,23)<=CONVERT(VARCHAR(7),FINANCECONTRACT_DATE,23) then
      FINANCECONTRACT_DATE
     else
      trcd.finance_date
     end
      QI_DATE,
     trcd.finance_date finance_date,
     FINANCECONTRACT_DATE,FIRST_PAYDATE,
     RECP_STATUS
from T_RENT_COLLECTIONDETAIL trcd
left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                        trcd.RECP_ID
                                    AND trcp.STATUS = 0
LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                 trcp.RECT_ID
                             AND TRC.STATUS = 0
LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                TRC.PRCD_ID
                            AND TPCD.STATUS = 0
WHERE trcd.STATUS = 0 
and 
(year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
OR
( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
) t) tt   
)ttt
where 
DATEDIFF(mm, 0, dateadd(m, 1, DATEADD(M,LEASE_PERIOD-1 ,FIRST_PAYDATE)))>MONTH
and RECP_ID=t0.RECP_ID
GROUP BY RECP_ID,LEASE_PERIOD,FIRST_PAYDATE ,FINANCECONTRACT_DATE,MONTH 
) total
group by RECP_ID)
)
else
monthinsurance
end monthinsurance
from (
select 
 SUM(baoxian) monthinsurance,
 RECP_ID,
 MAX(insurance) insurance,
 LEASE_PERIOD,FIRST_PAYDATE ,FINANCECONTRACT_DATE,
 YEAR(DATEADD(mm, MONTH, 0)) Y,MONTH(DATEADD(mm, MONTH, 0)) M
FROM (
select tt.RECP_ID,
 TT.QI_DATE,DATEDIFF(mm, 0, QI_DATE) MONTH,
 CASE
WHEN RECP_STATUS = 3  AND 
(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
FROM T_RENT_SETTLE trst
WHERE STATUS=0 
AND RECP_ID = tt.RECP_ID
GROUP BY trst.RECP_ID
) 
<= CONVERT(VARCHAR(7),finance_date,23)
THEN 0	
   WHEN PERIOD_NUM = 1 THEN
    ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* tian / (360 * (LEASE_PERIOD / 12)) , 2)
   ELSE
    ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* 30 / (360* (LEASE_PERIOD / 12)) , 2)
 END baoxian,
 ROUND(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD / 12,2) insurance,
 PERIOD_NUM,LEASE_PERIOD,FIRST_PAYDATE,FINANCECONTRACT_DATE
from (SELECT *,
         DATEDIFF(day,
                  finance_date,
                  dateadd(dd,
                          -day(dateadd(m, 1, finance_date)),
                          dateadd(m, 1, finance_date))) + 1 tian,
         (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
            FROM T_RATE_CONFIG T
           WHERE T.STATUS = 0
             AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                 CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
             AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                 CONVERT(VARCHAR(10), FINANCECONTRACT_DATE, 23)
             AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
    FROM (select trcp.recp_id,
                 trcd.PERIOD_NUM,
                 TRCP.LEASE_TOPRIC,
                 LEASE_PERIOD,
                 trcd.REN_PRICE,
                 LEASE_TERM,
                case
                 when CONVERT(VARCHAR(7),trcd.finance_date,23)<=CONVERT(VARCHAR(7),FINANCECONTRACT_DATE,23) then
                  FINANCECONTRACT_DATE
                 else
                  trcd.finance_date
                 end
                  QI_DATE,
                 trcd.finance_date finance_date,
   TPCD.FINANCECONTRACT_DATE,FIRST_PAYDATE,
   RECP_STATUS
            from T_RENT_COLLECTIONDETAIL trcd
            left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                    trcd.RECP_ID
                                                AND trcp.STATUS = 0
            LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                             trcp.RECT_ID
                                         AND TRC.STATUS = 0
            LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                            TRC.PRCD_ID
                                        AND TPCD.STATUS = 0
           WHERE trcd.STATUS = 0
            and 
           (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
           OR
( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
	AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
           ) t) tt
	union  
		 select tt.RECP_ID, 
         TT.QI_DATE,DATEDIFF(mm, 0, dateadd(m, 1, QI_DATE)) MONTH,
         CASE
         	WHEN RECP_STATUS = 3  AND 
		(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
		FROM T_RENT_SETTLE trst
		WHERE STATUS=0 
			AND RECP_ID = tt.RECP_ID
		GROUP BY trst.RECP_ID
		) 
			<= CONVERT(VARCHAR(7),finance_date,23)
	THEN 0	
   WHEN PERIOD_NUM = LEASE_PERIOD THEN
    ROUND(LEASE_TOPRIC * INSURE_BASE_RATE*( LEASE_PERIOD / 12)* (30-tian) / (360* (LEASE_PERIOD / 12)), 2)
   ELSE
    0
 END baoxian,
 round(LEASE_TOPRIC * INSURE_BASE_RATE * LEASE_PERIOD * LEASE_TERM / 12,2) insurance,
 PERIOD_NUM,LEASE_PERIOD,FIRST_PAYDATE,FINANCECONTRACT_DATE
from (SELECT *,
         DATEDIFF(day,
                  finance_date,
                  dateadd(dd,
                          -day(dateadd(m, 1, finance_date)),
                          dateadd(m, 1, finance_date))) + 1 tian,
         (SELECT MAX(T.RATE_VALUE) / 100 INSURE_BASE_RATE
            FROM T_RATE_CONFIG T
           WHERE T.STATUS = 0
             AND CONVERT(VARCHAR(10), T.START_DATE, 23) <=
                 CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
             AND CONVERT(VARCHAR(10), T.END_DATE, 23) >=
                 CONVERT(VARCHAR(10), DATEADD(M, 1, FINANCECONTRACT_DATE), 23)
             AND T.FILED_NAME = 'INSURE_BASE_RATE') INSURE_BASE_RATE
    FROM (select TRCP.RECP_ID,
                 trcd.PERIOD_NUM,
                 TRCP.LEASE_TOPRIC,
                 LEASE_PERIOD,
                 trcd.REN_PRICE,
                 LEASE_TERM,
                 case
                 when CONVERT(VARCHAR(7),trcd.finance_date,23)<=CONVERT(VARCHAR(7),FINANCECONTRACT_DATE,23) then
                  FINANCECONTRACT_DATE
                 else
                  trcd.finance_date
                 end
                  QI_DATE,
                 trcd.finance_date finance_date,
                 FINANCECONTRACT_DATE,FIRST_PAYDATE,
                 RECP_STATUS
            from T_RENT_COLLECTIONDETAIL trcd
            left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID =
                                                    trcd.RECP_ID
                                                AND trcp.STATUS = 0
            LEFT JOIN T_RENT_CONTRACT TRC ON TRC.RECT_ID =
                                             trcp.RECT_ID
                                         AND TRC.STATUS = 0
            LEFT JOIN T_PRJT_CREDIT TPCD ON TPCD.ID =
                                            TRC.PRCD_ID
                                        AND TPCD.STATUS = 0
           WHERE trcd.STATUS = 0 
           and 
           (year(TPCD.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
           OR
( 	year(TPCD.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
	AND month(TPCD.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
           ) t) tt   
)ttt
GROUP BY 
RECP_ID,LEASE_PERIOD,FIRST_PAYDATE ,FINANCECONTRACT_DATE,MONTH
) t0
) tall
LEFT JOIN T_RENT_COLLECTIONPLAN T1 ON tall.RECP_ID = T1.RECP_ID and t1.INVOICE_STATUS=0
LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T1.RECT_ID  AND T2.STATUS = 0
LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID AND T3.STATUS = 0
LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID AND T4.STATUS = 0
LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID 
LEFT JOIN (SELECT RECT_ID, MAX(EQMT_ID) EQMT_ID
           FROM T_RENT_CONTRACTDETAIL
          WHERE STATUS = 0
          GROUP BY RECT_ID) T6 ON T6.RECT_ID = T1.RECT_ID
LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
where tall.y=year(#startDate#) and tall.m=month(#startDate#) and t1.INVOICE_STATUS=0
and t2.RECT_TYPE<>3 and t2.RECT_TYPE<>4
)ttt                           
		]]>	
		<dynamic prepend="WHERE">
		<isNotEmpty prepend="and" property="content">
 			<![CDATA[
			( CUST_NAME like '%$content$%'
			OR NAME like '%$content$%'
			OR DECP_NAME_CN like '%$content$%'
			OR NAME  like '%$content$%'
			OR RECP_CODE like '%$content$%')  
			]]>
		</isNotEmpty> 
		</dynamic>                                                                  			                                                                                		                                                                                                                                         	
	</select>
	
	<select id="queryInsuranceToExport" parameterClass="map" resultClass="java.util.HashMap">
			select tcc.CUST_NAME,
			       trc.LEASE_TOPRIC,
			       trcp.LEASE_PERIOD,
			       trcp.START_DATE,
			       trc.LEASE_TOPRIC * #INSURE_BASE_RATE# * trcp.LEASE_PERIOD / 12  insurance,
			       trc.LEASE_TOPRIC * #INSURE_BASE_RATE#/360 * 30   monthinsurance,
			       trcp.RECP_CODE,
			       tuu.NAME,
			       tdc.DECP_NAME_CN
			from T_RENT_COLLECTIONPLAN trcp
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID
			left join T_USER_USER tuu on tuu.ID =trc.SENSOR_ID
			left join T_DEPT_COMPANY tdc on tdc.DECP_ID = trc.DECP_ID
			where trcp.STATUS = 0 and trc.STATUS = 0
			order by trcp.START_DATE		                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	<!-- Modify by Michael 2012-3-5 -->
	<select id="queryStamp_count" parameterClass="map" resultClass="java.lang.Integer">   
	<![CDATA[
			select count(1) from
			(	  	 
		 	SELECT 
				T.RECP_ID
			FROM
				T_RENT_COLLECTIONPLAN T 
				LEFT JOIN (SELECT RECP_ID,SUM(MONTH_PRICE) SUM_MONTH_PRICE FROM T_RENT_COLLECTIONDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T1 ON T1.RECP_ID = T.RECP_ID
				LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T.RECT_ID AND T2.STATUS = 0
				LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID AND T3.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID AND T4.STATUS = 0
				LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = T.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T12 ON T12.ID = T2.PRCD_ID AND T12.STATUS = 0
			WHERE
				T.STATUS = 0
			]]>
			<isNotEmpty prepend="and" property="companyCode">
				T12.company_code = #companyCode#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="startDate">
				<![CDATA[
					CONVERT(DATE,T12.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#startTime#) AND CONVERT(DATE,#endTime#)
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					( T3.CUST_NAME like '%$content$%'
					OR T9.NAME like '%$content$%'
					OR T2.LEASE_CODE like '%$content$%'
					OR T4.DECP_NAME_CN like '%$content$%'
					OR T5.NAME  like '%$content$%'
					OR T.RECP_CODE like '%$content$%')    
					]]>
			</isNotEmpty>   
			) t		                                                                         			                                                                                		                                                                                                                                         	
	</select>
	
	
	<select id="queryStamp" parameterClass="map" resultClass="java.util.HashMap">
					SELECT *,
					ROUND(CONVERT(VARCHAR,(allmonthprice * STAMP_TAX_MONTHPRIC)),2)   rongzishuie,
					ROUND(CONVERT(VARCHAR,(allmonthprice * STAMP_TAX_MONTHPRIC)),2)  rzshuiwu,
					ROUND(CONVERT(VARCHAR,(allownprice * STAMP_TAX_TOPRIC)),2)   weituoshuie,
					ROUND(CONVERT(VARCHAR,(allownprice * STAMP_TAX_TOPRIC)),2)  wtshuiwu,
					ROUND(CONVERT(VARCHAR,(allmonthprice * STAMP_TAX_MONTHPRIC+allownprice * STAMP_TAX_TOPRIC)),2)
					<!-- ROUND(allmonthprice * STAMP_TAX_MONTHPRIC,2)
					+ ROUND(allownprice * STAMP_TAX_TOPRIC,2) -->
					 xiaoji   
				
				FROM
				(	
					SELECT 
						T3.CUST_NAME,T9.NAME SUPL_NAME,T2.LEASE_CODE,T4.DECP_NAME_CN,T5.NAME,
						T1.SUM_MONTH_PRICE allmonthprice,
						T.LEASE_TOPRIC allownprice,
						(	SELECT MAX(TT.RATE_VALUE) / 100 STAMP_TAX_MONTHPRIC FROM T_RATE_CONFIG TT 
							WHERE TT.STATUS = 0 
								AND CONVERT(VARCHAR(10),TT.START_DATE,23) &lt;= CONVERT(VARCHAR(10),T12.FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),TT.END_DATE,23) >= CONVERT(VARCHAR(10),T12.FINANCECONTRACT_DATE,23)
								AND TT.FILED_NAME = 'STAMP_TAX_MONTHPRIC' and TT.TAX_PLAN_CODE=T.TAX_PLAN_CODE
						) STAMP_TAX_MONTHPRIC,
						(	SELECT MAX(TT.RATE_VALUE) / 100 STAMP_TAX_TOPRIC FROM T_RATE_CONFIG TT 
							WHERE TT.STATUS = 0 
								AND CONVERT(VARCHAR(10),TT.START_DATE,23) &lt;= CONVERT(VARCHAR(10),T12.FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),TT.END_DATE,23) >= CONVERT(VARCHAR(10),T12.FINANCECONTRACT_DATE,23)
								AND TT.FILED_NAME = 'STAMP_TAX_TOPRIC' and TT.TAX_PLAN_CODE=T.TAX_PLAN_CODE
						) STAMP_TAX_TOPRIC
				FROM
						T_RENT_COLLECTIONPLAN T 
						LEFT JOIN (SELECT RECP_ID,SUM(MONTH_PRICE) SUM_MONTH_PRICE FROM T_RENT_COLLECTIONDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T1 ON T1.RECP_ID = T.RECP_ID
						LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T.RECT_ID AND T2.STATUS = 0
						LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID AND T3.STATUS = 0
						LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID AND T4.STATUS = 0
						LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID
						LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = T.RECP_ID
						LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
						LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
						LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
						LEFT JOIN T_PRJT_CREDIT T12 ON T12.ID = T2.PRCD_ID AND T12.STATUS = 0		
					WHERE
						T.STATUS = 0
			<isNotEmpty prepend="and" property="startDate">
				<![CDATA[
					CONVERT(DATE,T12.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#startTime#) AND CONVERT(DATE,#endTime#)
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="companyCode">
				T12.company_code = #companyCode#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					( T3.CUST_NAME like '%$content$%'
					OR T9.NAME like '%$content$%'
					OR T2.LEASE_CODE like '%$content$%'
					OR T4.DECP_NAME_CN like '%$content$%'
					OR T5.NAME  like '%$content$%'
					OR T.RECP_CODE like '%$content$%')  
					]]>
			</isNotEmpty>    
			) TTT		 
	</select>
	
	<select id="queryStampToExport" parameterClass="map" resultClass="java.util.HashMap">
			select tcc.CUST_NAME,
			       t.allmonthprice,
			       t.allmonthprice * 0.001   rongzishuie,
			       ROUND(t.allmonthprice * 0.001,1)  rzshuiwu,
			       t.allownprice,
			       t.allownprice * 0.0003   weituoshuie,
			       ROUND(t.allownprice * 0.0003,1)  wtshuiwu,
			       t.allownprice * 0.00171 * 2   baoxianjishuijine,
			       t.allownprice * 0.00171 * 2 * 0.001   baoxianshuie,
			       ROUND(t.allownprice * 0.00171 * 2 * 0.001,1)  bxshuiwu,
			       ROUND(t.allmonthprice * 0.001,1)+ ROUND(t.allownprice * 0.0003,1)+ ROUND(t.allownprice * 0.00171 * 2 * 0.001,1)  xiaoji   
			from T_RENT_COLLECTIONPLAN trcp
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID
			left join (select trcd.RECP_ID,
								SUM(trcd.MONTH_PRICE)   allmonthprice,
								SUM(trcd.OWN_PRICE)   allownprice
						 from T_RENT_COLLECTIONDETAIL trcd 
						 group by trcd.RECP_ID) t on t.RECP_ID = trcp.RECP_ID
			where trcp.STATUS = 0 and trc.STATUS = 0		                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	<!-- Modify by Michael 2012 3-5 将印花税拆分成合同印花税和保险印花税 -->
	<select id="queryInsuranceStamp" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
			select rc.CUST_NAME, rc.LEASE_CODE,
			(select top 1 PAY_DATE
				from T_SUPL_PLAYDETIL 
				where ID in (
				  select PAYMONEYID from 
				  T_PAY_INC_JOIN
				  where INCID = insu.INCU_ID
				)
				and BACKSTATE = 3 and STATUS=0 and STATE in (0,1,3)
				and DEPARTMENTSTATUS = 1
				and EXAMSTATUS = 1
				and FINANCIALSTATUS = 1
				and convert(date, PAY_DATE) >= convert(date, #start_date#)
				and convert(date, PAY_DATE) <= convert(date, #end_date#)
			) as PAY_DATE,
			pc.CREDIT_RUNCODE
			, ic.SHORT_NAME
			, u.[NAME]
			, dc.DECP_NAME_CN
			, ps.LEASE_TERM
			, rp.FIRST_PAYDATE
			, insu.INSU_PRICE,
			insu.INSU_PRICE/1000 as 'tax'
			from T_INSU_INSURANCELIST insu
			left join T_RENT_CONTRACT rc on insu.RECT_ID = rc.RECT_ID
			left join T_PRJT_CREDIT pc on rc.PRCD_ID = pc.ID
			left join T_INSU_COMPANY ic on insu.INCP_ID = ic.INCP_ID
			left join T_USER_USER u on pc.SENSOR_ID = u.ID
			left join T_DEPT_DEPARTMENT dp on u.DEPT_ID = dp.ID
			left join T_DEPT_COMPANY dc on dp.DECP_ID = dc.DECP_ID
			left join T_PRJT_CREDITSCHEME ps on ps.CREDIT_ID = pc.ID
			and ps.STATUS = 0
			left join T_RENT_COLLECTIONPLAN rp on rp.RECT_ID = rc.RECT_ID
			and rp.STATUS = 0
			where insu.INCU_ID in (
				select INCID from T_PAY_INC_JOIN
				where PAYMONEYID in (
					select T1.ID
					FROM T_SUPL_PLAYDETIL T1
					where  T1.BACKSTATE = 3 and T1.STATUS=0 and T1.STATE in (0,1,3)
					and DEPARTMENTSTATUS = 1
					and EXAMSTATUS = 1
					and FINANCIALSTATUS = 1
					and convert(date, T1.PAY_DATE) >= convert(date, #start_date#)
					and convert(date, T1.PAY_DATE) <= convert(date, #end_date#)
				)
			)
			
			

		]]>	
		<isNotEmpty prepend="and" property="companyCode">
			pc.company_code = #companyCode#
		</isNotEmpty>
	</select>

	<!-- Modify by Michael 2012 3-5 将印花税拆分成合同印花税和保险印花税 -->
	<select id="queryInsuranceStamp_count" parameterClass="map" resultClass="java.lang.Integer">
		<![CDATA[
		select count(1) from
			(	  	 
		 	SELECT 
				T.RECP_ID
			FROM
			T_RENT_COLLECTIONPLAN T 
			LEFT JOIN T_RENT_CONTRACT T2 ON T2.RECT_ID = T.RECT_ID AND T2.STATUS = 0
			LEFT JOIN T_CUST_CUSTOMER T3 ON T3.CUST_ID = T2.CUST_ID AND T3.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY T4 ON T4.DECP_ID = T2.DECP_ID AND T4.STATUS = 0
			LEFT JOIN T_USER_USER T5 ON T5.ID = T2.SENSOR_ID
			LEFT JOIN t_insu_company T10 ON T10.INCP_ID = T.INSURANCE_COMPANY_ID AND T10.INCP_STATUS = 0
			LEFT JOIN (	SELECT T.RECP_ID ,SUM(T2.INSU_RATE * T.UNIT_PRICE /1000) SUM_BX,MAX(t2.CREATE_DATE) CREATE_DATE
						FROM
							T_RENT_CONTRACTDETAIL T
							LEFT JOIN T_INSU_EMPT2INSULIST T1 ON T1.EQMT_ID = T.EQMT_ID AND T1.STATUS = 0
							LEFT JOIN T_INSU_INSURANCELIST T2 ON T1.INSU_ID = T2.INCU_ID AND T2.STATUS = 0
						WHERE T.STATUS = 0
						GROUP BY T.RECP_ID 
						) T11 ON T11.RECP_ID = T.RECP_ID
			LEFT JOIN T_PRJT_CREDIT T12 ON T12.ID = T2.PRCD_ID AND T12.STATUS = 0
			WHERE
			T.STATUS = 0 and (t2.RECT_TYPE<>3 and t2.RECT_TYPE<>4)
	]]>	
	<isNotEmpty prepend="and" property="startDate">
		<![CDATA[
		 (year(t11.CREATE_DATE)= year(convert(DATE,convert(varchar,#startDate#, 23))) 
		and month(t11.CREATE_DATE)= month(convert(DATE,convert(varchar,#startDate#, 23))))
		]]>
	</isNotEmpty>
	<isNotEmpty prepend="and" property="content">
 			<![CDATA[
			( T3.CUST_NAME like '%$content$%'
			OR T2.LEASE_CODE like '%$content$%'
			OR T4.DECP_NAME_CN like '%$content$%'
			OR T5.NAME  like '%$content$%'
			OR T.RECP_CODE like '%$content$%')  
			]]>
	</isNotEmpty>    
		)ttt	
	</select>
	
	<!-- 营业税 -->
	<!-- Modify by Michael 2012 3-19 增加停、续开发票条件筛查 -->
	<select id="queryBusinessTax_count" parameterClass="map" resultClass="java.lang.Integer">
	<!-- Modify by Michael 不以开票日期，以T_RENT_COLLECTIONDETAIL finance_date 为查询区间 -->
			<![CDATA[			
		select count(*)
			from( 
			select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,SUM(REN_PRICE) REN_PRICE,
			 (	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE='1'
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE='1'
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE='1'
					) FEduAmount	
			from(
				select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
				0 CAI,SUM(ttt.RENT_PRICE) REN_PRICE,MAX(QI_DATE) QI_DATE,MAX(FINANCECONTRACT_DATE) FINANCECONTRACT_DATE
				from
					(select trcp.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
					tdc.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME,
					0 CAI,trid.RENT_PRICE		
					,dateadd(month,-1,trid.create_time) QI_DATE,
					T10.FINANCECONTRACT_DATE
			  from T_RENT_INVOICEDETAIL  trid 
					left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trid.RECP_ID AND trcp.STATUS = 0 
					left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
					left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
					LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
					LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
					LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
					LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
					LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
					LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					left join T_DEPT_DEPARTMENT dept on dept.ID = tuser.DEPT_ID and dept.STATUS = 0
      	  			left join T_DEPT_COMPANY tdc on dept.DECP_ID = tdc.DECP_ID and tdc.STATUS = 0
      	  			LEFT JOIN T_REPORT_DATE TRD ON  TRID.CREATE_TIME  BETWEEN TRD.BEGINTIME AND TRD.ENDTIME
					WHERE	
						trid.state='2' and (trcp.TAX_PLAN_CODE='1' or trcp.TAX_PLAN_CODE='5')
						 AND YEAR(DATEADD(MONTH,-1,TRD.ENDTIME ))=YEAR(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))
						AND MONTH(DATEADD(MONTH,-1,TRD.ENDTIME))=MONTH(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))
					) ttt
							
			   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME
		)TTT
		group by RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME 
		)TTTT
				]]>			 
			 <!-- Modify by Michael 不以开票日期，以T_RENT_COLLECTIONDETAIL finance_date 为查询区间 -->
			<dynamic prepend="where">
			<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					( CUST_NAME like '%$content$%'
					OR DECP_NAME_CN like '%$content$%'
					OR LEASE_CODE like '%$content$%'
					OR NAME like '%$content$%'
					OR SUPL_NAME LIKE '%$content$%'
					 )  
					]]>
			</isNotEmpty> 
			</dynamic>                                                     	                                                                             			                                                                                		                                                                                                                                         	
	</select>
	<!-- 营业税 -->
	<!-- Modify by Michael 2012 3-19 增加停、续开发票条件筛查 -->
	<select id="queryBusinessTax" parameterClass="map" resultClass="java.util.HashMap">
			 <!-- 城建税、教育税 先乘后取整 -->
			<![CDATA[			
			select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REN_PRICE,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE)) YYshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FBuildTax)) CJshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FEduAmount)) JYshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE)) + convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FBuildTax)) + convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FEduAmount)) xiaoji   
			from( 
			select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,SUM(REN_PRICE) REN_PRICE,
			 (	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE='1'
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE='1'
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE='1'
					) FEduAmount	
			from(
				select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
				0 CAI,SUM(ttt.RENT_PRICE) REN_PRICE,MAX(QI_DATE) QI_DATE,MAX(FINANCECONTRACT_DATE) FINANCECONTRACT_DATE
				from
					(select trcp.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
					tdc.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME,
					0 CAI,trid.RENT_PRICE		
					,dateadd(month,-1,trid.create_time) QI_DATE,
					T10.FINANCECONTRACT_DATE
			  from T_RENT_INVOICEDETAIL  trid 
					left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trid.RECP_ID AND trcp.STATUS = 0 
					left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
					left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
					LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
					LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
					LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
					LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
					LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
					LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					left join T_DEPT_DEPARTMENT dept on dept.ID = tuser.DEPT_ID and dept.STATUS = 0
      	  			left join T_DEPT_COMPANY tdc on dept.DECP_ID = tdc.DECP_ID and tdc.STATUS = 0
      	  			LEFT JOIN T_REPORT_DATE TRD ON  TRID.CREATE_TIME  BETWEEN TRD.BEGINTIME AND TRD.ENDTIME
					WHERE	
						trid.state='2'   and (trcp.TAX_PLAN_CODE='1' or trcp.TAX_PLAN_CODE='5')
						 AND YEAR(DATEADD(MONTH,-1,TRD.ENDTIME ))=YEAR(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))
						AND MONTH(DATEADD(MONTH,-1,TRD.ENDTIME))=MONTH(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))
					) ttt
							
			   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME
		)TTT
		group by RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME 
		)TTTT
			]]>			 
			 <!-- Modify by Michael 不以开票日期，以T_RENT_COLLECTIONDETAIL finance_date 为查询区间 -->
			<dynamic prepend="where">
			<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					( CUST_NAME like '%$content$%'
					OR DECP_NAME_CN like '%$content$%'
					OR LEASE_CODE like '%$content$%'
					OR NAME like '%$content$%'
					OR SUPL_NAME LIKE '%$content$%'
					 )  
					]]>
			</isNotEmpty> 
			</dynamic>                                 			                                                                                		                                                                                                                                         	
	</select>
	
	<select id="queryRealPriceToExport" parameterClass="map" resultClass="java.util.HashMap">
	select trc.CUST_NAME,
       trc.LEASE_CODE,
       pro.NAME + city.NAME  area,
       (case when trcd.PERIOD_NUM = 1 then null
                                     else trcd.LAST_PRICE - trcd.DEPOSIT_PRICE
                                     end) qimoyue,
       t1.total_month_price,
       t1.total_ren_price,
       t2.changqiyingshoukuan,
       trcd.REN_PRICE,       
      (case when trcd.PERIOD_NUM = 1 then t1.total_month_price -  ISNULL(t2.changqiyingshoukuan,0)
                             else trcd.LAST_PRICE - trcd.DEPOSIT_PRICE + t1.total_month_price -  ISNULL(t2.changqiyingshoukuan,0)
                             end)  value1,
        (case when trcd.PERIOD_NUM = 1 then t1.total_ren_price -  trcd.REN_PRICE
                         else trcd.LAST_PRICE - trcd.DEPOSIT_PRICE + t1.total_ren_price -  trcd.REN_PRICE
                         end)  value2,
       (case when trcd.PERIOD_NUM = 1 then t1.total_month_price -  ISNULL(t2.changqiyingshoukuan,0)
                                       - (t1.total_ren_price -  trcd.REN_PRICE)
                     else trcd.LAST_PRICE - trcd.DEPOSIT_PRICE + t1.total_month_price -  ISNULL(t2.changqiyingshoukuan,0) 
                         - (trcd.LAST_PRICE - trcd.DEPOSIT_PRICE + t1.total_ren_price -  trcd.REN_PRICE)
                     end)  value3,
       trcd.PERIOD_NUM
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
		left join T_AREA pro on pro.ID = trc.PROVINCE_ID
		left join T_AREA city on city.ID = trc.CITY_ID
		left join (select  trc.RECT_ID,
							SUM(trcd.MONTH_PRICE)   total_month_price,
							SUM(trcd.REN_PRICE)     total_ren_price
					from T_RENT_COLLECTIONDETAIL trcd
					left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID
					left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID
					where trcd.STATUS = 0 and trcp.STATUS = 0 and trc.STATUS = 0
					group by trc.RECT_ID) t1 on t1.RECT_ID = trc.RECT_ID
		left join (select tfcb.RECP_ID,
						   tfcb.RECD_PERIOD,
						   sum(tfcb.REAL_PRICE)  changqiyingshoukuan
					from T_FINA_COLLECTIONBILL tfcb
					where tfcb.FICB_ITEM = #value1# or tfcb.FICB_ITEM = #value2# 
					group by tfcb.RECP_ID,tfcb.RECD_PERIOD) t2 on t2.RECP_ID = trcd.RECP_ID and t2.RECD_PERIOD = trcd.PERIOD_NUM
		where trcd.STATUS = 0 and trcp.STATUS = 0 and trc.STATUS = 0	and YEAR(trcd.PAY_DATE) = YEAR(GetDate())
		   and MONTH(trcd.PAY_DATE) = MONTH(GetDate())		                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	<!-- Modify by Michael 2012 02/07 修改查询条件 -->
	<!-- Modify by Shen Qi 2012 03/08 修改查询条件 -->
		<select id="queryNotToAllot_count" parameterClass="map" resultClass="java.lang.Integer">
		select COUNT(*) from (
		select  TPC.DELAY_PAY_STATUS,TPC.ID,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME superName,
				tpc.SENSOR_ID,tpc.VALID_DAY,tpc.LEASE_CODE,
				tcc.CUST_NAME,
				MAX(tpce.BRAND) BRAND,
				tcg.GRANT_PRICE,
				tt.PAY_MONEY,
				tpcs.LEASE_TOPRIC PAYCOUNT,
				CASE 
					WHEN YEAR(tt.PAY_DATE) = 1900
						THEN NULL
					ELSE tt.PAY_DATE
				END PAY_DATE,
				tpc.wind_result_date,
				TT1.PAY_MONEY PAY_MONEY_ALL,
				<!-- 计算拨款额 -->
				CASE WHEN prjt.APPRORIATEMON is null
					 THEN 0
					 ELSE prjt.APPRORIATEMON
					 END +
				CASE WHEN prjt1.APPRORIATEMON is null
					 THEN 0
					 ELSE prjt1.APPRORIATEMON
					 END AMOUNT,
				prjt.TYPE type,
				prjt1.TYPE type1,tpc.CLERK_ID
				from t_prjt_credit tpc
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID =tpc.CUST_ID 
				left join T_PRJT_CREDITEQUIPMENT tpce on tpce.CREDIT_ID = tpc.ID
				left join T_CUST_GRANTPLAN tcg on tcg.CUST_ID = tcc.CUST_ID
				left join T_PRJT_CREDITSCHEME tpcs on tpcs.CREDIT_ID = tpc.ID
				left join T_RENT_CONTRACT trc on trc.PRCD_ID = tpc.ID
				left join (	select t.CREDIT_ID,
								sum(t.PAY_MONEY) PAY_MONEY,
								MIN(t.PAY_DATE) PAY_DATE
							from T_SUPL_PLAYDETIL t 
							where BACKSTATE='0' 
								And STATUS = 0
							  	AND STATE = 3 
							group by T.CREDIT_ID) tt on TPC.ID=tt.CREDIT_ID
				left join (	select t.CREDIT_ID,
								sum(t.PAY_MONEY) PAY_MONEY,
								MIN(t.PAY_DATE) PAY_DATE
							from T_SUPL_PLAYDETIL t 
							where BACKSTATE='0' 
								And STATUS = 0
							  	AND (STATE = 0 OR STATE = 1 OR STATE = 3)
							group by T.CREDIT_ID) tt1 on TPC.ID=tt1.CREDIT_ID
				<!-- 拿办事处  -->			
				left join T_USER_USER ttt on  ttt.ID =tpc.SENSOR_ID
		        left join T_DEPT_DEPARTMENT dept on dept.ID = ttt.DEPT_ID
		        left join T_DEPT_COMPANY cmpy on dept.DECP_ID=cmpy.DECP_ID
        
                <!-- 拿经办人和主管名字 -->
                left join T_USER_USER ttt1 on ttt1.ID =tpc.SENSOR_ID 
        		left join T_USER_USER ttt2 on ttt2.ID =ttt1.upper_user
        		
        	    <!-- 拿需要的拨款金额 -->
        	    left join T_PRJT_CREDITAPPROPIATE prjt on tpc.ID=prjt.CREDIT_ID AND prjt.status=0 AND prjt.TYPE=1 <!-- type=1 是指交机后的拨款 -->
        	    
        	    left join T_PRJT_CREDITAPPROPIATE prjt1 on tpc.ID=prjt1.CREDIT_ID AND prjt1.status=0 AND prjt1.TYPE=0 <!-- type=0 是指交机前的拨款 -->
        	    
				where  tpc.STATUS=0 AND (tpc.WIND_STATE=1 OR tpc.WIND_STATE=2)
  				AND (trc.STATUS=0 or trc.STATUS is null ) 
   				and (tpc.FINANCECONTRACT_DATE is null ) 
			 		<isNotEmpty prepend="and" property="content">
			 			<![CDATA[
						(tpc.LEASE_CODE like '%$content$%'
						or tcc.CUST_NAME like '%$content$%'
						or tpce.BRAND like '%$content$%')  
						]]>
					</isNotEmpty>
				group by TPC.DELAY_PAY_STATUS,TPC.ID,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME,tpc.SENSOR_ID,tpc.CLERK_ID,tpc.VALID_DAY,tpc.LEASE_CODE,tcc.CUST_NAME,tcg.GRANT_PRICE,tt.PAY_MONEY,tpcs.LEASE_TOPRIC,tt.PAY_DATE,tpc.wind_result_date,TT1.PAY_MONEY,prjt.APPRORIATEMON,prjt.TYPE,prjt1.APPRORIATEMON,prjt1.TYPE
				) x where (PAY_MONEY &lt;= 0 or PAY_MONEY IS NULL)
					  <!-- 增加条件,只遍历已核准日期与当天的差小于有效期时间,
							默认valid_day是90天,也可以通过延长案件有效期来修改valid_day, add by ShenQi -->
				     <!-- AND DATEDIFF(day,x.wind_result_date,GETDATE()) &lt;= x.VALID_DAY -->
				     
				     <!-- 2012/05/31 Yang Yun 有效期可选择 -->
				     AND x.wind_result_date IS NOT NULL
				     <isEqual property="validateStatus" compareValue="N">
				     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) <= x.VALID_DAY ]]>
				     </isEqual>
				     <isEqual property="validateStatus" compareValue="Y">
				     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) > x.VALID_DAY ]]>
				     </isEqual>
				     
				     <!-- 2012/05/31 Yang Yun 缓拨状态查询 -->
				     <isEqual property="delayStatus" compareValue="N">
				     	<![CDATA[ AND (x.DELAY_PAY_STATUS IS NULL OR x.DELAY_PAY_STATUS = 0) ]]>
				     </isEqual>
				     <isEqual property="delayStatus" compareValue="Y">
				     	<![CDATA[ AND x.DELAY_PAY_STATUS = -1 ]]>
				     </isEqual> 
				     
				     AND x.PAY_DATE IS NULL
				     <!-- 业务员只能看到自己的拨款项,业务员主管能看到自己的及属于自己下面的业务员的拨款信息,经理等能看到所有的 add by ShenQi -->
				     <isEqual prepend="and" property="p_usernode" compareValue="1">
				  	 	(x.SENSOR_ID = #s_employeeId#
				  	 	or x.CLERK_ID = #s_employeeId#)
				  	 </isEqual>
					 <isEqual prepend="and" property="p_usernode" compareValue="2">
							exists(select ID from T_USER_USER
							where DEPT_ID in 
							(select uc.DEPT_ID from dbo.T_USER_USER2COMPANY uc
							where uc.USER_ID = #s_employeeId#)
							and ID = x.SENSOR_ID)
					 </isEqual>
				     <isNotEmpty property="NAME">
				             AND x.NAME LIKE '%$NAME$%'
				     </isNotEmpty>
				     <isNotEmpty property="OFFICE">
				             AND x.DECP_ID=#OFFICE#
				     </isNotEmpty>
				<!-- 
				(x.PAYCOUNT-x.PAY_MONEY)>0 or (x.PAYCOUNT-x.PAY_MONEY) is null
				-->
	</select>
	
	<!-- Modify by Michael 2012 02/07 修改查询条件 -->
	<!-- Modify by Shen Qi 2012 03/08 修改查询条件 -->
	<select id="queryNotToAllot" parameterClass="map" resultClass="java.util.HashMap">
	select dateadd(day,x.VALID_DAY,x.wind_result_date) effectDate ,
			DATEDIFF(day,x.wind_result_date,GETDATE()) as daily_day, x.* from (
		select  TPC.DELAY_PAY_STATUS,TPC.ID CREDIT_ID,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME superName,
				tpc.SENSOR_ID,tpc.VALID_DAY,tpc.LEASE_CODE,
				tcc.CUST_NAME,
				MAX(tpce.BRAND) BRAND,
				tcg.GRANT_PRICE,
				tt.PAY_MONEY,
				tpcs.LEASE_TOPRIC PAYCOUNT,
				CASE 
					WHEN YEAR(tt.PAY_DATE) = 1900
						THEN NULL
					ELSE tt.PAY_DATE
				END PAY_DATE,
				tpc.wind_result_date,
				TT1.PAY_MONEY PAY_MONEY_ALL,
				<!-- 计算拨款额 -->
				CASE WHEN prjt.APPRORIATEMON is null
					 THEN 0
					 ELSE prjt.APPRORIATEMON
					 END +
				CASE WHEN prjt1.APPRORIATEMON is null
					 THEN 0
					 ELSE prjt1.APPRORIATEMON
					 END AMOUNT,
				prjt.TYPE type,
				prjt1.TYPE type1,tpc.CLERK_ID
				from t_prjt_credit tpc
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID =tpc.CUST_ID 
				left join T_PRJT_CREDITEQUIPMENT tpce on tpce.CREDIT_ID = tpc.ID
				left join T_CUST_GRANTPLAN tcg on tcg.CUST_ID = tcc.CUST_ID
				left join T_PRJT_CREDITSCHEME tpcs on tpcs.CREDIT_ID = tpc.ID
				left join T_RENT_CONTRACT trc on trc.PRCD_ID = tpc.ID
				left join (	select t.CREDIT_ID,
								sum(t.PAY_MONEY) PAY_MONEY,
								MIN(t.PAY_DATE) PAY_DATE
							from T_SUPL_PLAYDETIL t 
							where BACKSTATE='0' 
								And STATUS = 0
							  	AND STATE = 3 
							group by T.CREDIT_ID) tt on TPC.ID=tt.CREDIT_ID
				left join (	select t.CREDIT_ID,
								sum(t.PAY_MONEY) PAY_MONEY,
								MIN(t.PAY_DATE) PAY_DATE
							from T_SUPL_PLAYDETIL t 
							where BACKSTATE='0' 
								And STATUS = 0
							  	AND (STATE = 0 OR STATE = 1 OR STATE = 3)
							group by T.CREDIT_ID) tt1 on TPC.ID=tt1.CREDIT_ID
				<!-- 拿办事处  -->			
				left join T_USER_USER ttt on  ttt.ID =tpc.SENSOR_ID
		        left join T_DEPT_DEPARTMENT dept on dept.ID = ttt.DEPT_ID
		        left join T_DEPT_COMPANY cmpy on dept.DECP_ID=cmpy.DECP_ID
        
                <!-- 拿经办人和主管名字 -->
                left join T_USER_USER ttt1 on ttt1.ID =tpc.SENSOR_ID
        		left join T_USER_USER ttt2 on ttt2.ID =ttt1.upper_user
        		
        		<!-- 拿需要的拨款金额 -->
        	    left join T_PRJT_CREDITAPPROPIATE prjt on tpc.ID=prjt.CREDIT_ID AND prjt.status=0 AND prjt.TYPE=1 <!-- type=1 是指交机后的拨款 -->
        	    
        	    left join T_PRJT_CREDITAPPROPIATE prjt1 on tpc.ID=prjt1.CREDIT_ID AND prjt1.status=0 AND prjt1.TYPE=0 <!-- type=0 是指交机前的拨款 -->
        	    
				where  tpc.STATUS=0 AND (tpc.WIND_STATE=1 OR tpc.WIND_STATE=2)
  				AND (trc.STATUS=0 or trc.STATUS is null ) 
   				and (tpc.FINANCECONTRACT_DATE is null ) 
   				
   				<!-- modify by xuyuefei 2014/7/18  增加公司别 -->
   				<isNotEmpty prepend="and" property="companyCode">
			        tpc.company_code = #companyCode#
		        </isNotEmpty>
   				
		 		<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					(tpc.LEASE_CODE like '%$content$%'
					or tcc.CUST_NAME like '%$content$%'
					or tpce.BRAND like '%$content$%')  
					]]>
				</isNotEmpty>
				<isEqual prepend="and" property="vip_flag" compareValue="0">
		 			<![CDATA[
					(tpc.vip_flag = 0
					or tpc.vip_flag is null)
					]]>
				</isEqual>
				<isEqual prepend="and" property="vip_flag" compareValue="1">
		 			<![CDATA[
					tpc.vip_flag = 1
					]]>
				</isEqual>
					
				group by TPC.DELAY_PAY_STATUS,TPC.ID,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME,tpc.SENSOR_ID,tpc.CLERK_ID,tpc.VALID_DAY,tpc.LEASE_CODE,tcc.CUST_NAME,tcg.GRANT_PRICE,tt.PAY_MONEY,tpcs.LEASE_TOPRIC,tt.PAY_DATE,tpc.wind_result_date,TT1.PAY_MONEY,prjt.APPRORIATEMON,prjt.TYPE,prjt1.APPRORIATEMON,prjt1.TYPE
				) x 
				
				where (x.PAY_MONEY &lt;= 0 or x.PAY_MONEY IS NULL)
				<!-- 增加条件,只遍历已核准日期与当天的差小于有效期时间,
								默认valid_day是90天,也可以通过延长案件有效期来修改valid_day, add by ShenQi -->
					 <!-- 2012/05/31 Yang Yun 有效期可选择 -->
					 AND x.wind_result_date IS NOT NULL
				     <isEqual property="validateStatus" compareValue="N">
				     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) <= x.VALID_DAY ]]>
				     </isEqual>
				     <isEqual property="validateStatus" compareValue="Y">
				     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) > x.VALID_DAY ]]>
				     </isEqual>
				     
				     <!-- 2012/05/31 Yang Yun 缓拨状态查询 -->
				     <isEqual property="delayStatus" compareValue="N">
				     	<![CDATA[ AND (x.DELAY_PAY_STATUS IS NULL OR x.DELAY_PAY_STATUS = 0) ]]>
				     </isEqual>
				     <isEqual property="delayStatus" compareValue="Y">
				     	<![CDATA[ AND x.DELAY_PAY_STATUS = -1 ]]>
				     </isEqual>
				     
				     AND x.PAY_DATE IS NULL
				     <!-- 业务员只能看到自己的拨款项,业务员主管能看到自己的及属于自己下面的业务员的拨款信息,经理等能看到所有的 add by ShenQi -->
				      <isEqual prepend="and" property="p_usernode" compareValue="1">
				  	 	(x.SENSOR_ID = #s_employeeId#
				  	 	or x.CLERK_ID = #s_employeeId#)
				  	 </isEqual>
					 <isEqual prepend="and" property="p_usernode" compareValue="2">
							exists(select ID from T_USER_USER
							where DEPT_ID in 
							(select uc.DEPT_ID from dbo.T_USER_USER2COMPANY uc
							where uc.USER_ID = #s_employeeId#)
							and ID = x.SENSOR_ID)
					 </isEqual>
				     <isNotEmpty property="NAME">
				             AND x.NAME LIKE '%$NAME$%'
				     </isNotEmpty>
				     <isNotEmpty property="OFFICE">
				             AND x.DECP_ID=#OFFICE#
				     </isNotEmpty>
	</select>
	
	<!-- add by Shen Qi -->
	<select id="queryNotToAllotSum" parameterClass="map" resultClass="java.lang.String">
				select SUM(x.AMOUNT) from (
					select  TPC.DELAY_PAY_STATUS,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME superName,
							tpc.SENSOR_ID,tpc.VALID_DAY,tpc.LEASE_CODE,
							tcc.CUST_NAME,
							MAX(tpce.BRAND) BRAND,
							tcg.GRANT_PRICE,
							tt.PAY_MONEY,
							tpcs.LEASE_TOPRIC PAYCOUNT,
							CASE 
								WHEN YEAR(tt.PAY_DATE) = 1900
									THEN NULL
								ELSE tt.PAY_DATE
							END PAY_DATE,
							tpc.wind_result_date,
							TT1.PAY_MONEY PAY_MONEY_ALL,
							<!-- 计算拨款额 -->
							CASE WHEN prjt.APPRORIATEMON is null
								 THEN 0
								 ELSE prjt.APPRORIATEMON
								 END +
							CASE WHEN prjt1.APPRORIATEMON is null
								 THEN 0
								 ELSE prjt1.APPRORIATEMON
								 END AMOUNT,
							prjt.TYPE type,
							prjt1.TYPE type1
							from t_prjt_credit tpc
							left join T_CUST_CUSTOMER tcc on tcc.CUST_ID =tpc.CUST_ID 
							left join T_PRJT_CREDITEQUIPMENT tpce on tpce.CREDIT_ID = tpc.ID
							left join T_CUST_GRANTPLAN tcg on tcg.CUST_ID = tcc.CUST_ID
							left join T_PRJT_CREDITSCHEME tpcs on tpcs.CREDIT_ID = tpc.ID
							left join T_RENT_CONTRACT trc on trc.PRCD_ID = tpc.ID
							left join (	select t.CREDIT_ID,
											sum(t.PAY_MONEY) PAY_MONEY,
											MIN(t.PAY_DATE) PAY_DATE
										from T_SUPL_PLAYDETIL t 
										where BACKSTATE='0' 
											And STATUS = 0
										  	AND STATE = 3 
										group by T.CREDIT_ID) tt on TPC.ID=tt.CREDIT_ID
							left join (	select t.CREDIT_ID,
											sum(t.PAY_MONEY) PAY_MONEY,
											MIN(t.PAY_DATE) PAY_DATE
										from T_SUPL_PLAYDETIL t 
										where BACKSTATE='0' 
											And STATUS = 0
										  	AND (STATE = 0 OR STATE = 1 OR STATE = 3)
										group by T.CREDIT_ID) tt1 on TPC.ID=tt1.CREDIT_ID
							<!-- 拿办事处  -->			
							left join T_USER_USER ttt on  ttt.ID =tpc.SENSOR_ID
					        left join T_DEPT_DEPARTMENT dept on dept.ID = ttt.DEPT_ID
					        left join T_DEPT_COMPANY cmpy on dept.DECP_ID=cmpy.DECP_ID
			        
			                <!-- 拿经办人和主管名字 -->
			                left join T_USER_USER ttt1 on ttt1.ID =tpc.SENSOR_ID
			        		left join T_USER_USER ttt2 on ttt2.ID =ttt1.upper_user
			        		
			        		<!-- 拿需要的拨款金额 -->
			        	    left join T_PRJT_CREDITAPPROPIATE prjt on tpc.ID=prjt.CREDIT_ID AND prjt.status=0 AND prjt.TYPE=1 <!-- type=1 是指交机后的拨款 -->
			        	    
			        	    left join T_PRJT_CREDITAPPROPIATE prjt1 on tpc.ID=prjt1.CREDIT_ID AND prjt1.status=0 AND prjt1.TYPE=0 <!-- type=0 是指交机前的拨款 -->
			        	    
							where  tpc.STATUS=0 AND (tpc.WIND_STATE=1 OR tpc.WIND_STATE=2)
			  				AND (trc.STATUS=0 or trc.STATUS is null ) 
			   				and (tpc.FINANCECONTRACT_DATE is null ) 
						 		<isNotEmpty prepend="and" property="content">
						 			<![CDATA[
									(tpc.LEASE_CODE like '%$content$%'
									or tcc.CUST_NAME like '%$content$%'
									or tpce.BRAND like '%$content$%')  
									]]>
								</isNotEmpty>
							group by TPC.DELAY_PAY_STATUS,cmpy.DECP_ID,cmpy.DECP_NAME_CN,ttt.NAME,ttt2.NAME,tpc.SENSOR_ID,tpc.VALID_DAY,tpc.LEASE_CODE,tcc.CUST_NAME,tcg.GRANT_PRICE,tt.PAY_MONEY,tpcs.LEASE_TOPRIC,tt.PAY_DATE,tpc.wind_result_date,TT1.PAY_MONEY,prjt.APPRORIATEMON,prjt.TYPE,prjt1.APPRORIATEMON,prjt1.TYPE
							) x 
							
							where (x.PAY_MONEY &lt;= 0 or x.PAY_MONEY IS NULL)
							<!-- 增加条件,只遍历已核准日期与当天的差小于有效期时间,
											默认valid_day是90天,也可以通过延长案件有效期来修改valid_day, add by ShenQi 
							     AND DATEDIFF(day,x.wind_result_date,GETDATE()) &lt;= x.VALID_DAY -->
							     
							     AND x.wind_result_date IS NOT NULL
							     <isEqual property="validateStatus" compareValue="N">
							     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) <= x.VALID_DAY ]]>
							     </isEqual>
							     <isEqual property="validateStatus" compareValue="Y">
							     	<![CDATA[ AND DATEDIFF(day,x.wind_result_date,GETDATE()) > x.VALID_DAY ]]>
							     </isEqual>
							     
							     <!-- 2012/05/31 Yang Yun 缓拨状态查询 -->
							     <isEqual property="delayStatus" compareValue="N">
							     	<![CDATA[ AND (x.DELAY_PAY_STATUS IS NULL OR x.DELAY_PAY_STATUS = 0) ]]>
							     </isEqual>
							     <isEqual property="delayStatus" compareValue="Y">
							     	<![CDATA[ AND x.DELAY_PAY_STATUS = -1 ]]>
							     </isEqual>
							     
							     AND x.PAY_DATE IS NULL
							     <!-- 业务员只能看到自己的拨款项,业务员主管能看到自己的及属于自己下面的业务员的拨款信息,经理等能看到所有的 add by ShenQi -->
							      <isEqual prepend="and" property="p_usernode" compareValue="1">
							      	exists(select * from T_USER_USER
										where ID = x.SENSOR_ID
										and (ID = #s_employeeId#
											or upper_user = #s_employeeId#
										)
									)
							  	 </isEqual>
								 <isEqual prepend="and" property="p_usernode" compareValue="2">
										exists(select ID from T_USER_USER
										where DEPT_ID in 
										(select uc.DEPT_ID from dbo.T_USER_USER2COMPANY uc
										where uc.USER_ID = #s_employeeId#)
										and ID = x.SENSOR_ID)
								 </isEqual>
							     <!-- <isEqual property="ROLE" compareValue="1">普通业务员
									     AND EXISTS(
											        SELECT 1 FROM T_USER_USER tuser 
											                WHERE tuser.ID=x.SENSOR_ID
											                  AND tuser.STATUS=0
											                      AND tuser.ID=#s_employeeId#
					        						)
							     </isEqual>
							     <isEqual property="ROLE" compareValue="2">业务员主管
									     AND EXISTS(
											        SELECT 1 FROM T_USER_USER tuser 
											                WHERE tuser.ID=x.SENSOR_ID
											                  AND (tuser.UPPER_USER=#s_employeeId# OR tuser.ID=#s_employeeId#)
							        						)
							     </isEqual>
							     <isEqual property="ROLE" compareValue="3">其他角色,通过所在办事处查看所能看到的人
							             AND x.DECP_ID IN (
												             SELECT DISTINCT dept.DECP_ID 通过员工号拿到所在的办事处
											              	   FROM T_DEPT_DEPARTMENT dept 
												              WHERE dept.ID IN (
												                                 SELECT tu.DEPT_ID 
												                                   FROM T_USER_USER tu 
												                                  WHERE tu.ID=#s_employeeId# AND tu.STATUS=0
								                                 						)
			                                 								)
							     </isEqual> -->
							     <isNotEmpty property="NAME">
							             AND x.NAME LIKE '%$NAME$%'
							     </isNotEmpty>
							     <isNotEmpty property="OFFICE">
							             AND x.DECP_ID=#OFFICE#
							     </isNotEmpty>
	</select>
	
	<select id="queryNotToAllotToExcel" parameterClass="map" resultClass="java.util.HashMap">
	select * from (
		select  tpc.LEASE_CODE,
				tcc.CUST_NAME,
				tpce.BRAND,
				tcg.GRANT_PRICE,
				tt.PAY_MONEY,
				tpcs.LEASE_TOPRIC PAYCOUNT,
				tt.PAY_DATE
				
				from t_prjt_credit tpc

				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID =tpc.CUST_ID
				left join T_PRJT_CREDITEQUIPMENT tpce on tpce.CREDIT_ID = tpc.ID
				left join T_CUST_GRANTPLAN tcg on tcg.CUST_ID = tcc.CUST_ID
				left join T_PRJT_CREDITSCHEME tpcs on tpcs.CREDIT_ID = tpc.ID
				left join T_RENT_CONTRACT trc on trc.PRCD_ID = tpc.ID
				left join (select T.CREDIT_ID,
								  sum(case  when t.STATE=3 then t.PAY_MONEY end) PAY_MONEY,
								  max(t.PAY_DATE) PAY_DATE
								  from T_SUPL_PLAYDETIL t where BACKSTATE='0' and STATUS=0 
								  group by T.CREDIT_ID,t.PAYCOUNT) tt on TPC.ID=tt.CREDIT_ID


				where tpc.STATUS=0 and tpc.STATE=1 and tpc.WIND_STATE=1 
				
				group by tpc.LEASE_CODE,tcc.CUST_NAME,tpce.BRAND,tcg.GRANT_PRICE,tt.PAY_MONEY,tpcs.LEASE_TOPRIC,tt.PAY_DATE
				)x where (x.PAYCOUNT-x.PAY_MONEY)>0 or (x.PAYCOUNT-x.PAY_MONEY) is null
		order by x.LEASE_CODE desc		                                                                             			                                                                                		                                                                                                                                         	
	</select>
	
	<!-- Modify by Michael 2012 3-12 修改数据抓取逻辑 -->
	<select id="queryRealPriceCAIWU" parameterClass="map" resultClass="java.util.HashMap">
	   	<![CDATA[
		   		select t.SQC, t.SQW, t.SQB, t.YZC, t.YZW, t.YZB, t.YJC, t.YJW, t.YJB, t.SYC, t.SYW, t.SYB, t.QIMOJINGZHI, t.PLEDGE_AVE_PRICE, t.PLEDGE_BACK_PRICE, t.PLEDGE_LAST_PRICE, t.CUST_NAME, t.SUPL_NAME, t.LEASE_CODE, t.NAME, t.DECP_NAME_CN, t.CREATE_TIME, t.FINANCE_DATE 
		   		from MONTH_LONGREALPRICE_REPORT t
		   		left join t_prjt_credit tpc on tpc.lease_code = t.lease_code and tpc.status = 0
		   	]]>
		   		<dynamic prepend="where">
			 	<isNotEmpty prepend="and" property="startDate">
			 		<![CDATA[
					(YEAR(t.FINANCE_DATE)=YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					 and 
					 month(t.FINANCE_DATE)=MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
					 )
					]]>
			 	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="content">
			   		(
			   			t.CUST_NAME		LIKE '%$content$%'
			   			OR t.LEASE_CODE		LIKE '%$content$%'
			   			OR t.DECP_NAME_CN	LIKE '%$content$%'
			   			OR t.SUPL_NAME LIKE '%$content$%'
			   			OR t.NAME LIKE '%$content$%'
			   		)
			   	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="companyCode">
					tpc.company_code = #companyCode#
				</isNotEmpty>
		   	</dynamic>	 
	</select>
	<select id="queryRealPriceCAIWU_count" parameterClass="map" resultClass="java.lang.Integer">
	<![CDATA[
		   		select count(*) from MONTH_LONGREALPRICE_REPORT
		   	]]>
		   		<dynamic prepend="where">
			 	<isNotEmpty prepend="and" property="startDate">
			 		<![CDATA[
					(YEAR(FINANCE_DATE)=YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					 and 
					 month(FINANCE_DATE)=MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
					 )
					]]>
			 	</isNotEmpty>
			   	<isNotEmpty prepend="and" property="content">
			   		(
			   			CUST_NAME		LIKE '%$content$%'
			   			OR LEASE_CODE		LIKE '%$content$%'
			   			OR DECP_NAME_CN	LIKE '%$content$%'
			   			OR SUPL_NAME LIKE '%$content$%'
			   			OR NAME LIKE '%$content$%'
			   		)
			   	</isNotEmpty>
		   	</dynamic>	 
	</select>
	
	<select id="checkUserNode" resultClass="java.lang.String">
	       SELECT DISTINCT NODE FROM T_USER_USER WHERE ID=#s_employeeId# AND STATUS=0
	</select>
	
	<select id="checkIsUpperUser" resultClass="java.lang.String">
	       SELECT DISTINCT JOB FROM T_USER_USER WHERE ID=#s_employeeId# AND STATUS=0
	</select>
	
	<!-- ADD BY Michael 2012-3-19 增加 应开发票明细（By月份） -->
	<select id="queryAllInvoiceByMonth" resultClass="java.util.HashMap">
		<![CDATA[
	select RECP_CODE,ttttt.LEASE_CODE,ttttt.CUST_NAME,DECP_NAME_CN,NAME,REN_PRICE,month_price,SUPL_NAME,tcct.CORP_TAX_CODE,CONVERT(VARCHAR(2),month(QI_DATE))+'.'+CONVERT(VARCHAR(2),day(QI_DATE))+'-'+CONVERT(VARCHAR(2),month(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+'.'+CONVERT(VARCHAR(2),day(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+',计税'+CONVERT(VARCHAR(100),CONVERT(decimal(18,2),REN_PRICE)) remark,RECD_ID,RECP_ID from(
		select * from (
		select t2.* 
		from t_prjt_credit t1
		left join
		(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
			0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,CASE 
					WHEN RECP_STATUS = 3  AND 
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							< CONVERT(VARCHAR(7),trcd.finance_date,23)
					THEN 0	
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							> CONVERT(VARCHAR(7),trcd.finance_date,23)			
					then trcd.REN_PRICE
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
						= CONVERT(VARCHAR(7),trcd.finance_date,23)		
					then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						)	
					else
					trcd.REN_PRICE		
				END	 REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,trcd.RECD_ID
		  from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					WHERE	
						trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
						) ttt
				where 1=1 	
				and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
									( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
										AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
		   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
				YEAR(ttt.QI_DATE),
				MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
		) t2
		on	t1.lease_code=t2.LEASE_CODE 
		where t1.STATUS=0 and 
		(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
		OR
		( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
			AND month(t1.FINANCECONTRACT_DATE) < MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
		)ttt
		where ttt.Y=year(#startDate#) and ttt.M=month(#startDate#) 

		)ttttt
		left join
		t_rent_contract trct
		on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
		left join
		T_CUST_CUSTOMER tcct 
		on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0		
		left join t_prjt_credit tpc on tpc.id = trct.prcd_id and tpc.status = 0
		where REN_PRICE>0 
		]]>
		
	<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>
	
	<select id="queryAllInvoiceByMonth_count" resultClass="java.lang.Integer">
		<![CDATA[
		select count(*) from(
		select * from (
		select t2.* 
		from t_prjt_credit t1
		left join
		(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
			0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,CASE 
					WHEN RECP_STATUS = 3  AND 
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							< CONVERT(VARCHAR(7),trcd.finance_date,23)
					THEN 0	
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							> CONVERT(VARCHAR(7),trcd.finance_date,23)			
					then trcd.REN_PRICE
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
						= CONVERT(VARCHAR(7),trcd.finance_date,23)		
					then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						)	
					else
					trcd.REN_PRICE		
				END	 REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,trcd.RECD_ID
		  from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					WHERE	
						trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
						) ttt
				where 1=1 	
				and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
									( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
										AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
		   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
				YEAR(ttt.QI_DATE),
				MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
		) t2
		on	t1.lease_code=t2.LEASE_CODE 
		where t1.STATUS=0 and 
		(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
		OR
		( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
			AND month(t1.FINANCECONTRACT_DATE) < MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
		)ttt
		where ttt.Y=year(#startDate#) and ttt.M=month(#startDate#) 

		)ttttt
		left join
		t_rent_contract trct
		on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
		left join
		T_CUST_CUSTOMER tcct 
		on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
		left join t_prjt_credit tpc on tpc.id = trct.prcd_id and tpc.status = 0
		where REN_PRICE>0 
		]]>
		<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
		</isNotEmpty>
	</select>

	<!-- ADD BY Michael 2012-3-19 增加 应开发票明细（By区间） -->
	<select id="queryAllInvoiceBySection" resultClass="java.util.HashMap">
	<![CDATA[
		select RECP_CODE,ttttt.LEASE_CODE,ttttt.CUST_NAME,DECP_NAME_CN,NAME,REN_PRICE,month_price,SUPL_NAME,tcct.CORP_TAX_CODE,CONVERT(VARCHAR(2),month(QI_DATE))+'.'+CONVERT(VARCHAR(2),day(QI_DATE))+'-'+CONVERT(VARCHAR(2),month(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+'.'+CONVERT(VARCHAR(2),day(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+',计税'+CONVERT(VARCHAR(100),CONVERT(decimal(18,2),REN_PRICE)) remark,RECD_ID from(
		select * from (
		select t2.* 
		from t_prjt_credit t1
		left join
		(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
			0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,CASE 
					WHEN RECP_STATUS = 3  AND 
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							< CONVERT(VARCHAR(7),trcd.finance_date,23)
					THEN 0	
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							> CONVERT(VARCHAR(7),trcd.finance_date,23)			
					then trcd.REN_PRICE
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
						= CONVERT(VARCHAR(7),trcd.finance_date,23)		
					then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						)	
					else
					trcd.REN_PRICE		
				END	 REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,trcd.RECD_ID
		  from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
				WHERE	
					trcd.STATUS = 0 and trcd.isopen is null
					) ttt
				where 1=1 	
				and 
				( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
		    	)				
		   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
				YEAR(ttt.QI_DATE),
				MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
		) t2
		on	t1.lease_code=t2.LEASE_CODE 
		where t1.STATUS=0 and 
		(year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
		AND month(t1.FINANCECONTRACT_DATE) = MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
		AND day(t1.FINANCECONTRACT_DATE) >= day(convert(DATE,convert(varchar,#startDate#, 23))) 
		AND day(t1.FINANCECONTRACT_DATE) <= day(convert(DATE,convert(varchar,#endDate#, 23))) 
		)
		)ttt
		where ttt.Y=year(#startDate#)	and ttt.M=month(#startDate#)
		union all
		select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
			0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,
				T10.FINANCECONTRACT_DATE
				from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
				WHERE	
				trcd.STATUS = 0 
				) ttt
			where 1=1 
		and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
		and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=month(#startDate#) 
		     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
		ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE	
		)ttttt
		left join
		t_rent_contract trct
		on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
		left join
		T_CUST_CUSTOMER tcct 
		on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
		where REN_PRICE>0
	]]>
	</select>

<select id="queryAllInvoiceBySection_count" resultClass="java.util.HashMap">
	<![CDATA[
		select count(*) from(
		select * from (
		select t2.* 
		from t_prjt_credit t1
		left join
		(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
			0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,CASE 
					WHEN RECP_STATUS = 3  AND 
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							< CONVERT(VARCHAR(7),trcd.finance_date,23)
					THEN 0	
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
							> CONVERT(VARCHAR(7),trcd.finance_date,23)			
					then trcd.REN_PRICE
					when RECP_STATUS = 3  AND
						(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						) 
						= CONVERT(VARCHAR(7),trcd.finance_date,23)		
					then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
						FROM T_RENT_SETTLE trst
						WHERE STATUS=0 
							AND RECP_ID = trcp.RECP_ID
						GROUP BY trst.RECP_ID
						)	
					else
					trcd.REN_PRICE		
				END	 REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,trcd.RECD_ID
		  from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
				WHERE	
					trcd.STATUS = 0 and trcd.isopen is null
					) ttt
				where 1=1 	
				and 
				( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
					AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
		    	)				
		   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
				YEAR(ttt.QI_DATE),
				MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
		) t2
		on	t1.lease_code=t2.LEASE_CODE 
		where t1.STATUS=0 and 
		(year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							
		AND month(t1.FINANCECONTRACT_DATE) = MONTH(convert(DATE,convert(varchar,#startDate#, 23))) 
		AND day(t1.FINANCECONTRACT_DATE) >= day(convert(DATE,convert(varchar,#startDate#, 23))) 
		AND day(t1.FINANCECONTRACT_DATE) <= day(convert(DATE,convert(varchar,#endDate#, 23))) 
		)
		)ttt
		where ttt.Y=year(#startDate#)	and ttt.M=month(#startDate#)
		union all
		select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
			0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE
			from
				(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
				DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
				0 CAI,REN_PRICE,MONTH_PRICE,
				trcd.finance_date QI_DATE,
				T10.FINANCECONTRACT_DATE
				from T_RENT_COLLECTIONDETAIL trcd
				left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
				left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
				left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
				LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
				LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
				LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
				LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
				LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
				LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
				LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
				WHERE	
				trcd.STATUS = 0 
				) ttt
			where 1=1 
		and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
		and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=month(#startDate#) 
		     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
				ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
		ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE	
		)ttttt
		left join
		t_rent_contract trct
		on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
		left join
		T_CUST_CUSTOMER tcct 
		on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
		where REN_PRICE>0
	]]>
	</select>
	
	<!-- ADD BY Michael 2012-3-19 增加 保险费余额变动表 -->
	<select id="queryInsuranceDynamic" resultClass="java.util.HashMap">
	<![CDATA[	
		select t.* 
		from MONTH_INSURANCEDYNAMIC_REPORT t
		left join t_prjt_credit tpc on tpc.lease_code = t.recp_code and tpc.status = 0
		where year(t.FINANCE_DATE)=year(#startDate#) and month(t.FINANCE_DATE) = month(#startDate#) 
	]]>
	<isNotEmpty prepend="and" property="content">
 			<![CDATA[
			( CUST_NAME like '%$content$%'
			OR NAME like '%$content$%'
			OR DECP_NAME_CN like '%$content$%'
			OR NAME  like '%$content$%'
			OR RECP_CODE like '%$content$%')  
			]]>
	</isNotEmpty> 
	<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>
	
	
<!-- ADD BY Michael 2012-3-19 增加 保险费余额变动表 -->
	<select id="queryInsuranceDynamic_count" resultClass="java.lang.Integer">
	<![CDATA[	
		select count(0) 
		from MONTH_INSURANCEDYNAMIC_REPORT t
		left join t_prjt_credit tpc on tpc.lease_code = t.recp_code and tpc.status = 0
		where year(t.FINANCE_DATE)=year(#startDate#) and month(t.FINANCE_DATE) = month(#startDate#) 
	]]>
	<isNotEmpty prepend="and" property="content">
 			<![CDATA[
			( CUST_NAME like '%$content$%'
			OR NAME like '%$content$%'
			OR DECP_NAME_CN like '%$content$%'
			OR NAME  like '%$content$%'
			OR RECP_CODE like '%$content$%')  
			]]>
	</isNotEmpty> 
	<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>	
		<!-- 留购款营业税 -->
	<!-- Add by Michael 2012 4-5增加留购款、罚息营业税  -->
	<select id="queryStayBuyPriceTax" parameterClass="map" resultClass="java.util.HashMap">
			<!-- select CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE) YYshuie,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FBuildTax) CJshuie,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FEduAmount) JYshuie,
			convert(decimal(18,2),REAL_PRICE* SALES_TAX_RATE_ALONE) + convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FBuildTax) + convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FEduAmount) xiaoji   
			from( 
			select 	CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,		 
			(	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE='1'
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE='1'
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE='1'
					) FEduAmount from (			
			select convert(decimal(18,2),t1.REAL_PRICE) REAL_PRICE,t1.FICB_ITEM,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME ,t10.FINANCECONTRACT_DATE,tcc.CORP_TAX_CODE from 
			MONTH_DECOMPOSE_REPORT t1 	
			left join T_FINA_INCOME t2 on t1.FIIN_ID=t2.FIIN_ID
			left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = t3.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			where (t1.FICB_ITEM = '结清留购价' or t1.FICB_ITEM = '设备留购价' or t1.FICB_ITEM = '租金罚息' or t1.FICB_ITEM='结清罚息' )
			and t3.TAX_PLAN_CODE='1'
			and CONVERT(DATE,t1.FINANCE_DATE) BETWEEN CONVERT(DATE,#startTime#) AND CONVERT(DATE,#endTime#)
			) tt				
			) ttt -->
			select CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,(SELECT FLAG FROM T_DATA_DICTIONARY WHERE CODE=FICB_ITEM) FICB_ITEM,CORP_TAX_CODE,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE) YYshuie,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FBuildTax) CJshuie,
			convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FEduAmount) JYshuie,
			convert(decimal(18,2),REAL_PRICE* SALES_TAX_RATE_ALONE) 
      + convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FBuildTax) 
      + convert(decimal(18,2),REAL_PRICE * SALES_TAX_RATE_ALONE * FEduAmount) xiaoji   
			from( 
			select 	CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,		 
			(	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE='1'
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE='1'
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE='1'
					) FEduAmount from (			
			select convert(decimal(18,2),t1.DECOMPOSE_PRICE ) REAL_PRICE,t1.BILL_CODE FICB_ITEM,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME ,t10.FINANCECONTRACT_DATE,tcc.CORP_TAX_CODE from 
			 T_DECOMPOSE_DAILY_REPORT t1 	
			left join  T_RENT_INCOME t2 on t1.INCOME_ID = t2.INCOME_ID 
			left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = t3.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			where (t1.BILL_CODE = 'STAY_BUY_PRICE' or t1.BILL_CODE = 'RENT_FINE' or t1.BILL_CODE = 'SETTLEMENT_RENT_FINE' or t1.BILL_CODE='SETTLEMENT_STAY_PRICE' )
			and t3.TAX_PLAN_CODE='1'
			and t1.FINANCE_DATE=#FINANCE_DATE#
      AND T1.STATUS=0
			) tt				
			) ttt
	</select>	
		<!-- 留购款增值税 -->
	<!-- Add by Michael 2012 4-5增加留购款、罚息增值税  -->
	<select id="queryStayBuyPriceValueAddTax" parameterClass="map" resultClass="java.util.HashMap">
			<!-- select CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE)) REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) YYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) CJshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) JYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) xiaoji   
			from( 
			select 	CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,		 
			(	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FEduAmount from (			
			select convert(decimal(18,2),t1.REAL_PRICE) REAL_PRICE,t1.FICB_ITEM,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME ,t10.FINANCECONTRACT_DATE,tcc.CORP_TAX_CODE, t3.TAX_PLAN_CODE from 
			MONTH_DECOMPOSE_REPORT t1 	
			left join T_FINA_INCOME t2 on t1.FIIN_ID=t2.FIIN_ID
			left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = t3.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			where (t1.FICB_ITEM = '结清留购价' or t1.FICB_ITEM = '设备留购价' or t1.FICB_ITEM = '租金罚息' or t1.FICB_ITEM='结清罚息' )
			and t3.TAX_PLAN_CODE='2'
			and CONVERT(DATE,t1.FINANCE_DATE) BETWEEN CONVERT(DATE,#startTime#) AND CONVERT(DATE,#endTime#)
			) tt				
			) ttt -->
			select CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE)) REAL_PRICE,LINK_WORK_ADDRESS+'  '+convert(varchar,LINK_PHONE) LINK_ADDRESS,BANK_NAME+BANK_ACCOUNT BANK_NAME,
(SELECT FLAG FROM T_DATA_DICTIONARY WHERE CODE=FICB_ITEM) FICB_ITEM,CORP_TAX_CODE,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) YYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) CJshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) JYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) xiaoji   
			from( 
			select 	CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,		 
			(	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) &lt;= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FEduAmount from (			
			select convert(decimal(18,2),t1.DECOMPOSE_PRICE) REAL_PRICE,t1.BILL_CODE FICB_ITEM,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME ,t10.FINANCECONTRACT_DATE,tcc.CORP_TAX_CODE, t3.TAX_PLAN_CODE,
      tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,tpcc.TELEPHONE LINK_PHONE
      from 
		  T_DECOMPOSE_DAILY_REPORT t1 	
			left join T_RENT_INCOME t2 on t1.INCOME_ID=t2.INCOME_ID
			left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = t3.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
      LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCC ON T10.ID=TPCC.CREDIT_ID AND TPCC.STATUS=0
      LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCB ON T10.ID=TPCB.CREDIT_ID AND TPCB.STATUS=0
			where (t1.BILL_CODE = 'SETTLEMENT_STAY_PRICE' or t1.BILL_CODE = 'STAY_BUY_PRICE' or t1.BILL_CODE = 'RENT_FINE' or t1.BILL_CODE='SETTLEMENT_RENT_FINE' )
			and t3.TAX_PLAN_CODE='2'
			and t1.FINANCE_DATE=#FINANCE_DATE#
			
			<isNotEmpty prepend="and" property="companyCode">
				T10.company_code = #companyCode#
			</isNotEmpty>
			) tt				
			) ttt
	</select>	
	<select id="queryManageFeeValueTax" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
			select CUST_NAME,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE)) REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,
			LINK_WORK_ADDRESS+'  '+convert(varchar,LINK_PHONE) LINK_ADDRESS,BANK_NAME+BANK_ACCOUNT BANK_NAME,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) YYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) CJshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) JYshuie,
			convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FBuildTax) + convert(decimal(18,2),REAL_PRICE/(1+SALES_TAX_RATE_ALONE) * SALES_TAX_RATE_ALONE * FEduAmount) xiaoji,FLAG,    
			express,express_pay_way
			from( 
				select 	CUST_NAME,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REAL_PRICE,FICB_ITEM,CORP_TAX_CODE,	
				BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,	 
				(	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'MANAGE_FEE_RATE' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),FINANCECONTRACT_DATE,23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE=tt.TAX_PLAN_CODE
					) FEduAmount,FINANCECONTRACT_DATE,FLAG,tt.express,tt.express_pay_way
			from (			
			select t1.FICB_ITEM,tcc.CUST_NAME,trc.LEASE_CODE,tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,tpcc.TELEPHONE LINK_PHONE,
			tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE as LPHONE,
			DECP.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME ,t10.FINANCECONTRACT_DATE,tcc.CORP_TAX_CODE,
			convert(decimal(18,2),t1.REAL_PRICE)  REAL_PRICE ,t3.TAX_PLAN_CODE,tdd.FLAG,
			tsp.express,tsp.express_pay_way
			from (select sum(-DECOMPOSE_PRICE) real_price,RECP_ID,(SELECT FLAG FROM T_DATA_DICTIONARY WHERE CODE=BILL_CODE) FICB_ITEM,INCOME_ID  from T_RENT_DECOMPOSE 
			where 
			year( AUDIT_TIME)<#year# or (year(AUDIT_TIME)=#year# and CONVERT(DATE,AUDIT_TIME) BETWEEN CONVERT(DATE,#beginTime#) AND CONVERT(DATE,#endTime#))
			and  DECOMPOSE_STATUS=2
			group by RECP_ID,BILL_CODE,INCOME_ID) T1 
			left join T_RENT_INCOME t2 on t1.INCOME_ID=t2.INCOME_ID
			left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			left join T_CUST_LINKMAN tcl on tcl.cust_id = trc.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = t3.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCC ON T10.ID=TPCC.CREDIT_ID AND TPCC.STATUS=0
      		LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCB ON T10.ID=TPCB.CREDIT_ID AND TPCB.STATUS=0
	      	LEFT JOIN T_SUPL_PLAYDETIL tsp ON tsp.STATUS=0 AND tsp.PAY_ORDER=1 AND tsp.CREDIT_ID=T10.ID 
	      	left join t_rent_contract_feelist trcf on trcf.rect_id = trc.RECT_ID and trcf.CREATE_SHOW_NAME=t1.FICB_ITEM
      		left join T_DATA_DICTIONARY tdd on trcf.SOURCE_CODE=tdd.CODE and tdd.[TYPE]='费用来源'
			where (t1.FICB_ITEM like'管理费%' or t1.FICB_ITEM='家訪費收入' or t1.FICB_ITEM='其他費用收入') and t3.TAX_PLAN_CODE='2'
			]]>
			<isNotEmpty prepend="and" property="companyCode">
				T10.company_code = #companyCode#
			</isNotEmpty>
			<![CDATA[
			) tt
			where (CONVERT(DATE,FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#beginTime#) AND CONVERT(DATE,#endTime#))	
			) ttt
		]]>
	</select>
	
	<!-- Add by Michael 2012 4-19 导出开票资料By月  -->
	<select id="exportOpenInvoiceByMonth_count" parameterClass="map" resultClass="java.lang.Integer">
	<![CDATA[
	select count(*) from(
	select * from (
	select t2.* 
	from t_prjt_credit t1
	left join
	(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
		0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE
		from
			(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
			0 CAI,CASE 
				WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						< CONVERT(VARCHAR(7),trcd.finance_date,23)
				THEN 0	
				when RECP_STATUS = 3  AND
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						> CONVERT(VARCHAR(7),trcd.finance_date,23)			
				then trcd.REN_PRICE
				when RECP_STATUS = 3  AND
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
					= CONVERT(VARCHAR(7),trcd.finance_date,23)		
				then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					)	
				else
				trcd.REN_PRICE		
			END	 REN_PRICE,MONTH_PRICE,
			trcd.finance_date QI_DATE
	  from T_RENT_COLLECTIONDETAIL trcd
			left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
						WHERE	
							trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
							) ttt
			where 1=1 	
			and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
	   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
			YEAR(ttt.QI_DATE),
			MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE
	) t2
	on	t1.lease_code=t2.LEASE_CODE 
	where t1.STATUS=0 and 
	(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND month(t1.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
	)ttt
	where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#)
	union all
	select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
	0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		WHERE	
		trcd.STATUS = 0 and trcp.TAX_PLAN_CODE='1'
		) ttt
	where 1=1 
	and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
	and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=MONTH(#startDate#) 
	     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
	ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE	
	)ttttt
	left join
	t_rent_contract trct
	on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
	left join
	T_CUST_CUSTOMER tcct 
	on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
	where REN_PRICE>0
]]>	
	</select>	
		<!-- Add by Michael 2012 4-19 导出开票资料By月  -->
	<select id="exportOpenInvoiceByMonth" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[
	select RECP_ID,RECP_CODE,ttttt.LEASE_CODE,ttttt.CUST_NAME,DECP_NAME_CN,NAME,REN_PRICE,month_price,SUPL_NAME,tcct.CORP_TAX_CODE,CONVERT(VARCHAR(2),month(QI_DATE))+'.'+CONVERT(VARCHAR(2),day(QI_DATE))+'-'+CONVERT(VARCHAR(2),month(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+'.'+CONVERT(VARCHAR(2),day(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+',计税'+CONVERT(VARCHAR(100),CONVERT(decimal(18,2),REN_PRICE)) remark,RECD_ID from(
	select * from (
	select t2.* 
	from t_prjt_credit t1
	left join
	(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
		0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
		from
			(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
			DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
			0 CAI,CASE 
				WHEN RECP_STATUS = 3  AND 
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						< CONVERT(VARCHAR(7),trcd.finance_date,23)
				THEN 0	
				when RECP_STATUS = 3  AND
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
						> CONVERT(VARCHAR(7),trcd.finance_date,23)			
				then trcd.REN_PRICE
				when RECP_STATUS = 3  AND
					(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					) 
					= CONVERT(VARCHAR(7),trcd.finance_date,23)		
				then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
					FROM T_RENT_SETTLE trst
					WHERE STATUS=0 
						AND RECP_ID = trcp.RECP_ID
					GROUP BY trst.RECP_ID
					)	
				else
				trcd.REN_PRICE		
			END	 REN_PRICE,MONTH_PRICE,
			trcd.finance_date QI_DATE,trcd.RECD_ID
	  from T_RENT_COLLECTIONDETAIL trcd
			left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
			LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
			LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
			LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
			LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
			LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
						WHERE	
							trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
							) ttt
			where 1=1 	
			and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
	   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
			YEAR(ttt.QI_DATE),
			MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
	) t2
	on	t1.lease_code=t2.LEASE_CODE 
	where t1.STATUS=0 and 
	(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND month(t1.FINANCECONTRACT_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
	)ttt
	where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#)
	union all
	select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
	0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE,RECD_ID
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE,trcd.RECD_ID
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		WHERE	
		trcd.STATUS = 0  and trcp.TAX_PLAN_CODE='1'
		) ttt
	where 1=1 
	and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
	and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=MONTH(#startDate#) 
	     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
	ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE,ttt.RECD_ID	
	)ttttt
	left join
	t_rent_contract trct
	on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
	left join
	T_CUST_CUSTOMER tcct 
	on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
	left join t_prjt_credit tpc on tpc.id = trct.prcd_id and tpc.status = 0
	where REN_PRICE>0
	
]]>
	<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>

	<!-- Add by Michael 2012 4-19 导出开票资料By日  -->
	<select id="exportOpenInvoiceByDay_count" parameterClass="map" resultClass="java.lang.Integer">
	<![CDATA[
select count(*) from(
select * from (
select t2.* 
from t_prjt_credit t1
left join
(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
	0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,CASE 
			WHEN RECP_STATUS = 3  AND 
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
					< CONVERT(VARCHAR(7),trcd.finance_date,23)
			THEN 0	
			when RECP_STATUS = 3  AND
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
					> CONVERT(VARCHAR(7),trcd.finance_date,23)			
			then trcd.REN_PRICE
			when RECP_STATUS = 3  AND
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
				= CONVERT(VARCHAR(7),trcd.finance_date,23)		
			then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				)	
			else
			trcd.REN_PRICE		
		END	 REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE
  from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		WHERE	
			trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
			) ttt
		where 1=1 	
		and (
		( 	QI_DATE >= convert(DATE,convert(varchar,#startDate#, 23))
			AND QI_DATE <= convert(DATE,convert(varchar,#endDate#, 23)) ))				
   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
		ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
		YEAR(ttt.QI_DATE),
		MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE
) t2
on	t1.lease_code=t2.LEASE_CODE 
where t1.STATUS=0 and 
(
( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
	AND month(t1.FINANCECONTRACT_DATE) = MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
)ttt
where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#) 
union all
select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
	0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		WHERE	
		trcd.STATUS = 0 and trcp.TAX_PLAN_CODE='1'
		) ttt
	where 1=1 
	and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
	and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=MONTH(#startDate#)  
	     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
	ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE	
	)ttttt
	left join
	t_rent_contract trct
	on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
	left join
	T_CUST_CUSTOMER tcct 
	on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
	left join t_prjt_credit tpc on tpc.id = trct.prcd_id and tpc.status = 0
	where REN_PRICE>0		
	]]>
		<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>
	
	<!-- Add by Michael 2012 4-19 导出开票资料By日  -->
	<select id="exportOpenInvoiceByDay" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[
select RECP_ID,RECP_CODE,ttttt.LEASE_CODE,ttttt.CUST_NAME,DECP_NAME_CN,NAME,REN_PRICE,month_price,SUPL_NAME,tcct.CORP_TAX_CODE,CONVERT(VARCHAR(2),month(QI_DATE))+'.'+CONVERT(VARCHAR(2),day(QI_DATE))+'-'+CONVERT(VARCHAR(2),month(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+'.'+CONVERT(VARCHAR(2),day(DATEADD(day,-1,DATEADD(mm,1,QI_DATE))))+',计税'+CONVERT(VARCHAR(100),CONVERT(decimal(18,2),REN_PRICE)) remark,RECD_ID from(
select * from (
select t2.* 
from t_prjt_credit t1
left join
(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
	0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,CASE 
			WHEN RECP_STATUS = 3  AND 
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
					< CONVERT(VARCHAR(7),trcd.finance_date,23)
			THEN 0	
			when RECP_STATUS = 3  AND
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
					> CONVERT(VARCHAR(7),trcd.finance_date,23)			
			then trcd.REN_PRICE
			when RECP_STATUS = 3  AND
				(SELECT CONVERT(VARCHAR(7),MAX(CREATE_DATE),23)
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				) 
				= CONVERT(VARCHAR(7),trcd.finance_date,23)		
			then (SELECT SUM(REAL_REN_PRICE) REAL_REN_PRICE
				FROM T_RENT_SETTLE trst
				WHERE STATUS=0 
					AND RECP_ID = trcp.RECP_ID
				GROUP BY trst.RECP_ID
				)	
			else
			trcd.REN_PRICE		
		END	 REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,trcd.RECD_ID
  from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					WHERE	
						trcd.STATUS = 0 and trcd.isopen is null and trcp.TAX_PLAN_CODE='1'
						) ttt
		where 1=1 	
		and (
		( 	year(QI_DATE) = year(convert(DATE,convert(varchar,#startDate#, 23)))
			AND MONTH(QI_DATE) = MONTH(convert(DATE,convert(varchar,#startDate#, 23))) )
		)				
   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
		ttt.DECP_NAME_CN,ttt.NAME,ttt.PERIOD_NUM,ttt.NAME,		
		YEAR(ttt.QI_DATE),
		MONTH(ttt.QI_DATE),ttt.SUPL_NAME,MONTH_PRICE,ttt.RECD_ID
) t2
on	t1.lease_code=t2.LEASE_CODE 
where t1.STATUS=0 and 
(
( 	t1.FINANCECONTRACT_DATE >= convert(DATE,convert(varchar,#startDate#, 23))
	AND t1.FINANCECONTRACT_DATE <= convert(DATE,convert(varchar,#endDate#, 23))) 
)
)ttt
where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#) 
union all
select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
	0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE,RECD_ID
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		DECP.DECP_NAME_CN,tuser.NAME,trcd.PERIOD_NUM,T9.NAME SUPL_NAME,
		0 CAI,REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE,trcd.RECD_ID
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = trc.DECP_ID AND DECP.STATUS = 0
		LEFT JOIN T_USER_USER tuser on tuser.ID = trc.CLERK_ID
		LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
		LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
		LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
		LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		WHERE	
		trcd.STATUS = 0 and trcp.TAX_PLAN_CODE='1'
		) ttt
	where 1=1 
	and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
	and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=MONTH(#startDate#)  
	     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.DECP_NAME_CN,ttt.NAME,MONTH_PRICE,	
	ttt.SUPL_NAME,ttt.FINANCECONTRACT_DATE,ttt.RECD_ID
	)ttttt
	left join
	t_rent_contract trct
	on ttttt.LEASE_CODE=trct.LEASE_CODE and trct.STATUS=0
	left join
	T_CUST_CUSTOMER tcct 
	on tcct.CUST_ID=trct.CUST_ID and tcct.STATUS=0
	left join t_prjt_credit tpc on tpc.id = trct.prcd_id and tpc.status = 0
	where REN_PRICE>0	
	]]>
	<isNotEmpty prepend="and" property="companyCode">
		tpc.company_code = #companyCode#
	</isNotEmpty>
	</select>

<!-- Add by Michael 2012 10-26 导出增值税开票资料 新案 -->
	<select id="exportValueAddTaxByDay" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
select RECD_ID,RECP_ID,RUNNUM,LINK_WORK_ADDRESS+'  '+convert(varchar,LINK_PHONE) LINK_ADDRESS,CORP_TAX_CODE,BANK_NAME+BANK_ACCOUNT BANK_NAME,CUST_NAME,'租赁费' As PRODUCT_NAME,'' As PRODUCT_KIND,''AS UNIT,1 AS NUMBER,'' As UNIT_PRICE,REN_PRICE,0.17 As TAX_RATE,RUNNUM AS REMARK1,'' As REMARK2 
,OWN_PRICE,CASE WHEN SUBSTRING(RUNNUM,LEN(RUNNUM),LEN(RUNNUM))=1 THEN 
(SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=tttt.RECP_ID)
ELSE 0 END PLEDGE_PRICE,#taxPlanCode# TAX_PLAN_CODE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,express,express_pay_way
from(
select * from (
select t2.* 
from t_prjt_credit t1
left join
(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
	0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,PERIOD_NUM,LEASE_CODE+'-'+convert(varchar,PERIOD_NUM) RUNNUM,CORP_TAX_CODE
	,SUM(ttt.OWN_PRICE) OWN_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.express,ttt.express_pay_way
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		trcd.PERIOD_NUM,
		0 CAI,trcd.REN_PRICE,
		MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE,trcd.RECD_ID,tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,
		tpcc.TELEPHONE LINK_PHONE,tcc.CORP_TAX_CODE,trcd.OWN_PRICE,
		tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE,
		TT.express,TT.express_pay_way
  		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		LEFT JOIN T_SUPL_PLAYDETIL TT ON TT.STATUS=0 AND TT.PAY_ORDER=1 AND TT.CREDIT_ID=T10.ID
		left join t_prjt_creditcorpbankaccount tpcb  on t10.ID=tpcb.CREDIT_ID and tpcb.status=0 and tpcb.state='0'
		left join T_PRJT_CREDITCUSTOMERCORP tpcc on tpcc.credit_id=t10.id and tpcc.status=0
		left join T_CUST_LINKMAN tcl on tcl.cust_id = trc.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0
		WHERE	
			trcd.STATUS = 0 and trcd.isopen is null and (trcp.TAX_PLAN_CODE=#taxPlanCode#)
			]]>
			
			<isNotEmpty prepend="and" property="companyCode">
				T10.company_code = #companyCode#
			</isNotEmpty>
			<![CDATA[
			) ttt
		where 1=1 	
		and (
		( 	year(QI_DATE) = year(convert(DATE,convert(varchar,#startDate#, 23)))
			AND MONTH(QI_DATE) = MONTH(convert(DATE,convert(varchar,#startDate#, 23))) )
		)				
   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
		ttt.PERIOD_NUM,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,		
		YEAR(ttt.QI_DATE),
		MONTH(ttt.QI_DATE),MONTH_PRICE,ttt.RECD_ID,CORP_TAX_CODE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.express,ttt.express_pay_way
) t2
on	t1.lease_code=t2.LEASE_CODE 
where t1.STATUS=0 and 
(
( 	t1.FINANCECONTRACT_DATE >= convert(DATE,convert(varchar,#startDate#, 23))
	AND t1.FINANCECONTRACT_DATE <= convert(DATE,convert(varchar,#endDate#, 23))) 
)
)ttt
where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#) 
union all
select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,max(YEAR(QI_DATE)) Y,max(MONTH(QI_DATE)) M,
	0 CAI,SUM(ttt.REN_PRICE) ren_price,MONTH_PRICE,MAX(QI_DATE) QI_DATE,RECD_ID,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,PERIOD_NUM,LEASE_CODE+'-'+convert(varchar,PERIOD_NUM) RUNNUM,CORP_TAX_CODE
	,SUM(ttt.OWN_PRICE) OWN_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,express,express_pay_way
	from
		(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
		trcd.PERIOD_NUM,
		0 CAI,trcd.REN_PRICE,MONTH_PRICE,
		trcd.finance_date QI_DATE,
		T10.FINANCECONTRACT_DATE,trcd.RECD_ID,tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,
		tpcc.TELEPHONE LINK_PHONE,tcc.CORP_TAX_CODE,trcd.OWN_PRICE,
		tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE as LPHONE,
		TT.express,TT.express_pay_way
		from T_RENT_COLLECTIONDETAIL trcd
		left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
		LEFT JOIN T_SUPL_PLAYDETIL TT ON TT.STATUS=0 AND TT.PAY_ORDER=1 AND TT.CREDIT_ID=T10.ID
		left join t_prjt_creditcorpbankaccount tpcb  on t10.ID=tpcb.CREDIT_ID and tpcb.status=0 and tpcb.state='0'
		left join T_PRJT_CREDITCUSTOMERCORP tpcc on tpcc.credit_id=t10.id and tpcc.status=0
		left join T_CUST_LINKMAN tcl on tcl.cust_id = trc.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0
		WHERE	
		trcd.STATUS = 0 and (trcp.TAX_PLAN_CODE=#taxPlanCode#) and trcd.isopen is null
					]]>
			
			<isNotEmpty prepend="and" property="companyCode">
				T10.company_code = #companyCode#
			</isNotEmpty>
			<![CDATA[
		) ttt
	where 1=1 
	and convert(date,convert(varchar,(year(QI_DATE)))+'-'+convert(varchar,(MONTH(QI_DATE)))+'-01')<convert(date,convert(varchar,(year(FINANCECONTRACT_DATE)))+'-'+convert(varchar,(MONTH(FINANCECONTRACT_DATE)))+'-01')
	and year(ttt.FINANCECONTRACT_DATE)=year(#startDate#) and MONTH(ttt.FINANCECONTRACT_DATE)=MONTH(#startDate#)    
	     group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,PERIOD_NUM,
			MONTH_PRICE,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,		
			ttt.FINANCECONTRACT_DATE,ttt.RECD_ID,CORP_TAX_CODE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.express,ttt.express_pay_way
	)tttt
where REN_PRICE>0
		]]>
	</select>
	
	<!-- Add by Michael 2012 5-14  导出历史销账日报表（现金销账）  -->
	<select id="getHistoryDailyDecomposeCashReport" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
			select OPPOSING_DATE,CUST_NAME,CUST_CODE,LEASE_CODE,FICB_ITEM,REAL_PRICE,BANK_NAME from DAILY_DECOMPOSE_REPORT
			where FINANCE_TYPE=0
			and convert(date,CREATE_TIME,23) between '$query_date$' and '$query_date$'
			order by LEASE_CODE
		]]>
	</select>

<!-- Add by Michael 2012 10-26 导出增值税开票资料 旧案 2958-->
	<select id="exportValueAddTaxByMonth" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
		select RECD_ID,RECP_ID,RUNNUM,ONEBARCODE,LINK_WORK_ADDRESS+'  '+convert(varchar,LINK_PHONE) LINK_ADDRESS,CORP_TAX_CODE,BANK_NAME+BANK_ACCOUNT BANK_NAME,CUST_NAME,'租赁费' As PRODUCT_NAME,'' As PRODUCT_KIND,''AS UNIT,1 AS NUMBER,'' As UNIT_PRICE,REN_PRICE,0.17 As TAX_RATE,RUNNUM AS REMARK1,'' As REMARK2 
		,#taxPlanCode# TAX_PLAN_CODE,
		OWN_PRICE,CASE WHEN SUBSTRING(RUNNUM,LEN(RUNNUM),LEN(RUNNUM))=1 AND LEN(RUNNUM)=16 THEN 
					(SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=tttt.RECP_ID)
					ELSE 0 END PLEDGE_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,DECP_NAME_CN,TTTT.PAY_DATE,TTTT.isPay,TTTT.PERIOD_NUM,TTTT.express,TTTT.express_pay_way
		from(
select * from (
	select t2.*,DECP.DECP_NAME_CN
	from t_prjt_credit t1
	left join t_user_user tuu2 on tuu2.id = t1.sensor_id
	left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0
	left join
	(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
		0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,PERIOD_NUM,LEASE_CODE+'-'+convert(varchar,PERIOD_NUM) RUNNUM,RECP_CODE+'-'+CONVERT(VARCHAR,PERIOD_NUM) ONEBARCODE,CORP_TAX_CODE
		,SUM(ttt.OWN_PRICE) OWN_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.PAY_DATE,ttt.isPay,ttt.express,ttt.express_pay_way
		from
			(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,TT.PAY_DATE,
			trcd.PERIOD_NUM,
			0 CAI,
			trcd.REN_PRICE
			,MONTH_PRICE,
			trcd.finance_date QI_DATE,		
			T10.FINANCECONTRACT_DATE,trcd.RECD_ID,tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,
			tpcc.TELEPHONE LINK_PHONE,tcc.CORP_TAX_CODE,trcd.OWN_PRICE,
			tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE
			  ,(case when   trcd.REDUCE_OWN_PRICE = trcd.IRR_MONTH_PRICE then 1 else  	0  end) isPay,TT.express,TT.express_pay_way
		  	from T_RENT_COLLECTIONDETAIL trcd
			left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			left join t_prjt_creditcorpbankaccount tpcb  on t10.ID=tpcb.CREDIT_ID and tpcb.status=0 and tpcb.state='0'
			left join T_PRJT_CREDITCUSTOMERCORP tpcc on tpcc.credit_id=t10.id and tpcc.status=0
			left join T_CUST_LINKMAN tcl on tcl.cust_id = trc.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0
			LEFT JOIN T_SUPL_PLAYDETIL TT ON TT.STATUS=0 AND TT.PAY_ORDER=1 AND TT.CREDIT_ID=trc.PRCD_ID
						WHERE	
							trcd.STATUS = 0  and trcd.isopen is null
							 
							 and (trcp.TAX_PLAN_CODE=#taxPlanCode#)
			]]>
							<isNotEmpty prepend="and" property="companyCode">
								T10.company_code = #companyCode#
							</isNotEmpty>
			<![CDATA[
							) ttt
			where 1=1 	
			

			and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
	   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.PERIOD_NUM,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,	CORP_TAX_CODE,	
			YEAR(ttt.QI_DATE),
			MONTH(ttt.QI_DATE),MONTH_PRICE,ttt.RECD_ID,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.PAY_DATE,ttt.isPay,ttt.express,ttt.express_pay_way
	) t2
	on	t1.lease_code=t2.LEASE_CODE 
	where t1.STATUS=0 and 
	(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
	( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
		AND month(t1.FINANCECONTRACT_DATE) < MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
	)ttt
	where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#)
) TTTT
where REN_PRICE >0
		]]>
		<isNotEmpty property="orderColumn">
		order by $orderColumn$
		</isNotEmpty>
	</select>	
		<!-- Add by Michael 2012 5-14  导出历史销账日报表（暂存款销账）  -->
	<select id="getHistoryDailyDecomposeLastReport" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
			select OPPOSING_DATE,CUST_NAME,CUST_CODE,LEASE_CODE,FICB_ITEM,REAL_PRICE,BANK_NAME from DAILY_DECOMPOSE_REPORT
			where FINANCE_TYPE=1
			and convert(date,CREATE_TIME,23) between '$query_date$' and '$query_date$'
			order by LEASE_CODE
		]]>
	</select>

		<!-- Add by Michael 2012 5-14  导出历史销账日报表（暂收款余额变动表）  -->
	<select id="getHistoryDailyDecomposeDynamicReport" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
			select OPPOSING_DATE,OPPOSING_UNIT,INCOME_MONEY,CURRENT_NEW,CURRENT_REDUCE,BANK_NAME from DAILY_DYNAMICDECOMPOSE_REPORT
			where convert(date,CREATE_TIME,23) between '$query_date$' and '$query_date$'
		]]>
	</select>
	
	<update id="delayPay" parameterClass="map">
			UPDATE T_PRJT_CREDIT SET DELAY_PAY_STATUS=-1 WHERE ID=#CREDIT_ID# AND STATUS=0
	</update>
	<update id="enablePay" parameterClass="map">
			UPDATE T_PRJT_CREDIT SET DELAY_PAY_STATUS=0 WHERE ID=#CREDIT_ID# AND STATUS=0
	</update>
	
		<!-- 增值税明细表 -->
	<select id="queryValueAddBusinessTax" parameterClass="map" resultClass="java.util.HashMap">
			 <!-- 城建税、教育税 先乘后取整 -->
			<![CDATA[			
			select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,REN_PRICE,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE)) YYshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FBuildTax)) CJshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FEduAmount)) JYshuie,
			convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE)) + convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FBuildTax)) + convert(decimal(18,2),convert(decimal(18,2),REN_PRICE) * convert(decimal(18,2),SALES_TAX_RATE_ALONE) * convert(decimal(18,2),FEduAmount)) xiaoji   
			from( 
			select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,SUM(REN_PRICE) REN_PRICE,
			 (	SELECT MAX(T.RATE_VALUE) / 100 SALES_TAX_RATE_ALONE FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'SALES_TAX_RATE_ALONE' and T.TAX_PLAN_CODE='2'
					)  SALES_TAX_RATE_ALONE,
					(	SELECT MAX(T.RATE_VALUE) / 100 FBuildTax FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >=CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FBuildTax' and T.TAX_PLAN_CODE='2'
					) FBuildTax,
					(	SELECT MAX(T.RATE_VALUE) / 100 FEduAmount FROM T_RATE_CONFIG T 
						WHERE T.STATUS = 0 
								AND CONVERT(VARCHAR(10),T.START_DATE,23) <= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND CONVERT(VARCHAR(10),T.END_DATE,23) >= CONVERT(VARCHAR(10),MAX(FINANCECONTRACT_DATE),23)
								AND T.FILED_NAME = 'FEduAmount' and T.TAX_PLAN_CODE='2'
					) FEduAmount	
			from(
				select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,DECP_NAME_CN,NAME,SUPL_NAME,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
				0 CAI,SUM(ttt.RENT_PRICE) REN_PRICE,MAX(QI_DATE) QI_DATE,MAX(FINANCECONTRACT_DATE) FINANCECONTRACT_DATE
				from
					(select trcp.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,
					tdc.DECP_NAME_CN,tuser.NAME,T9.NAME SUPL_NAME,
					0 CAI,trid.RENT_PRICE		
					,dateadd(month,-1,trid.create_time) QI_DATE,
					T10.FINANCECONTRACT_DATE
			  from T_RENT_INVOICEDETAIL  trid 
					left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trid.RECP_ID AND trcp.STATUS = 0 
					left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
					left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
					LEFT JOIN T_USER_USER tuser on tuser.ID = trc.SENSOR_ID
					LEFT JOIN (SELECT RECP_ID,MAX(EQMT_ID) EQMT_ID FROM T_RENT_CONTRACTDETAIL WHERE STATUS = 0 GROUP BY RECP_ID) T6 ON T6.RECP_ID = trcp.RECP_ID
					LEFT JOIN T_EQMT_EQUIPMENT T7 ON T7.EQMT_ID = T6.EQMT_ID AND T7.STATUS = 0
					LEFT JOIN T_SUPL_EQUIPMENT T8 ON T7.SUEQ_ID = T8.SUEQ_ID AND T8.STATUS = 0
					LEFT JOIN T_SUPL_SUPPLIER T9 ON T9.ID = T8.SUPPLIER_ID AND T9.STATUS = 0
					LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
					left join T_DEPT_DEPARTMENT dept on dept.ID = tuser.DEPT_ID and dept.STATUS = 0
      	  			left join T_DEPT_COMPANY tdc on dept.DECP_ID = tdc.DECP_ID and tdc.STATUS = 0
      	  			LEFT JOIN T_REPORT_DATE TRD ON  TRID.CREATE_TIME  BETWEEN TRD.BEGINTIME AND TRD.ENDTIME
					WHERE	
						trid.state='2' and (trcp.TAX_PLAN_CODE='2' or trcp.TAX_PLAN_CODE='3'or trcp.TAX_PLAN_CODE='4')
						AND YEAR(DATEADD(MONTH,-1,TRD.ENDTIME ))=YEAR(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))
						AND MONTH(DATEADD(MONTH,-1,TRD.ENDTIME))=MONTH(CONVERT(DATE,CONVERT(VARCHAR,#startDate#, 23)))						
						]]>
						
						<isNotEmpty prepend="and" property="companyCode">
							T10.company_code = #companyCode#
						</isNotEmpty>
						
						<![CDATA[
					) ttt
							
			   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME
		)TTT
		group by RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
					ttt.DECP_NAME_CN,ttt.NAME,	
					YEAR(ttt.QI_DATE),
					MONTH(ttt.QI_DATE),ttt.SUPL_NAME 
		)TTTT
			]]>			 
			<dynamic prepend="where">
			<isNotEmpty prepend="and" property="content">
		 			<![CDATA[
					( CUST_NAME like '%$content$%'
					OR DECP_NAME_CN like '%$content$%'
					OR LEASE_CODE like '%$content$%'
					OR NAME like '%$content$%'
					OR SUPL_NAME LIKE '%$content$%'
					 )  
					]]>
			</isNotEmpty> 
			</dynamic>                                 			                                                                                		                                                                                                                                         	
	</select>

	<!-- Add by Michael 2013 4-3增加销账月报表  -->
	<select id="queryMonthDecomposeReport" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
	    	select t.* 
			from MONTH_DECOMPOSE_REPORT t
		    left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = t.RECP_ID and trcp.STATUS = 0
		    left join T_RENT_CONTRACT c on c.rect_id = trcp.rect_id and c.status = 0
			left join t_prjt_credit tpc on tpc.id = c.prcd_id and tpc.status = 0
			where 1=1
			and year(t.FINANCE_DATE)=YEAR(#startDate#) and month(t.FINANCE_DATE)=month(#startDate#)
		]]>
		<isNotEmpty prepend="and" property="companyCode">
			tpc.company_code = #companyCode#
		</isNotEmpty>
		<isNotEmpty prepend="and" property="content">
 			<![CDATA[
				( t.CUST_NAME like '%$content$%'
				OR t.LEASE_CODE like '%$content$%'
				OR t.BANK_NAME like '%$content$%'
				OR t.FICB_ITEM like '%$content$%'
				 )  
			]]>
		</isNotEmpty> 
	</select>
	
		<!-- Add by Michael 2012 4-5增加留购款、罚息增值税联系人  -->
	<select id="queryStayBuyPriceValueAddTaxLinkInfo" parameterClass="map" resultClass="java.util.HashMap">
		<!-- select distinct tcc.CUST_NAME,trc.LEASE_CODE,tcl.LINK_NAME,tcl.LINK_EMAIL,tcl.LINK_WORK_ADDRESS,tcl.LINK_MOBILE,
		tcl.LINK_PHONE,tsp.express,tsp.express_pay_way,DECP.DECP_NAME_CN
		 from 
		MONTH_DECOMPOSE_REPORT t1 	
		left join T_FINA_INCOME t2 on t1.FIIN_ID=t2.FIIN_ID
		left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
		left join t_prjt_credit tpc on tpc.id = trc.prcd_id and tpc.status =0
		left join t_user_user tuu2 on tuu2.id = tpc.sensor_id
		left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0  
		left join T_SUPL_PLAYDETIL tsp on tpc.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		left join T_CUST_LINKMAN tcl on tcl.CUST_ID=tcc.CUST_ID and tcl.STATUS=0 and tcl.LINK_TYPE=0
		where (t1.FICB_ITEM = '结清留购价' or t1.FICB_ITEM = '设备留购价' or t1.FICB_ITEM = '租金罚息' or t1.FICB_ITEM='结清罚息' )
		and t3.TAX_PLAN_CODE='2'
		and year(t1.FINANCE_DATE)=YEAR(#startDate#) and month(t1.FINANCE_DATE)=month(#startDate#) -->
		select distinct tcc.CUST_NAME,trc.LEASE_CODE,tcl.LINK_NAME,tcl.LINK_EMAIL,tcl.LINK_WORK_ADDRESS,tcl.LINK_MOBILE,
		tcl.LINK_PHONE,tsp.express,tsp.express_pay_way,DECP.DECP_NAME_CN
		 from 
		T_DECOMPOSE_DAILY_REPORT t1 	
		left join T_RENT_INCOME t2 on t1.INCOME_ID=t2.INCOME_ID
		left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
		left join t_prjt_credit tpc on tpc.id = trc.prcd_id and tpc.status =0
		left join t_user_user tuu2 on tuu2.id = tpc.sensor_id
		left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
		LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0  
		left join T_SUPL_PLAYDETIL tsp on tpc.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		left join T_CUST_LINKMAN tcl on tcl.CUST_ID=tcc.CUST_ID and tcl.STATUS=0 and tcl.LINK_TYPE=0
		where (t1.BILL_CODE = 'SETTLEMENT_STAY_PRICE' or t1.BILL_CODE = 'STAY_BUY_PRICE' or t1.BILL_CODE = 'RENT_FINE' or t1.BILL_CODE='SETTLEMENT_RENT_FINE')
		and t3.TAX_PLAN_CODE='2'
		and t1.FINANCE_DATE=#FINANCE_DATE#
		<isNotEmpty prepend="and" property="companyCode">
			tpc.company_code = #companyCode#
		</isNotEmpty>
	</select>	
	
	<select id="queryStayBuyPriceTaxLinkInfo" parameterClass="map" resultClass="java.util.HashMap">
		<!-- select distinct tcc.CUST_NAME,trc.LEASE_CODE,tcl.LINK_NAME,tcl.LINK_EMAIL,tcl.LINK_WORK_ADDRESS,tcl.LINK_MOBILE,tcl.LINK_PHONE
		 from 
		MONTH_DECOMPOSE_REPORT t1 	
		left join T_FINA_INCOME t2 on t1.FIIN_ID=t2.FIIN_ID
		left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		left join T_CUST_LINKMAN tcl on tcl.CUST_ID=tcc.CUST_ID and tcl.STATUS=0 and tcl.LINK_TYPE=0
		where (t1.FICB_ITEM = '结清留购价' or t1.FICB_ITEM = '设备留购价' or t1.FICB_ITEM = '租金罚息' or t1.FICB_ITEM='结清罚息' )
		and t3.TAX_PLAN_CODE='1'
		and year(t1.FINANCE_DATE)=YEAR(#startDate#) and month(t1.FINANCE_DATE)=month(#startDate#) -->
		select distinct tcc.CUST_NAME,trc.LEASE_CODE,tcl.LINK_NAME,tcl.LINK_EMAIL,tcl.LINK_WORK_ADDRESS,tcl.LINK_MOBILE,tcl.LINK_PHONE
		 from 
		T_DECOMPOSE_DAILY_REPORT t1 	
		left join T_RENT_INCOME t2 on t1.INCOME_ID = t2.INCOME_ID 
		left join T_RENT_COLLECTIONPLAN t3 on t1.RECP_ID=t3.RECP_ID and t3.STATUS=0
		left join T_RENT_CONTRACT trc on trc.RECT_ID = t3.RECT_ID AND trc.STATUS = 0
		left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
		left join T_CUST_LINKMAN tcl on tcl.CUST_ID=tcc.CUST_ID and tcl.STATUS=0 and tcl.LINK_TYPE=0
		where (t1.BILL_CODE = 'STAY_BUY_PRICE' or t1.BILL_CODE = 'RENT_FINE' or t1.BILL_CODE = 'SETTLEMENT_RENT_FINE' or t1.BILL_CODE='SETTLEMENT_STAY_PRICE')
		and t3.TAX_PLAN_CODE='1'
		and t1.FINANCE_DATE=#FINANCE_DATE#
	</select>		
	
	<select id="getDateList" resultClass="java.util.HashMap">
		SELECT CONVERT(VARCHAR,[YEAR])+'-'+CONVERT(VARCHAR,[MONTH]) CODE,
			   CONVERT(VARCHAR,[YEAR])+'-'+CONVERT(VARCHAR,[MONTH])+
			   '  ('+CONVERT(VARCHAR,MONTH(BEGINTIME))+'-'+CONVERT(VARCHAR,DAY(BEGINTIME))
			   +'~'+CONVERT(VARCHAR,MONTH(ENDTIME))+'-'+CONVERT(VARCHAR,DAY(ENDTIME))+')' DESCR,
			   CONVERT(DATE,BEGINTIME) STARTDATE,CONVERT(DATE,ENDTIME) ENDDATE
	      FROM T_REPORT_DATE 
	     WHERE STATUS=0
	       AND ([YEAR]&lt;(SELECT YEAR <!-- 拿当前日期之前年的 -->
	                     FROM T_REPORT_DATE 
	                    WHERE CONVERT(DATE,GETDATE()) BETWEEN CONVERT(DATE,BEGINTIME) AND CONVERT(DATE,ENDTIME))
	            OR  ([YEAR]=(SELECT YEAR <!-- 拿当前日期当前年之前月的 -->
	                          FROM T_REPORT_DATE 
	                         WHERE CONVERT(DATE,GETDATE()) BETWEEN CONVERT(DATE,BEGINTIME) AND CONVERT(DATE,ENDTIME)) AND
	                 [MONTH]&lt;=(SELECT MONTH 
	                            FROM T_REPORT_DATE 
	                           WHERE CONVERT(DATE,GETDATE()) BETWEEN CONVERT(DATE,BEGINTIME) AND CONVERT(DATE,ENDTIME))   
	                 )       
	           )                    
	  ORDER BY [YEAR] DESC,[MONTH] DESC
	</select>	
	
	<select id="queryInvoice" resultClass="java.util.HashMap">
	<!-- SQL总共分成3块
		 导出开票资料新案的必要条件是拨款日期在结账区间内
		 
		 如果起租日小于结账区间开始日期
		 第一,二块拿第一,二期开票资料
		 
		 如果起租日大于等于结账区间开始日期
		 第三块拿第一期开票资料
	 -->
	 SELECT O.* FROM
			 (	
			 	<!-- 第一块 -->
			      SELECT TRCL.RECD_ID,TRCL.RECP_ID,CONVERT(DATE,TPC.FINANCECONTRACT_DATE) FINANCECONTRACT_DATE,
			             TPCP.REGISTERED_OFFICE_ADDRESS+'  '+CONVERT(VARCHAR,TPCP.TELEPHONE) LINK_ADDRESS,
			             TCC.CORP_TAX_CODE,
			             TPCT.BANK_NAME+TPCT.BANK_ACCOUNT BANK_NAME,
			             TCC.CUST_NAME,
			             '' PRODUCT_NAME,
			             '' PRODUCT_KIND,'' UNIT,1 NUMBER,'' UNIT_PRICE,0.17 TAX_RATE,
			             TRCL.OWN_PRICE,
			             (SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=TRCL.RECP_ID) PLEDGE_PRICE,
			             TRCL.REN_PRICE,
			             TRCT.LEASE_CODE,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) RUNNUM,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) REMARK1,
						 tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE,
			             TRCN.RECP_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) ONEBARCODE,DECP.DECP_NAME_CN
			             ,(case when   REDUCE_OWN_PRICE = IRR_MONTH_PRICE then '已缴款' else '未缴款'  end) isPay,tsp.express,tsp.express_pay_way
			        FROM T_RENT_COLLECTIONDETAIL TRCL
			   LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.RECP_ID=TRCL.RECP_ID AND TRCN.STATUS=0 AND TRCN.INVOICE_STATUS=0
			   LEFT JOIN T_RENT_CONTRACT TRCT ON TRCT.RECT_ID=TRCN.RECT_ID AND TRCT.STATUS=0
			   LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.CUST_ID=TRCT.CUST_ID AND TCC.STATUS=0 <!-- 拿税务登记号,客户名称 -->
			   LEFT JOIN T_PRJT_CREDIT TPC ON TPC.ID=TRCT.PRCD_ID AND TPC.STATUS=0
			   left join T_SUPL_PLAYDETIL tsp ON TPC.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
			   LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPC.ID=TPCT.CREDIT_ID AND TPCT.STATUS=0 AND TPCT.STATE='0' <!-- 拿银行帐号 -->
			   LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCP ON TPCP.CREDIT_ID=TPC.ID AND TPCP.STATUS=0 <!-- 拿开票地址 -->
			   left join T_CUST_LINKMAN tcl on tcl.cust_id = TCC.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0 <!-- 客户邮寄信息 -->
			   left join t_user_user tuu2 on tuu2.id = TPC.sensor_id
			   left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
			   LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0   		      
			       WHERE TRCL.STATUS=0
			        <isNotEmpty prepend="and" property="companyCode">
						TPC.company_code = #companyCode#
					</isNotEmpty>
			       	<isEqual property="isPay" compareValue="0">
			         AND TRCL.ISOPEN IS NULL
			         </isEqual>
			         AND TRCN.TAX_PLAN_CODE=#invoiceType#
			         AND CONVERT(DATE,TRCL.FINANCE_DATE)&lt;CONVERT(DATE,#startDate#) <!--如果起租日小于结账区间开始日期 需要开第1,2期发票,这里是第1期-->
			         AND TRCL.PERIOD_NUM=1
			         AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#financeStartDate#) AND CONVERT(DATE,#financeEndDate#)
		         <isNotEmpty property="content">
		         	 AND (TRCT.LEASE_CODE LIKE '%$content$%' OR
		         	 		TCC.CUST_NAME LIKE '%$content$%')
		         </isNotEmpty>
			         UNION
			      SELECT TRCL.RECD_ID,TRCL.RECP_ID,CONVERT(DATE,TPC.FINANCECONTRACT_DATE) FINANCECONTRACT_DATE,
			             TPCP.REGISTERED_OFFICE_ADDRESS+'  '+CONVERT(VARCHAR,TPCP.TELEPHONE) LINK_ADDRESS,
			             TCC.CORP_TAX_CODE,
			             TPCT.BANK_NAME+TPCT.BANK_ACCOUNT BANK_NAME,
			             TCC.CUST_NAME,
			             '' PRODUCT_NAME,
			             '' PRODUCT_KIND,'' UNIT,1 NUMBER,'' UNIT_PRICE,0.17 TAX_RATE,
			             TRCL.OWN_PRICE,
			             0 PLEDGE_PRICE,
			             TRCL.REN_PRICE,
			             TRCT.LEASE_CODE,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) RUNNUM,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) REMARK1,
			             tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE,
						  TRCN.RECP_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) ONEBARCODE,DECP.DECP_NAME_CN
						 ,(case when   REDUCE_OWN_PRICE = IRR_MONTH_PRICE then '已缴款' else '未缴款'  end) isPay,tsp.express,tsp.express_pay_way
			        FROM T_RENT_COLLECTIONDETAIL TRCL
			   LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.RECP_ID=TRCL.RECP_ID AND TRCN.STATUS=0 AND TRCN.INVOICE_STATUS=0
			   LEFT JOIN T_RENT_CONTRACT TRCT ON TRCT.RECT_ID=TRCN.RECT_ID AND TRCT.STATUS=0
			   LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.CUST_ID=TRCT.CUST_ID AND TCC.STATUS=0 <!-- 拿税务登记号,客户名称 -->
			   LEFT JOIN T_PRJT_CREDIT TPC ON TPC.ID=TRCT.PRCD_ID AND TPC.STATUS=0
			   left join T_SUPL_PLAYDETIL tsp ON TPC.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
			   LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPC.ID=TPCT.CREDIT_ID AND TPCT.STATUS=0 AND TPCT.STATE='0' <!-- 拿银行帐号 -->
			   LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCP ON TPCP.CREDIT_ID=TPC.ID AND TPCP.STATUS=0 <!-- 拿开票地址 -->
			   left join T_CUST_LINKMAN tcl on tcl.cust_id = TCC.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0 <!-- 客户邮寄信息 -->			      
			   left join t_user_user tuu2 on tuu2.id = TPC.sensor_id
			   left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
			   LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0   
			       WHERE TRCL.STATUS=0
			       	<isNotEmpty prepend="and" property="companyCode">
						TPC.company_code = #companyCode#
					</isNotEmpty>
			         AND TRCL.PERIOD_NUM=2     
			         AND EXISTS ( SELECT 1 
				              		FROM T_RENT_COLLECTIONDETAIL TRCL1
							   LEFT JOIN T_RENT_COLLECTIONPLAN TRCN1 ON TRCN1.RECP_ID=TRCL1.RECP_ID AND TRCN1.STATUS=0 AND TRCN1.INVOICE_STATUS=0
					           LEFT JOIN T_RENT_CONTRACT TRCT1 ON TRCT1.RECT_ID=TRCN1.RECT_ID AND TRCT1.STATUS=0
					           LEFT JOIN T_CUST_CUSTOMER TCC1 ON TCC1.CUST_ID=TRCT1.CUST_ID AND TCC1.STATUS=0
					           LEFT JOIN T_PRJT_CREDIT TPC1 ON TPC1.ID=TRCT1.PRCD_ID AND TPC1.STATUS=0
				         		   WHERE TRCL1.STATUS=0
							        <isEqual property="isPay" compareValue="0">
			        					 AND TRCL.ISOPEN IS NULL
			        			    </isEqual>
							         AND TRCN1.TAX_PLAN_CODE=#invoiceType#
							         AND CONVERT(DATE,TRCL1.FINANCE_DATE)&lt;CONVERT(DATE,#startDate#) <!--如果起租日小于结账区间开始日期 需要开第1,2期发票,这里是第2期-->
							         AND TRCL1.PERIOD_NUM=1
							         AND CONVERT(DATE,TPC1.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#financeStartDate#) AND CONVERT(DATE,#financeEndDate#)
							         AND TRCL.RECP_ID=TRCL1.RECP_ID
						         <isNotEmpty property="content">
						         	 AND (TRCT1.LEASE_CODE LIKE '%$content$%' OR
						         	 		TCC1.CUST_NAME LIKE '%$content$%')
						         </isNotEmpty>
						         )
			   <!-- 第三块 -->
			         UNION
			      SELECT TRCL.RECD_ID,TRCL.RECP_ID,CONVERT(DATE,TPC.FINANCECONTRACT_DATE) FINANCECONTRACT_DATE,
			             TPCP.REGISTERED_OFFICE_ADDRESS+'  '+CONVERT(VARCHAR,TPCP.TELEPHONE) LINK_ADDRESS,
			             TCC.CORP_TAX_CODE,
			             TPCT.BANK_NAME+TPCT.BANK_ACCOUNT BANK_NAME,
			             TCC.CUST_NAME,
			             '' PRODUCT_NAME,
			             '' PRODUCT_KIND,'' UNIT,1 NUMBER,'' UNIT_PRICE,0.17 TAX_RATE,
			             TRCL.OWN_PRICE,
			             (SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=TRCL.RECP_ID) PLEDGE_PRICE,
			             TRCL.REN_PRICE,
			             TRCT.LEASE_CODE,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) RUNNUM,
			             TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) REMARK1,
			             tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE,
			             TRCN.RECP_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) ONEBARCODE,DECP.DECP_NAME_CN			             
						 ,(case when   REDUCE_OWN_PRICE = IRR_MONTH_PRICE then '已缴款' else '未缴款'  end) isPay,tsp.express,tsp.express_pay_way
			        FROM T_RENT_COLLECTIONDETAIL TRCL
			   LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.RECP_ID=TRCL.RECP_ID AND TRCN.STATUS=0 AND TRCN.INVOICE_STATUS=0
			   LEFT JOIN T_RENT_CONTRACT TRCT ON TRCT.RECT_ID=TRCN.RECT_ID AND TRCT.STATUS=0
			   LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.CUST_ID=TRCT.CUST_ID AND TCC.STATUS=0
			   LEFT JOIN T_PRJT_CREDIT TPC ON TPC.ID=TRCT.PRCD_ID AND TPC.STATUS=0
			   left join T_SUPL_PLAYDETIL tsp ON TPC.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
			   LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPC.ID=TPCT.CREDIT_ID AND TPCT.STATUS=0 AND TPCT.STATE='0'
			   LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCP ON TPCP.CREDIT_ID=TPC.ID AND TPCP.STATUS=0
			   left join T_CUST_LINKMAN tcl on tcl.cust_id = TCC.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0 <!-- 客户邮寄信息 -->			    
			   left join t_user_user tuu2 on tuu2.id = TPC.sensor_id
			   left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
			   LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0      
			       WHERE TRCL.STATUS=0
			       	<isNotEmpty prepend="and" property="companyCode">
						TPC.company_code = #companyCode#
					</isNotEmpty>
			          <isEqual property="isPay" compareValue="0">
			         	AND TRCL.ISOPEN IS NULL
			         </isEqual>
			         AND TRCN.TAX_PLAN_CODE=#invoiceType#
			         AND CONVERT(DATE,TRCL.FINANCE_DATE)>=CONVERT(DATE,#startDate#) <!--如果起租日大于等于结账区间开始日期 需要开第1期发票,这里是第1期-->
			         AND TRCL.PERIOD_NUM=1
			         AND CONVERT(DATE,TPC.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#financeStartDate#) AND CONVERT(DATE,#financeEndDate#)
			      <isNotEmpty property="content">
		         	 AND (TRCT.LEASE_CODE LIKE '%$content$%' OR
		         	 		TCC.CUST_NAME LIKE '%$content$%')
		          </isNotEmpty>
			 ) O
			 <isEqual property="needOrderBy" compareValue="Y">
			 	ORDER BY O.FINANCECONTRACT_DATE,O.RECP_ID
			 </isEqual>
	</select>	
	<select id="getDecomposeDateMapByRecpId" parameterClass="map" resultClass="java.util.HashMap">
		select convert(varchar,max(DECOMPOSE_DATE), 23) DECOMPOSE_DATE from T_FINA_COLLECTIONBILL
		where  RECP_ID=#RECP_ID# and RECD_PERIOD =#PERIOD_NUM# and FICB_ITEM='租金' and STATUS=0 and FICB_type='0'
	</select>
	
	<select id="exportIsPayByMonth" parameterClass="map" resultClass="java.util.HashMap">
		<![CDATA[
		select RECD_ID,RECP_ID,RUNNUM,ONEBARCODE,LINK_WORK_ADDRESS+'  '+convert(varchar,LINK_PHONE) LINK_ADDRESS,CORP_TAX_CODE,BANK_NAME+BANK_ACCOUNT BANK_NAME,CUST_NAME,'租赁费' As PRODUCT_NAME,'' As PRODUCT_KIND,''AS UNIT,1 AS NUMBER,'' As UNIT_PRICE,REN_PRICE,0.17 As TAX_RATE,RUNNUM AS REMARK1,'' As REMARK2 
		,#taxPlanCode# TAX_PLAN_CODE,
		OWN_PRICE,CASE WHEN SUBSTRING(RUNNUM,LEN(RUNNUM),LEN(RUNNUM))=1 THEN 
					(SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=tttt.RECP_ID)
					ELSE 0 END PLEDGE_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,DECP_NAME_CN,TTTT.PAY_DATE,TTTT.isPay,TTTT.PERIOD_NUM
		from(
	select * from (
	select t2.*,DECP.DECP_NAME_CN
	from t_prjt_credit t1
	left join t_user_user tuu2 on tuu2.id = t1.sensor_id
	left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0
	left join
	(select RECP_ID,RECP_CODE,CUST_NAME,LEASE_CODE,YEAR(QI_DATE) Y,MONTH(QI_DATE) M,
		0 CAI,SUM(ttt.REN_PRICE) REN_PRICE,month_price,MAX(QI_DATE) QI_DATE,RECD_ID,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,PERIOD_NUM,LEASE_CODE+'-'+convert(varchar,PERIOD_NUM) RUNNUM,RECP_CODE+'-'+CONVERT(VARCHAR,PERIOD_NUM) ONEBARCODE,CORP_TAX_CODE
		,SUM(ttt.OWN_PRICE) OWN_PRICE,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.PAY_DATE,ttt.isPay
		from
			(select trcd.RECP_ID,trcp.RECP_CODE,tcc.CUST_NAME,trc.LEASE_CODE,TT.PAY_DATE,
			trcd.PERIOD_NUM,
			0 CAI,
			trcd.REN_PRICE
			,MONTH_PRICE,
			trcd.finance_date QI_DATE,		
			T10.FINANCECONTRACT_DATE,trcd.RECD_ID,tpcb.BANK_ACCOUNT,tpcb.BANK_NAME,tpcc.REGISTERED_OFFICE_ADDRESS LINK_WORK_ADDRESS,
			tpcc.TELEPHONE LINK_PHONE,tcc.CORP_TAX_CODE,trcd.OWN_PRICE,
			tcl.LINK_NAME,tcl.LINK_MOBILE,tcl.LINK_WORK_ADDRESS as lw_address,tcl.LINK_EMAIL,tcl.LINK_PHONE AS LPHONE
			  ,(case when   trcd.REDUCE_OWN_PRICE = trcd.IRR_MONTH_PRICE then 1 else  	0  end) isPay
		  	from T_RENT_COLLECTIONDETAIL trcd
			left join T_RENT_COLLECTIONPLAN trcp on trcp.RECP_ID = trcd.RECP_ID AND trcp.STATUS = 0 and trcp.INVOICE_STATUS=0
			left join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECT_ID AND trc.STATUS = 0
			left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID AND tcc.STATUS = 0
			LEFT JOIN T_PRJT_CREDIT T10 ON T10.ID = trc.PRCD_ID AND T10.STATUS = 0
			left join t_prjt_creditcorpbankaccount tpcb  on t10.ID=tpcb.CREDIT_ID and tpcb.status=0 and tpcb.state='0'
			left join T_PRJT_CREDITCUSTOMERCORP tpcc on tpcc.credit_id=t10.id and tpcc.status=0
			left join T_CUST_LINKMAN tcl on tcl.cust_id = trc.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0
			LEFT JOIN T_SUPL_PLAYDETIL TT ON TT.STATUS=0 AND TT.PAY_ORDER=1 AND TT.CREDIT_ID=trc.PRCD_ID
						WHERE	
							trcd.STATUS = 0  
							]]>
							 <isNotEmpty prepend="and" property="companyCode">
								T10.company_code = #companyCode#
							</isNotEmpty>
							<![CDATA[
							 and (trcp.TAX_PLAN_CODE=#taxPlanCode#)
							) ttt
			where 1=1 	
			and (YEAR(QI_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
								( 	YEAR(QI_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
									AND MONTH(QI_DATE) <= MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))				
	   group by ttt.RECP_ID,ttt.recp_code,ttt.CUST_NAME,ttt.LEASE_CODE,
			ttt.PERIOD_NUM,BANK_ACCOUNT,BANK_NAME,LINK_WORK_ADDRESS,LINK_PHONE,	CORP_TAX_CODE,	
			YEAR(ttt.QI_DATE),
			MONTH(ttt.QI_DATE),MONTH_PRICE,ttt.RECD_ID,LINK_NAME,LINK_MOBILE,lw_address,LINK_EMAIL,LPHONE,ttt.PAY_DATE,ttt.isPay
	) t2
	on	t1.lease_code=t2.LEASE_CODE 
	where t1.STATUS=0 and 
	(year(t1.FINANCECONTRACT_DATE) < YEAR(convert(DATE,convert(varchar,#startDate#, 23)))							OR
	( 	year(t1.FINANCECONTRACT_DATE) = YEAR(convert(DATE,convert(varchar,#startDate#, 23)))
		AND month(t1.FINANCECONTRACT_DATE) < MONTH(convert(DATE,convert(varchar,#startDate#, 23))) ))
	)ttt
	where ttt.Y=year(#startDate#)	and ttt.M=MONTH(#startDate#)
) TTTT
where REN_PRICE >0
		]]>
		<isNotEmpty property="orderColumn">
		order by $orderColumn$
		</isNotEmpty>
	</select>	
	
	<!-- 跑job 已核未拨和缓拨 -->
	<!-- add by xuyuefei 2014 5/23 -->
	<insert id="addLog">
	insert into T_UNALLOTANDDELAYALLOT_JOBTO 
	values(#id#,#creditCount#,#delayAllotCount#,#delayAllotPay#,#unAllotCount#,#unAllotPay#,getDate())
	</insert>
	
	<select id="getDayChart" resultClass="com.brick.report.to.UnAllotAndDelayAllotChartTo">
	  select 
	  DELAYALLOT_COUNT delayAllotCount,
	  DELAYALLOT_PAY AS delayAllot_pay,
	  UNDELAYALLOT_COUNT unAllotCount,
	  UNDELAYALLOT_PAY AS unAllot_pay
	  FROM T_UNALLOTANDDELAYALLOT_JOBTO
	  WHERE CONVERT(DATE,CREATE_TIME) BETWEEN convert(date,#begin#) AND convert(date,#end#)
	  ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<select id="getDayCondition" resultClass="java.lang.String">
	 select distinct convert(date,create_time)
     from T_UNALLOTANDDELAYALLOT_JOBTO
     WHERE CONVERT(DATE,CREATE_TIME) between convert(date,#begin#) AND convert(date,#end#)
     ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<select id="getMonthCondition" resultClass="java.lang.String">
	 select distinct convert(date,create_time)
     from T_UNALLOTANDDELAYALLOT_JOBTO
     WHERE CONVERT(DATE,CREATE_TIME) in 
     
     <iterate conjunction="," open="(" close=")" property="monthList">
     (convert(date,#monthList[]#))
     </iterate>
     
     ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<select id="getMonthChart" resultClass="com.brick.report.to.UnAllotAndDelayAllotChartTo">
	  select 
	  DELAYALLOT_COUNT delayAllotCount,
	  DELAYALLOT_PAY AS delayAllot_pay,
	  UNDELAYALLOT_COUNT unAllotCount,
	  UNDELAYALLOT_PAY AS unAllot_pay
	  FROM T_UNALLOTANDDELAYALLOT_JOBTO
	  WHERE CONVERT(DATE,CREATE_TIME) in 
	  
     <iterate conjunction="," open="(" close=")" property="monthList">
        (convert(date,#monthList[]#))
     </iterate>
     
	  ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<select id="getWeekCondition" resultClass="java.lang.String">
	 select distinct convert(date,create_time)
     from T_UNALLOTANDDELAYALLOT_JOBTO
     WHERE CONVERT(DATE,CREATE_TIME) in 
     
     <iterate conjunction="," open="(" close=")" property="weekList">
     (convert(date,#weekList[]#))
     </iterate>
     
     ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<select id="getWeekChart" resultClass="com.brick.report.to.UnAllotAndDelayAllotChartTo">
	  select 
	  DELAYALLOT_COUNT delayAllotCount,
	  DELAYALLOT_PAY AS delayAllot_pay,
	  UNDELAYALLOT_COUNT unAllotCount,
	  UNDELAYALLOT_PAY AS unAllot_pay
	  FROM T_UNALLOTANDDELAYALLOT_JOBTO
	  WHERE CONVERT(DATE,CREATE_TIME) in 
	  
     <iterate conjunction="," open="(" close=")" property="weekList">
        (convert(date,#weekList[]#))
     </iterate>
     
	  ORDER BY CONVERT(DATE,CREATE_TIME)
	</select>
	
	<!-- add by xuyuefei 2014/6/12 -->
	<!-- 回租发票 资料 -->
	<select id="getInvoiceData" resultClass="java.util.HashMap">
	select 
	TRCL.RECD_ID,
	TRCL.RECP_ID,
	CONVERT(DATE,TPC.FINANCECONTRACT_DATE) FINANCECONTRACT_DATE,
	TPCP.REGISTERED_OFFICE_ADDRESS+'  '+CONVERT(VARCHAR,TPCP.TELEPHONE) LINK_ADDRESS,
	TCC.CORP_TAX_CODE,
	TPCT.BANK_NAME+TPCT.BANK_ACCOUNT BANK_NAME,
	TCC.CUST_NAME,
	'' PRODUCT_NAME,
	'' PRODUCT_KIND,
	'' UNIT,
	1 NUMBER,
	'' UNIT_PRICE,
	0.17 TAX_RATE,
	TRCL.OWN_PRICE,
	(SELECT T2.PLEDGE_AVE_PRICE FROM T_RENT_COLLECTIONPLAN T2 WHERE T2.STATUS=0 AND T2.RECP_ID=TRCL.RECP_ID) PLEDGE_PRICE,
	TRCL.REN_PRICE,
	TRCT.LEASE_CODE,
	TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) RUNNUM,
	TRCT.LEASE_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) REMARK1,
	tcl.LINK_NAME,
	tcl.LINK_MOBILE,
	tcl.LINK_WORK_ADDRESS as lw_address,
	tcl.LINK_EMAIL,
	tcl.LINK_PHONE AS LPHONE,
	TRCN.RECP_CODE+'-'+CONVERT(VARCHAR,TRCL.PERIOD_NUM) ONEBARCODE,
	DECP.DECP_NAME_CN,
	(case when   REDUCE_OWN_PRICE = IRR_MONTH_PRICE then '已缴款' else '未缴款'  end) isPay,
	tsp.express,
	TRCN.TAX_PLAN_CODE, 
	tsp.express_pay_way
	from T_RENT_COLLECTIONDETAIL trcl
	LEFT JOIN T_RENT_COLLECTIONPLAN TRCN ON TRCN.RECP_ID=TRCL.RECP_ID AND TRCN.STATUS=0 AND TRCN.INVOICE_STATUS=0
	LEFT JOIN T_RENT_CONTRACT TRCT ON TRCT.RECT_ID=TRCN.RECT_ID AND TRCT.STATUS=0
	LEFT JOIN T_CUST_CUSTOMER TCC ON TCC.CUST_ID=TRCT.CUST_ID AND TCC.STATUS=0 <!-- 拿税务登记号,客户名称 -->
	LEFT JOIN T_PRJT_CREDIT TPC ON TPC.ID=TRCT.PRCD_ID AND TPC.STATUS=0
	left join T_SUPL_PLAYDETIL tsp ON TPC.ID = tsp.credit_id and tsp.status =0 and tsp.pay_order =1
	LEFT JOIN T_PRJT_CREDITCORPBANKACCOUNT TPCT ON TPC.ID=TPCT.CREDIT_ID AND TPCT.STATUS=0 AND TPCT.STATE='0' <!-- 拿银行帐号 -->
	LEFT JOIN T_PRJT_CREDITCUSTOMERCORP TPCP ON TPCP.CREDIT_ID=TPC.ID AND TPCP.STATUS=0 <!-- 拿开票地址 -->
	left join T_CUST_LINKMAN tcl on tcl.cust_id = TCC.CUST_ID and tcl.STATUS =0  AND tcl.link_type=0 <!-- 客户邮寄信息 -->			      
	left join t_user_user tuu2 on tuu2.id = TPC.sensor_id
	left join T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND DECP.STATUS = 0   
	where trcl.STATUS=0
    AND TRCL.ISOPEN IS NULL 
	AND TRCN.TAX_PLAN_CODE IN (6,7,8)  
	            <!-- 税率方案为6，7，8表示售后回租 -->
	            
	<isNotEmpty prepend="and" property="companyCode">
	TPC.company_code = #companyCode#
	</isNotEmpty>
	<dynamic>
	<!-- creditNum为0表示旧案，为1表示 新案-->
	   <isEqual prepend="and" property="creditNum" compareValue="0">
	      (CONVERT(DATE,TPC.FINANCECONTRACT_DATE) &lt;CONVERT(DATE,#BEGIN#) or CONVERT(DATE,TPC.FINANCECONTRACT_DATE)&gt;CONVERT(DATE,#END#))
	      AND (CONVERT(DATE,trcl.PAY_DATE) BETWEEN CONVERT(DATE,#BEGIN1#) AND CONVERT(DATE,#END1#))
	      <!-- AND trcl.PERIOD_NUM!=1 -->
	   </isEqual>
	   <isEqual prepend="and" property="creditNum" compareValue="1">
	      (CONVERT(DATE,TPC.FINANCECONTRACT_DATE) BETWEEN CONVERT(DATE,#BEGIN#) AND CONVERT(DATE,#END#))
	      AND trcl.PERIOD_NUM=1
	      AND (CONVERT(DATE,trcl.PAY_DATE) BETWEEN CONVERT(DATE,#BEGIN1#) AND CONVERT(DATE,#END1#))
	   </isEqual>
	</dynamic>
	order by TRCL.RECP_ID
	</select>
	
	<!-- 增值税本金发票开具明细 -->
	<select id="queryWithVATDetail" resultClass="java.util.HashMap">
	select trcl.RECD_ID,
	tcc.CUST_NAME,
	trc.LEASE_CODE,
	DECP.DECP_NAME_CN ,
	trcl.OWN_PRICE,
	trcl.PAY_DATE,
	TRCp.TAX_PLAN_CODE,
	trcl.PERIOD_NUM
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	where (trcl.PAY_DATE between convert(date,#startDate#) and
	convert(date,#endDate#))
	and trcl.STATUS=0
	and prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
    AND TRCp.TAX_PLAN_CODE IN (6,7,8)
    order by trcl.RECD_ID
	</select>
	
	<select id="queryWithVATDetail_count" resultClass="int">
	select count(1) from
	(
	select trcl.RECD_ID,
	tcc.CUST_NAME,
	trc.LEASE_CODE,
	DECP.DECP_NAME_CN ,
	trcl.OWN_PRICE,
	trcl.PAY_DATE,
	TRCp.TAX_PLAN_CODE,
	trcl.PERIOD_NUM
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID = trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID = dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	where (trcl.PAY_DATE between convert(date,#startDate#) and
	convert(date,#endDate#))
	and trcl.STATUS=0
	and prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
	AND TRCp.TAX_PLAN_CODE IN (6,7,8)
	)k
	</select>
	
	<!-- add by xuyuefei 2014/6/26 -->
	<!-- 增值税抵减余额 明细 -->
	<select id="queryWithVATOffsetAmount" resultClass="java.util.HashMap">
	select trcl.RECD_ID,
	trcp.RECP_ID,
	trc.LEASE_TOPRIC,
	trcl.invoice_code,
	tcc.CUST_NAME,
	trc.LEASE_CODE,
	DECP.DECP_NAME_CN ,
	trcl.OWN_PRICE,
	trcl.PAY_DATE,
	TRCp.TAX_PLAN_CODE,
	trcl.PERIOD_NUM,
	tcc.CORP_TAX_CODE,
	trcl.LAST_PRICE
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp
	on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND
	TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID =
	trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on
	tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc
	ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on
	tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID
	= dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON
	DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	left join
	(
	select recd_id,last_price
	from T_RENT_COLLECTIONDETAIL
	where RECP_ID in (
	select
	trcp.RECP_ID
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp
	on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND
	TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID =
	trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on
	tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc
	ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on
	tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID
	= dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON
	DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	where (trcl.PAY_DATE
	between convert(date,#startDate#) and
	convert(date,#endDate#)) and
	trcl.STATUS=0
	AND prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
	AND TRCp.TAX_PLAN_CODE IN (6,7,8)
	)
	and (PAY_DATE between convert(date,#startDate#) and
	convert(date,#endDate#))
	)k
	on k.recd_id=trcl.RECD_ID
	where (trcl.PAY_DATE between
	convert(date,#startDate#) and
	convert(date,#endDate#)) and
	trcl.STATUS=0
	AND prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
	AND TRCp.TAX_PLAN_CODE IN (6,7,8)
	order by trcl.RECD_ID
	</select>
	
	<select id="queryWithVATOffsetAmount_count" resultClass="int">
	select count(1) from
	(
	select trcl.RECD_ID,
	trcp.RECP_ID,
	trc.LEASE_TOPRIC,
	tcc.CUST_NAME,
	trc.LEASE_CODE,
	DECP.DECP_NAME_CN ,
	trcl.OWN_PRICE,
	trcl.PAY_DATE,
	TRCp.TAX_PLAN_CODE,
	trcl.PERIOD_NUM,
	tcc.CORP_TAX_CODE,
	k.LAST_PRICE
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp
	on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND
	TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID =
	trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on
	tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc
	ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on
	tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID
	= dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON
	DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	left join
	(
	select recd_id,last_price
	from T_RENT_COLLECTIONDETAIL
	where RECP_ID in (
	select
	trcp.RECP_ID
	from T_RENT_COLLECTIONDETAIL trcl
	left join T_RENT_COLLECTIONPLAN trcp
	on trcl.RECP_ID = trcp.RECP_ID AND
	TRCP.STATUS=0 AND
	TRCp.INVOICE_STATUS=0
	LEFT join T_RENT_CONTRACT trc on trc.RECT_ID =
	trcp.RECt_ID and
	trc.status=0
	left join T_CUST_CUSTOMER tcc on
	tcc.CUST_ID = trc.CUST_ID and tcc.status=0
	left join T_PRJT_CREDIT prc
	ON prc.ID=TRC.PRCD_ID AND prc.STATUS=0
	left
	join t_user_user tuu2 on
	tuu2.id = prc.sensor_id
	left join
	T_DEPT_DEPARTMENT dept on tuu2.DEPT_ID
	= dept.ID and dept.STATUS = 0
	LEFT JOIN T_DEPT_COMPANY DECP ON
	DECP.DECP_ID = dept.DECP_ID AND
	DECP.STATUS = 0
	where (trcl.PAY_DATE
	between convert(date,#startDate#) and
	convert(date,#endDate#)) and
	trcl.STATUS=0
	AND prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
	AND TRCp.TAX_PLAN_CODE IN (6,7,8)
	)
	and (PAY_DATE between convert(date,#startDate#) and
	convert(date,#endDate#))
	)k
	on k.recd_id=trcl.RECD_ID
	where (trcl.PAY_DATE between
	convert(date,#startDate#) and
	convert(date,#endDate#)) and
	trcl.STATUS=0
	AND prc.FINANCECONTRACT_DATE is not null
	AND TRCL.ISOPEN=1
	AND TRCp.TAX_PLAN_CODE IN (6,7,8)
	)k
	</select>
	
	<!-- 抓取当月拨款案件的利息明细 -->
	<select id="getRentDetail" resultClass="java.util.HashMap">
	  select 
	  trcn.RECP_ID,
	  tcc.CUST_NAME,
	  trc.LEASE_CODE,
	  trcn.START_DATE,
	  tpc.FINANCECONTRACT_DATE,
	  trcn.LEASE_PERIOD,
	  trcl.PAY_DATE,
	  trcl.REN_PRICE,
	  trcn.TAX_PLAN_CODE,
	  tpc.PRODUCTION_TYPE
	  from T_RENT_COLLECTIONDETAIL trcl
      left join T_RENT_COLLECTIONPLAN trcn on trcl.recp_id=trcn.RECP_ID and trcn.STATUS = 0
      left join T_RENT_CONTRACT trc on trcn.rect_id=trc.RECT_ID and trc.STATUS = 0
      left join T_PRJT_CREDIT tpc on tpc.id=trc.PRCD_ID and trc.status=0
      left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = tpc.CUST_ID and tcc.STATUS = 0
      where trcl.STATUS=0
      and (convert(date,tpc.FINANCECONTRACT_DATE) between convert(date,#startDate#) and convert(date,#endDate#))
      and trcl.PERIOD_NUM=1
      and tpc.PRODUCTION_TYPE in(1,2,3)
      and trcn.TAX_PLAN_CODE!=5
	   <isNotEmpty prepend="and" property="companyCode">
	     tpc.company_code = #companyCode#
	   </isNotEmpty>
	</select>
	
	<select id="getRentDetail_count" resultClass="int">
	  select count(k.LEASE_CODE) from
	  ( 
	  select tcc.CUST_NAME,trc.LEASE_CODE,trcn.START_DATE,tpc.FINANCECONTRACT_DATE,trcn.LEASE_PERIOD,trcl.PAY_DATE,trcl.REN_PRICE,trcn.TAX_PLAN_CODE from T_RENT_COLLECTIONDETAIL trcl
      left join T_RENT_COLLECTIONPLAN trcn on trcl.recp_id=trcn.RECP_ID and trcn.STATUS = 0
      left join T_RENT_CONTRACT trc on trcn.rect_id=trc.RECT_ID and trc.STATUS = 0
      left join T_PRJT_CREDIT tpc on tpc.id=trc.PRCD_ID and trc.status=0
      left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = tpc.CUST_ID and tcc.STATUS = 0
      where trcl.STATUS=0
      and (convert(date,tpc.FINANCECONTRACT_DATE) between convert(date,#startDate#) and convert(date,#endDate#))
      and trcl.PERIOD_NUM=1
      and tpc.PRODUCTION_TYPE in(1,2,3)
      and trcn.TAX_PLAN_CODE!=5
	   <isNotEmpty prepend="and" property="companyCode">
	     tpc.company_code = #companyCode#
	   </isNotEmpty>
	   )k
	</select>
	
	<!-- 导出明细 -->
	<select id="exportDetail" resultClass="java.util.HashMap">
	  select 
	  trcn.RECP_ID,
	  tcc.CUST_NAME,
	  trc.LEASE_CODE,
	  trcn.START_DATE,
	  tpc.FINANCECONTRACT_DATE,
      trcl.PERIOD_NUM,
	  trcl.PAY_DATE,
	  trcl.REN_PRICE,
	  tpc.PRODUCTION_TYPE
	  from T_RENT_COLLECTIONDETAIL trcl
      left join T_RENT_COLLECTIONPLAN trcn on trcl.recp_id=trcn.RECP_ID and trcn.STATUS = 0
      left join T_RENT_CONTRACT trc on trcn.rect_id=trc.RECT_ID and trc.STATUS = 0
      left join T_PRJT_CREDIT tpc on tpc.id=trc.PRCD_ID and trc.status=0
      left join T_CUST_CUSTOMER tcc on tcc.CUST_ID = tpc.CUST_ID and tcc.STATUS = 0
      where trcl.STATUS=0
      and (convert(date,tpc.FINANCECONTRACT_DATE) between convert(date,#startDate#) and convert(date,#endDate#))
      and tpc.PRODUCTION_TYPE in(1,2,3)
      and trcn.TAX_PLAN_CODE!=5
	</select>
	
	<!-- 利息详情 -->
	<select id="showDetail" resultClass="java.util.HashMap">
	  select 
	  t1.recp_id,
	  trcn.TAX_PLAN_CODE,
	  convert(date,t1.PAY_DATE) PAY_DATE,
	  t1.PERIOD_NUM,
	  TPC.PRODUCTION_TYPE,
	  t1.REN_PRICE from T_RENT_COLLECTIONDETAIL  t1
      left join T_RENT_COLLECTIONPLAN trcn on trcn.RECP_ID=t1.RECP_ID 
      left join T_RENT_CONTRACT TRC ON TRC.RECT_ID=TRCN.RECT_ID
      left join T_PRJT_CREDIT TPC ON TPC.ID=TRC.PRCD_ID
      where t1.recp_id=#recp_id#
	</select>
</sqlMap>